{% extends 'front_base.html.twig' %}

{% block title %}Booking Display{% endblock %}

{% block content %}

	<!-- Title -->
	<div class="row">
		<div class="col-12 mb-3">
			<div class="d-flex justify-content-between align-items-center">
				<h1 class="h3 mb-2 mb-sm-0">Booking Data</h1>
				<a href="{{ path('all_sessions') }}" class="btn btn-primary mb-0">
					<i class="fas fa-calendar me-2"></i>View Sessions
				</a>
			</div>
		</div>
	</div>

	<!-- Counter boxes START -->
	<div class="row g-4 mb-4">
		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-warning bg-opacity-15 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ bookings|length }}</h2>
						<span class="mb-0 h6 fw-light">Total Bookings</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-warning text-white mb-0"><i class="fas fa-calendar-check fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-success bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ bookings|filter(b => b.status == 'pending')|length }}</h2>
						<span class="mb-0 h6 fw-light">Pending</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-success text-white mb-0"><i class="fas fa-clock fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-primary bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ bookings|filter(b => b.status == 'accepted')|length }}</h2>
						<span class="mb-0 h6 fw-light">Accepted</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-primary text-white mb-0"><i class="fas fa-check-circle fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-danger bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ bookings|filter(b => b.status == 'denied')|length }}</h2>
						<span class="mb-0 h6 fw-light">Denied</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-danger text-white mb-0"><i class="fas fa-times-circle fa-fw"></i></div>
				</div>
			</div>
		</div>
	</div>
	<!-- Counter boxes END -->

	<!-- Search and filter START -->
	<div class="card shadow mb-4">
		<div class="card-header bg-light border-bottom">
			<!-- Search and select START -->
			<div class="row g-3 align-items-center justify-content-between">
				<!-- Search bar -->
				<div class="col-md-4">
					<form method="GET" class="position-relative" onsubmit="return false;">
						<input class="form-control bg-body pe-5" type="search" name="search" placeholder="Search bookings..." aria-label="Search">
						<button type="button" class="bg-transparent px-2 py-0 position-absolute top-50 end-0 translate-middle-y border-0 text-primary-hover text-reset" onclick="performSearch()">
							<i class="fas fa-search fs-6"></i>
						</button>
					</form>
				</div>

				<!-- Status filter -->
				<div class="col-md-2">
					<select class="form-select" name="status" id="statusFilter">
						<option value="">All Status</option>
						<option value="pending">Pending</option>
						<option value="accepted">Accepted</option>
						<option value="denied">Denied</option>
					</select>
				</div>

				<!-- Sort filter -->
				<div class="col-md-2">
					<select class="form-select" name="sort" id="sortFilter">
						<option value="createdAt">Created Date</option>
						<option value="firstName">Name</option>
						<option value="userEmail">Email</option>
						<option value="status">Status</option>
					</select>
				</div>

				<!-- Sort order -->
				<div class="col-md-2">
					<select class="form-select" name="order" id="orderFilter">
						<option value="desc">Newest</option>
						<option value="asc">Oldest</option>
					</select>
				</div>
			</div>
			<!-- Search and select END -->
		</div>
	</div>
	<!-- Search and filter END -->

	<!-- Booking table START -->
	<div class="card bg-transparent border shadow">

		<!-- Card header START -->
		<div class="card-header bg-light border-bottom">
			<div class="d-flex justify-content-between align-items-center">
				<h5 class="mb-0">Booking List</h5>
				<span class="badge bg-primary">{{ bookings|length }} results</span>
			</div>
		</div>
		<!-- Card header END -->

		<!-- Card body START -->
		<div class="card-body">

			<!-- Booking table START -->
			<div class="table-responsive border-0 rounded-3">
				<!-- Table START -->
				<table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
					<!-- Table head -->
					<thead>
						<tr>
							<th scope="col" class="border-0 rounded-start">Student Name</th>
							<th scope="col" class="border-0">Email</th>
							<th scope="col" class="border-0">Session</th>
							<th scope="col" class="border-0">Instructor</th>
							<th scope="col" class="border-0">Preferred Date</th>
							<th scope="col" class="border-0">Status</th>
							<th scope="col" class="border-0">Created</th>
							<th scope="col" class="border-0 rounded-end">Actions</th>
						</tr>
					</thead>
					
					<!-- Table body START -->
					<tbody>
						{% if bookings is empty %}
						<tr>
							<td colspan="8" class="text-center py-5">
								<div class="text-muted">
									<i class="bi bi-calendar-x fs-1 mb-3"></i>
									<p class="mb-0">No bookings found</p>
									<small class="text-muted">There are no bookings in the system yet.</small>
								</div>
							</td>
						</tr>
						{% else %}
						{% for booking in bookings %}
						<!-- Table row -->
						<tr data-booking-id="{{ booking.id }}" data-status="{{ booking.status|default('pending') }}" data-name="{{ booking.firstName|lower }} {{ booking.lastName|lower }}" data-email="{{ booking.userEmail|lower }}" data-created="{{ booking.createdAt ? booking.createdAt|date('Y-m-d H:i:s') : '' }}">
							<!-- Table data -->
							<td>
								<div class="d-flex align-items-center position-relative">
									<!-- Avatar -->
									<div class="avatar avatar-xs flex-shrink-0">
										<img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="avatar">
									</div>
									<!-- Title -->
									<h6 class="table-responsive-title mb-0 ms-2">	
										<a href="#" class="stretched-link text-white text-decoration-none">{{ booking.firstName }} {{ booking.lastName }}</a>
									</h6>
								</div>
							</td>

							<!-- Table data -->
							<td>{{ booking.userEmail }}</td>

							<!-- Table data -->
							<td>
								{% if booking.session %}
									<span class="badge bg-info">{{ booking.session.name|default('Session') }}</span>
								{% else %}
									<span class="badge bg-secondary">No Session</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if booking.session and booking.session.instructor %}
									<div class="d-flex align-items-center">
										<div class="avatar avatar-xs flex-shrink-0">
											<img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="instructor">
										</div>
										<span class="ms-2">{{ booking.session.instructor.fullName }}</span>
									</div>
								{% else %}
									<span class="text-muted">No instructor</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if booking.preferredDate %}
									{{ booking.preferredDate|date('M d, Y') }}
								{% else %}
									<span class="text-muted">Not set</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% set status = booking.status|default('pending') %}
								{% if status == 'pending' %}
									<span class="badge bg-warning bg-opacity-15 text-warning">Pending</span>
								{% elseif status == 'accepted' %}
									<span class="badge bg-success bg-opacity-10 text-success">Accepted</span>
								{% elseif status == 'denied' %}
									<span class="badge bg-danger bg-opacity-10 text-danger">Denied</span>
								{% else %}
									<span class="badge bg-secondary bg-opacity-10 text-secondary">{{ status|capitalize }}</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if booking.createdAt %}
									{{ booking.createdAt|date('M d, Y H:i') }}
								{% else %}
									<span class="text-muted">Recent</span>
								{% endif %}
							</td>

							<!-- Actions -->
							<td>
								<div class="dropdown dropstart">
									<button class="btn btn-sm btn-secondary btn-icon rounded-pill" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="fas fa-ellipsis-h"></i>
									</button>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="#" onclick="viewBooking({{ booking.id }})" title="View Details">
												<i class="fas fa-eye text-info me-2"></i>View
											</a>
										</li>
										<li>
											<a class="dropdown-item" href="#" onclick="editBooking({{ booking.id }})" title="Edit Booking">
												<i class="fas fa-edit text-warning me-2"></i>Edit
											</a>
										</li>
										<li><hr class="dropdown-divider"></li>
										<li>
											<a class="dropdown-item text-danger" href="#" onclick="deleteBooking({{ booking.id }})" title="Delete Booking">
												<i class="fas fa-trash me-2"></i>Delete
											</a>
										</li>
									</ul>
								</div>
							</td>
						</tr>
						{% endfor %}
						{% endif %}
						</tbody>
						<!-- Table body END -->
					</table>
					<!-- Table END -->
				</div>
				
				<!-- Pagination START -->
				<div class="d-flex justify-content-between align-items-center mt-4">
					<p class="mb-0">Showing {{ bookings|length }} bookings</p>
					<nav>
						<ul class="pagination pagination-sm mb-0">
							<li class="page-item disabled">
								<a class="page-link" href="#" tabindex="-1">Previous</a>
							</li>
							<li class="page-item active"><a class="page-link" href="#">1</a></li>
							<li class="page-item disabled">
								<a class="page-link" href="#" tabindex="-1">Next</a>
							</li>
						</ul>
					</nav>
				</div>
				<!-- Pagination END -->
			</div>
			<!-- Card body END -->
		</div>
		<!-- Booking table END -->

{% endblock %}

{% block admin_scripts %}
<script>
// Search and filter functionality
let searchTimeout;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const orderFilter = document.getElementById('orderFilter');
    const tableBody = document.querySelector('tbody');
    const resultsBadge = document.querySelector('.badge.bg-primary');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 300);
        });
    }
    
    // Handle filter changes
    [statusFilter, sortFilter, orderFilter].forEach(select => {
        if (select) {
            select.addEventListener('change', function() {
                performSearch();
            });
        }
    });
});

function performSearch() {
    // Get values from all filter elements
    const searchInput = document.querySelector('input[name="search"]');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const orderFilter = document.getElementById('orderFilter');
    const tableBody = document.querySelector('tbody');
    const allRows = Array.from(tableBody.getElementsByTagName('tr'));
    
    if (!tableBody) return;
    
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const statusValue = statusFilter ? statusFilter.value : '';
    const sortBy = sortFilter ? sortFilter.value : 'createdAt';
    const sortOrder = orderFilter ? orderFilter.value : 'desc';
    
    let visibleRows = [];
    
    // Filter rows
    allRows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const email = row.getAttribute('data-email') || '';
        const status = row.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) || 
            email.includes(searchTerm);
        
        const matchesStatus = !statusValue || status === statusValue;
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
            visibleRows.push(row);
        } else {
            row.style.display = 'none';
        }
    });
    
    // Sort visible rows
    if (sortBy) {
        visibleRows.sort((a, b) => {
            let aValue, bValue;
            
            switch(sortBy) {
                case 'name':
                    aValue = a.getAttribute('data-name') || '';
                    bValue = b.getAttribute('data-name') || '';
                    break;
                case 'email':
                    aValue = a.getAttribute('data-email') || '';
                    bValue = b.getAttribute('data-email') || '';
                    break;
                case 'status':
                    aValue = a.getAttribute('data-status') || '';
                    bValue = b.getAttribute('data-status') || '';
                    break;
                case 'createdAt':
                    aValue = a.getAttribute('data-created') || '';
                    bValue = b.getAttribute('data-created') || '';
                    break;
                default:
                    return 0;
            }
            
            let comparison = aValue.localeCompare(bValue);
            return sortOrder === 'desc' ? -comparison : comparison;
        });
        
        // Re-append sorted rows
        visibleRows.forEach(row => tableBody.appendChild(row));
    }
    
    // Update count
    const resultsBadge = document.querySelector('.badge.bg-primary');
    if (resultsBadge) {
        resultsBadge.textContent = visibleRows.length + ' results';
    }
}

// Table row hover effects
document.addEventListener('DOMContentLoaded', function() {
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.focus();
            searchInput.select();
        }
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput && searchInput.value) {
            searchInput.value = '';
            performSearch();
        }
    }
});

// Booking action functions
function viewBooking(bookingId) {
    // You can implement this as a modal or redirect to a detail page
    window.location.href = `/booking/${bookingId}/view`;
}

function editBooking(bookingId) {
    // Redirect to edit page or open edit modal
    window.location.href = `/booking/${bookingId}/edit`;
}

function deleteBooking(bookingId) {
    if (confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
        // Send delete request via fetch or form submission
        fetch(`/booking/${bookingId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                // Remove the row from table
                const row = document.querySelector(`tr[data-booking-id="${bookingId}"]`);
                if (row) {
                    row.remove();
                    // Update the count
                    updateBookingCount();
                    // Show success message
                    showNotification('Booking deleted successfully', 'success');
                }
            } else {
                showNotification('Error deleting booking', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error deleting booking', 'error');
        });
    }
}

function updateBookingCount() {
    const tableBody = document.querySelector('tbody');
    const visibleRows = Array.from(tableBody.getElementsByTagName('tr')).filter(row => row.style.display !== 'none');
    const resultsBadge = document.querySelector('.badge.bg-primary');
    if (resultsBadge) {
        resultsBadge.textContent = visibleRows.length + ' results';
    }
}

function showNotification(message, type) {
    // Create a simple notification (you can replace this with a toast library)
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}
