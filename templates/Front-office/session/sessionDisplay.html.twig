{% extends 'front_base.html.twig' %}

{% block title %}Session Display{% endblock %}

{% block content %}

	<!-- Title -->
	<div class="row">
		<div class="col-12 mb-3">
			<div class="d-flex justify-content-between align-items-center">
				<h1 class="h3 mb-2 mb-sm-0">Session Data</h1>
				<a href="{{ path('booking_create') }}" class="btn btn-primary mb-0">
					<i class="fas fa-calendar-plus me-2"></i>New Booking
				</a>
			</div>
		</div>
	</div>

	<!-- Counter boxes START -->
	<div class="row g-4 mb-4">
		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-warning bg-opacity-15 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ sessions|length }}</h2>
						<span class="mb-0 h6 fw-light">Total Sessions</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-warning text-white mb-0"><i class="fas fa-calendar-alt fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-success bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ sessions|filter(s => s.instructor is not null)|length }}</h2>
						<span class="mb-0 h6 fw-light">With Instructor</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-success text-white mb-0"><i class="fas fa-chalkboard-teacher fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-primary bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ sessions|filter(s => s.level == 'beginner')|length }}</h2>
						<span class="mb-0 h6 fw-light">Beginner Level</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-primary text-white mb-0"><i class="fas fa-graduation-cap fa-fw"></i></div>
				</div>
			</div>
		</div>

		<!-- Counter item -->
		<div class="col-md-6 col-xxl-3">
			<div class="card card-body bg-danger bg-opacity-10 p-4 h-100">
				<div class="d-flex justify-content-between align-items-center">
					<!-- Digit -->
					<div>
						<h2 class="mb-0 fw-bold">{{ sessions|filter(s => s.level == 'advanced')|length }}</h2>
						<span class="mb-0 h6 fw-light">Advanced Level</span>
					</div>
					<!-- Icon -->
					<div class="icon-lg rounded-circle bg-danger text-white mb-0"><i class="fas fa-award fa-fw"></i></div>
				</div>
			</div>
		</div>
	</div>
	<!-- Counter boxes END -->

	<!-- Search and filter START -->
	<div class="card shadow mb-4">
		<div class="card-header bg-light border-bottom">
			<!-- Search and select START -->
			<div class="row g-3 align-items-center justify-content-between">
				<!-- Search bar -->
				<div class="col-md-4">
					<form method="GET" class="position-relative" onsubmit="return false;">
						<input class="form-control bg-body pe-5" type="search" name="search" placeholder="Search sessions..." aria-label="Search">
						<button type="button" class="bg-transparent px-2 py-0 position-absolute top-50 end-0 translate-middle-y border-0 text-primary-hover text-reset" onclick="performSearch()">
							<i class="fas fa-search fs-6"></i>
						</button>
					</form>
				</div>

				<!-- Level filter -->
				<div class="col-md-2">
					<select class="form-select" name="level" id="levelFilter">
						<option value="">All Levels</option>
						<option value="beginner">Beginner</option>
						<option value="intermediate">Intermediate</option>
						<option value="advanced">Advanced</option>
					</select>
				</div>

				<!-- Sort filter -->
				<div class="col-md-2">
					<select class="form-select" name="sort" id="sortFilter">
						<option value="startDate">Start Date</option>
						<option value="name">Name</option>
						<option value="level">Level</option>
						<option value="duration">Duration</option>
					</select>
				</div>

				<!-- Sort order -->
				<div class="col-md-2">
					<select class="form-select" name="order" id="orderFilter">
						<option value="desc">Newest</option>
						<option value="asc">Oldest</option>
					</select>
				</div>
			</div>
			<!-- Search and select END -->
		</div>
	</div>
	<!-- Search and filter END -->

	<!-- Session table START -->
	<div class="card bg-transparent border shadow">

		<!-- Card header START -->
		<div class="card-header bg-light border-bottom">
			<div class="d-flex justify-content-between align-items-center">
				<h5 class="mb-0">Session List</h5>
				<span class="badge bg-primary">{{ sessions|length }} results</span>
			</div>
		</div>
		<!-- Card header END -->

		<!-- Card body START -->
		<div class="card-body">

			<!-- Session table START -->
			<div class="table-responsive border-0 rounded-3">
				<!-- Table START -->
				<table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
					<!-- Table head -->
					<thead>
						<tr>
							<th scope="col" class="border-0 rounded-start">Session Name</th>
							<th scope="col" class="border-0">Level</th>
							<th scope="col" class="border-0">Instructor</th>
							<th scope="col" class="border-0">Duration</th>
							<th scope="col" class="border-0">Start Date</th>
							<th scope="col" class="border-0">End Date</th>
							<th scope="col" class="border-0 rounded-end">Actions</th>
						</tr>
					</thead>
					
					<!-- Table body START -->
					<tbody>
						{% if sessions is empty %}
						<tr>
							<td colspan="7" class="text-center py-5">
								<div class="text-muted">
									<i class="bi bi-calendar-x fs-1 mb-3"></i>
									<p class="mb-0">No sessions found</p>
									<small class="text-muted">There are no sessions in the system yet.</small>
								</div>
							</td>
						</tr>
						{% else %}
						{% for session in sessions %}
						<!-- Table row -->
						<tr data-level="{{ session.level|default('') }}" data-name="{{ session.name|lower }}" data-instructor="{{ session.instructor ? session.instructor.fullName|lower : '' }}" data-start="{{ session.startDate ? session.startDate|date('Y-m-d') : '' }}">
							<!-- Table data -->
							<td>
								<div class="d-flex align-items-center position-relative">
									<!-- Title -->
									<h6 class="table-responsive-title mb-0">	
										<a href="#" class="stretched-link text-dark text-decoration-none">{{ session.name }}</a>
									</h6>
								</div>
							</td>

							<!-- Table data -->
							<td>
								{% set level = session.level|default('unknown') %}
								{% if level == 'beginner' %}
									<span class="badge bg-success bg-opacity-15 text-success">Beginner</span>
								{% elseif level == 'intermediate' %}
									<span class="badge bg-warning bg-opacity-15 text-warning">Intermediate</span>
								{% elseif level == 'advanced' %}
									<span class="badge bg-danger bg-opacity-15 text-danger">Advanced</span>
								{% else %}
									<span class="badge bg-secondary bg-opacity-15 text-secondary">{{ level|capitalize }}</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if session.instructor %}
									<div class="d-flex align-items-center">
										<div class="avatar avatar-xs flex-shrink-0">
											<img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="instructor">
										</div>
										<span class="ms-2">{{ session.instructor.fullName }}</span>
									</div>
								{% else %}
									<span class="text-muted">No instructor</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if session.duration %}
									{{ session.duration }} min
								{% else %}
									<span class="text-muted">Not set</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if session.startDate %}
									{{ session.startDate|date('M d, Y') }}
								{% else %}
									<span class="text-muted">Not set</span>
								{% endif %}
							</td>

							<!-- Table data -->
							<td>
								{% if session.endDate %}
									{{ session.endDate|date('M d, Y') }}
								{% else %}
									<span class="text-muted">Not set</span>
								{% endif %}
							</td>

							<!-- Actions -->
							<td>
								<div class="dropdown dropstart">
									<button class="btn btn-sm btn-secondary btn-icon rounded-pill" type="button" data-bs-toggle="dropdown" aria-expanded="false">
										<i class="fas fa-ellipsis-h"></i>
									</button>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="#" onclick="viewSession({{ session.id }})" title="View Details">
												<i class="fas fa-eye text-info me-2"></i>View
											</a>
										</li>
										<li>
											<a class="dropdown-item" href="#" onclick="editSession({{ session.id }})" title="Edit Session">
												<i class="fas fa-edit text-warning me-2"></i>Edit
											</a>
										</li>
										<li><hr class="dropdown-divider"></li>
										<li>
											<a class="dropdown-item text-danger" href="#" onclick="deleteSession({{ session.id }})" title="Delete Session">
												<i class="fas fa-trash me-2"></i>Delete
											</a>
										</li>
									</ul>
								</div>
							</td>
						</tr>
						{% endfor %}
						{% endif %}
						</tbody>
						<!-- Table body END -->
					</table>
					<!-- Table END -->
				</div>
				
				<!-- Pagination START -->
				<div class="d-flex justify-content-between align-items-center mt-4">
					<p class="mb-0">Showing {{ sessions|length }} sessions</p>
					<nav>
						<ul class="pagination pagination-sm mb-0">
							<li class="page-item disabled">
								<a class="page-link" href="#" tabindex="-1">Previous</a>
							</li>
							<li class="page-item active"><a class="page-link" href="#">1</a></li>
							<li class="page-item disabled">
								<a class="page-link" href="#" tabindex="-1">Next</a>
							</li>
						</ul>
					</nav>
				</div>
				<!-- Pagination END -->
			</div>
			<!-- Card body END -->
		</div>
		<!-- Session table END -->

	</div>
	<!-- Card END -->

	<!-- Edit Session Modal -->
	<div class="modal fade" id="editSessionModal" tabindex="-1" aria-labelledby="editSessionModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="editSessionModalLabel">Edit Session</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="editSessionForm">
						<input type="hidden" id="sessionId" name="id">
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionName" class="form-label">Session Name *</label>
									<input type="text" class="form-control" id="sessionName" name="name" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionLevel" class="form-label">Level *</label>
									<select class="form-select" id="sessionLevel" name="level" required>
										<option value="">Select Level</option>
										<option value="beginner">Beginner</option>
										<option value="intermediate">Intermediate</option>
										<option value="advanced">Advanced</option>
									</select>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionDuration" class="form-label">Duration (minutes) *</label>
									<input type="number" class="form-control" id="sessionDuration" name="duration" min="15" max="480" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionStartDate" class="form-label">Start Date *</label>
									<input type="date" class="form-control" id="sessionStartDate" name="startDate" required>
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionEndDate" class="form-label">End Date *</label>
									<input type="date" class="form-control" id="sessionEndDate" name="endDate" required>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label for="sessionInstructor" class="form-label">Instructor</label>
									<select class="form-select" id="sessionInstructor" name="instructor_id">
										<option value="">No Instructor</option>
										<!-- Instructors will be populated by JavaScript -->
									</select>
								</div>
							</div>
						</div>
						
						<div class="mb-3">
							<label for="sessionDescription" class="form-label">Description *</label>
							<textarea class="form-control" id="sessionDescription" name="sessionDescription" rows="4" required></textarea>
						</div>
						
						<div class="alert alert-info">
							<i class="fas fa-info-circle me-2"></i>
							<strong>Note:</strong> All fields marked with * are required.
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" form="editSessionForm" class="btn btn-primary">
						<i class="fas fa-save me-2"></i>Save Changes
					</button>
				</div>
			</div>
		</div>
	</div>

{% endblock %}

{% block admin_scripts %}
<script>
// Search and filter functionality
let searchTimeout;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[name="search"]');
    const levelFilter = document.getElementById('levelFilter');
    const sortFilter = document.getElementById('sortFilter');
    const orderFilter = document.getElementById('orderFilter');
    const tableBody = document.querySelector('tbody');
    const resultsBadge = document.querySelector('.badge.bg-primary');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 300);
        });
    }
    
    // Handle filter changes
    [levelFilter, sortFilter, orderFilter].forEach(select => {
        if (select) {
            select.addEventListener('change', function() {
                performSearch();
            });
        }
    });
});

function performSearch() {
    // Get values from all filter elements
    const searchInput = document.querySelector('input[name="search"]');
    const levelFilter = document.getElementById('levelFilter');
    const sortFilter = document.getElementById('sortFilter');
    const orderFilter = document.getElementById('orderFilter');
    const tableBody = document.querySelector('tbody');
    const allRows = Array.from(tableBody.getElementsByTagName('tr'));
    
    if (!tableBody) return;
    
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const levelValue = levelFilter ? levelFilter.value : '';
    const sortBy = sortFilter ? sortFilter.value : 'startDate';
    const sortOrder = orderFilter ? orderFilter.value : 'desc';
    
    let visibleRows = [];
    
    // Filter rows
    allRows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const instructor = row.getAttribute('data-instructor') || '';
        const level = row.getAttribute('data-level') || '';
        
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) || 
            instructor.includes(searchTerm);
        
        const matchesLevel = !levelValue || level === levelValue;
        
        if (matchesSearch && matchesLevel) {
            row.style.display = '';
            visibleRows.push(row);
        } else {
            row.style.display = 'none';
        }
    });
    
    // Sort visible rows
    if (sortBy) {
        visibleRows.sort((a, b) => {
            let aValue, bValue;
            
            switch(sortBy) {
                case 'name':
                    aValue = a.getAttribute('data-name') || '';
                    bValue = b.getAttribute('data-name') || '';
                    break;
                case 'instructor':
                    aValue = a.getAttribute('data-instructor') || '';
                    bValue = b.getAttribute('data-instructor') || '';
                    break;
                case 'level':
                    aValue = a.getAttribute('data-level') || '';
                    bValue = b.getAttribute('data-level') || '';
                    break;
                case 'startDate':
                    aValue = a.getAttribute('data-start') || '';
                    bValue = b.getAttribute('data-start') || '';
                    break;
                default:
                    return 0;
            }
            
            let comparison = aValue.localeCompare(bValue);
            return sortOrder === 'desc' ? -comparison : comparison;
        });
        
        // Re-append sorted rows
        visibleRows.forEach(row => tableBody.appendChild(row));
    }
    
    // Update count
    const resultsBadge = document.querySelector('.badge.bg-primary');
    if (resultsBadge) {
        resultsBadge.textContent = visibleRows.length + ' results';
    }
}

// Session action functions
function viewSession(sessionId) {
    // You can implement this as a modal or redirect to a detail page
    window.location.href = `/session/${sessionId}/view`;
}

function editSession(sessionId) {
    // Populate the edit modal with session data
    fetch(`/api/session/${sessionId}`)
        .then(response => response.json())
        .then(session => {
            document.getElementById('sessionId').value = session.id;
            document.getElementById('sessionName').value = session.name;
            document.getElementById('sessionLevel').value = session.level || '';
            document.getElementById('sessionDuration').value = session.duration || '';
            document.getElementById('sessionStartDate').value = session.startDate ? session.startDate.split('T')[0] : '';
            document.getElementById('sessionEndDate').value = session.endDate ? session.endDate.split('T')[0] : '';
            document.getElementById('sessionDescription').value = session.sessionDescription || '';
            
            // Populate instructors dropdown
            populateInstructors(session.instructor_id);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching session data:', error);
            showNotification('Error loading session data', 'error');
        });
}

function populateInstructors(selectedInstructorId = null) {
    // Fetch instructors from API or use existing data
    fetch('/api/instructors')
        .then(response => response.json())
        .then(instructors => {
            const select = document.getElementById('sessionInstructor');
            select.innerHTML = '<option value="">No Instructor</option>';
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor.id;
                option.textContent = instructor.fullName;
                if (selectedInstructorId && instructor.id == selectedInstructorId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching instructors:', error);
        });
}

// Handle edit form submission
document.getElementById('editSessionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const sessionId = formData.get('id');
    
    fetch(`/instructor/session/${sessionId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSessionModal'));
            modal.hide();
            
            // Show success message
            showNotification('Session updated successfully', 'success');
            
            // Refresh the page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('Error updating session', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating session', 'error');
    });
});

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
        // Send delete request via fetch or form submission
        fetch(`/instructor/session/${sessionId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                // Remove the row from table
                const row = document.querySelector(`tr[data-session-id="${sessionId}"]`);
                if (row) {
                    row.remove();
                    // Update the count
                    updateSessionCount();
                    // Show success message
                    showNotification('Session deleted successfully', 'success');
                }
            } else {
                showNotification('Error deleting session', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error deleting session', 'error');
        });
    }
}

function updateSessionCount() {
    const tableBody = document.querySelector('tbody');
    const visibleRows = Array.from(tableBody.getElementsByTagName('tr')).filter(row => row.style.display !== 'none');
    const resultsBadge = document.querySelector('.badge.bg-primary');
    if (resultsBadge) {
        resultsBadge.textContent = visibleRows.length + ' results';
    }
}

function showNotification(message, type) {
    // Create a simple notification (you can replace this with a toast library)
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Table row hover effects
document.addEventListener('DOMContentLoaded', function() {
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.focus();
            searchInput.select();
        }
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput && searchInput.value) {
            searchInput.value = '';
            performSearch();
        }
    }
});
</script>
{% endblock %}
