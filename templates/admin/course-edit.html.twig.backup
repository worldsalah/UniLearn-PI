{% extends 'admin/base_admin.html.twig' %}

{% block title %}Edit Course - Admin{% endblock %}

{% block admin_styles %}
<style>
.form-label {
    font-weight: 600;
    color: #374151;
}
.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}
.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}
.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}
.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.card-header {
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    border-radius: 12px 12px 0 0;
}
</style>
{% endblock %}

{% block admin_content %}
<!-- Title -->
<div class="row mb-4">
    <div class="col-12 d-sm-flex justify-content-between align-items-center">
        <h1 class="h3 mb-2 mb-sm-0">Edit Course</h1>
        <div>
            <a href="{{ path('admin_course_show', {'id': course.id}) }}" class="btn btn-sm btn-secondary mb-0 me-2">
                <i class="bi bi-x-lg me-1"></i>Cancel
            </a>
            <a href="{{ path('admin_course_list') }}" class="btn btn-sm btn-outline-secondary mb-0">
                <i class="bi bi-arrow-left me-1"></i>Back to Courses
            </a>
        </div>
    </div>
</div>

<!-- Edit form START -->
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">Course Information</h5>
            </div>
            <div class="card-body">
                <form id="editCourseForm">
                    <div class="row g-3">
                        <!-- Course Title -->
                        <div class="col-12">
                            <label for="courseTitle" class="form-label">Course Title *</label>
                            <input type="text" class="form-control" id="courseTitle" name="title" value="{{ course.title }}" required>
                        </div>

                        <!-- Course Description -->
                        <div class="col-12">
                            <label for="courseDescription" class="form-label">Course Description *</label>
                            <textarea class="form-control" id="courseDescription" name="description" rows="4" required>{{ course.shortDescription|default('') }}</textarea>
                        </div>

                        <!-- Category and Level -->
                        <div class="col-md-6">
                            <label for="courseCategory" class="form-label">Category *</label>
                            <select class="form-select" id="courseCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Web Development" {{ course.category == 'Web Development' ? 'selected' : '' }}>Web Development</option>
                                <option value="Mobile Development" {{ course.category == 'Mobile Development' ? 'selected' : '' }}>Mobile Development</option>
                                <option value="Data Science" {{ course.category == 'Data Science' ? 'selected' : '' }}>Data Science</option>
                                <option value="Design" {{ course.category == 'Design' ? 'selected' : '' }}>Design</option>
                                <option value="Business" {{ course.category == 'Business' ? 'selected' : '' }}>Business</option>
                                <option value="Marketing" {{ course.category == 'Marketing' ? 'selected' : '' }}>Marketing</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="courseLevel" class="form-label">Level *</label>
                            <select class="form-select" id="courseLevel" name="level" required>
                                <option value="">Select Level</option>
                                <option value="Beginner" {{ course.level == 'Beginner' ? 'selected' : '' }}>Beginner</option>
                                <option value="Intermediate" {{ course.level == 'Intermediate' ? 'selected' : '' }}>Intermediate</option>
                                <option value="Advanced" {{ course.level == 'Advanced' ? 'selected' : '' }}>Advanced</option>
                                <option value="All Levels" {{ course.level == 'All Levels' ? 'selected' : '' }}>All Levels</option>
                            </select>
                        </div>

                        <!-- Price -->
                        <div class="col-md-6">
                            <label for="coursePrice" class="form-label">Price ($) *</label>
                            <input type="number" class="form-control" id="coursePrice" name="price" value="{{ course.price }}" min="0" step="0.01" required>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <label for="courseStatus" class="form-label">Status *</label>
                            <select class="form-select" id="courseStatus" name="status" required>
                                <option value="pending" {{ course.status == 'pending' ? 'selected' : '' }}>Pending</option>
                                <option value="live" {{ course.status == 'live' ? 'selected' : '' }}>Live</option>
                                <option value="inactive" {{ course.status == 'inactive' ? 'selected' : '' }}>Inactive</option>
                                <option value="unaccept" {{ course.status == 'unaccept' ? 'selected' : '' }}>Unaccepted</option>
                            </select>
                        </div>

                        <!-- Thumbnail URL -->
                        <div class="col-12">
                            <label for="courseThumbnail" class="form-label">Course Thumbnail</label>
                            
                            <!-- Current Image Display -->
                            {% if course.thumbnailUrl %}
                            <div class="mb-3">
                                <small class="text-muted d-block">Current Image:</small>
                                <div class="position-relative d-inline-block">
                                    <img src="{{ asset(course.thumbnailUrl) }}" class="img-fluid rounded" alt="{{ course.title }}" style="max-height: 200px; max-width: 300px;">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeCurrentImage()" title="Remove current image">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Image Upload Options -->
                            <div class="mb-3">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="imageOption" id="keepImage" value="keep" {% if not course.thumbnailUrl %}checked{% endif %}>
                                    <label class="btn btn-outline-primary" for="keepImage">
                                        <i class="bi bi-image me-2"></i>Keep Current
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="imageOption" id="uploadImage" value="upload" {% if course.thumbnailUrl %}checked{% endif %}>
                                    <label class="btn btn-outline-primary" for="uploadImage">
                                        <i class="bi bi-upload me-2"></i>Upload New
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="imageOption" id="urlImage" value="url">
                                    <label class="btn btn-outline-primary" for="urlImage">
                                        <i class="bi bi-link-45deg me-2"></i>Use URL
                                    </label>
                                </div>
                            </div>
                            
                            <!-- File Upload (shown when upload is selected) -->
                            <div id="fileUploadSection" class="mb-3" style="display: {% if course.thumbnailUrl %}none{% else %}block{% endif %};">
                                <label for="courseImageFile" class="form-label">Choose Image File</label>
                                <input type="file" class="form-control" id="courseImageFile" name="imageFile" accept="image/*" onchange="previewImage(this)">
                                <small class="text-muted">Supported formats: JPG, PNG, GIF. Max size: 5MB</small>
                                
                                <!-- Image Preview -->
                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <small class="text-muted d-block">Preview:</small>
                                    <img id="previewImg" src="#" alt="Preview" class="img-fluid rounded" style="max-height: 200px; max-width: 300px;">
                                </div>
                            </div>
                            
                            <!-- URL Input (shown when URL is selected) -->
                            <div id="urlInputSection" class="mb-3" style="display: none;">
                                <label for="courseThumbnailUrl" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="courseThumbnailUrl" name="thumbnailUrl" value="{{ course.thumbnailUrl|default('') }}" placeholder="https://example.com/image.jpg" onchange="previewUrlImage(this.value)">
                                
                                <!-- URL Preview -->
                                <div id="urlPreview" class="mt-3" style="display: {% if course.thumbnailUrl %}block{% else %}none{% endif %};">
                                    <small class="text-muted d-block">Preview:</small>
                                    <img id="urlPreviewImg" src="{{ course.thumbnailUrl ? asset(course.thumbnailUrl) : '#' }}" alt="URL Preview" class="img-fluid rounded" style="max-height: 200px; max-width: 300px;">
                                </div>
                            </div>
                            
                            <!-- Hidden field to store the final choice -->
                            <input type="hidden" id="finalThumbnailUrl" name="finalThumbnailUrl" value="{{ course.thumbnailUrl|default('') }}">
                        </div>

                        <!-- Form Actions -->
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ path('admin_course_show', {'id': course.id}) }}'">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Course Info -->
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Course Info</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block">Course ID</small>
                    <span>#{{ course.id }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">Created</small>
                    <span>{{ course.createdAt ? course.createdAt|date('M d, Y') : 'Unknown' }}</span>
                </div>
                <div>
                    <small class="text-muted d-block">Instructor</small>
                    <span>{{ course.user ? course.user.fullName : 'Not assigned' }}</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ path('admin_course_show', {'id': course.id}) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye me-2"></i>View Course
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCourse({{ course.id }})">
                        <i class="bi bi-trash me-2"></i>Delete Course
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Edit form END -->
{% endblock %}

{% block admin_scripts %}
<script>
// Image option handling
document.addEventListener('DOMContentLoaded', function() {
    // Handle image option radio buttons
    const imageOptions = document.querySelectorAll('input[name="imageOption"]');
    const fileUploadSection = document.getElementById('fileUploadSection');
    const urlInputSection = document.getElementById('urlInputSection');
    
    imageOptions.forEach(option => {
        option.addEventListener('change', function() {
            const value = this.value;
            
            // Hide all sections first
            fileUploadSection.style.display = 'none';
            urlInputSection.style.display = 'none';
            
            // Show relevant section
            if (value === 'upload') {
                fileUploadSection.style.display = 'block';
            } else if (value === 'url') {
                urlInputSection.style.display = 'block';
            }
            
            // Update hidden field
            updateFinalThumbnailUrl();
        });
    });
});

// Preview uploaded image
function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            
            // Update hidden field with base64 data (for now, in production you'd upload to server)
            document.getElementById('finalThumbnailUrl').value = e.target.result;
        };
        
        reader.readAsDataURL(input.files[0]);
        
        // Validate file size (5MB max)
        if (input.files[0].size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            input.value = '';
            preview.style.display = 'none';
        }
    } else {
        preview.style.display = 'none';
    }
}

// Preview URL image
function previewUrlImage(url) {
    const urlPreview = document.getElementById('urlPreview');
    const urlPreviewImg = document.getElementById('urlPreviewImg');
    
    if (url) {
        urlPreviewImg.src = url;
        urlPreview.style.display = 'block';
        
        // Update hidden field
        document.getElementById('finalThumbnailUrl').value = url;
    } else {
        urlPreview.style.display = 'none';
    }
}

// Remove current image
function removeCurrentImage() {
    if (confirm('Are you sure you want to remove the current image?')) {
        // Clear current image display
        const currentImageDiv = document.querySelector('.position-relative.d-inline-block');
        if (currentImageDiv) {
            currentImageDiv.style.display = 'none';
        }
        
        // Set to upload mode
        document.getElementById('uploadImage').checked = true;
        document.getElementById('fileUploadSection').style.display = 'block';
        document.getElementById('urlInputSection').style.display = 'none';
        
        // Clear hidden field
        document.getElementById('finalThumbnailUrl').value = '';
    }
}

// Update final thumbnail URL based on current selection
function updateFinalThumbnailUrl() {
    const selectedOption = document.querySelector('input[name="imageOption"]:checked').value;
    const finalUrlField = document.getElementById('finalThumbnailUrl');
    
    if (selectedOption === 'keep') {
        // Keep current image (if exists)
        finalUrlField.value = '{{ course.thumbnailUrl|default('') }}';
    } else if (selectedOption === 'url') {
        // Use URL field value
        finalUrlField.value = document.getElementById('courseThumbnailUrl').value;
    } else if (selectedOption === 'upload') {
        // Will be set by file upload handler
        if (!document.getElementById('courseImageFile').files[0]) {
            finalUrlField.value = '';
        }
    }
}

// Form submission
document.getElementById('editCourseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    try {
        // Check if all required elements exist
        const titleElement = document.getElementById('courseTitle');
        const descElement = document.getElementById('courseDescription');
        const catElement = document.getElementById('courseCategory');
        const levelElement = document.getElementById('courseLevel');
        const priceElement = document.getElementById('coursePrice');
        const statusElement = document.getElementById('courseStatus');
        const thumbnailElement = document.getElementById('finalThumbnailUrl');
        
        if (!titleElement || !descElement || !catElement || !levelElement || !priceElement || !statusElement) {
            console.error('Missing form elements:', {
                title: !!titleElement,
                desc: !!descElement,
                cat: !!catElement,
                level: !!levelElement,
                price: !!priceElement,
                status: !!statusElement,
                thumbnail: !!thumbnailElement
            });
            alert('Form elements not found. Please refresh the page and try again.');
            return;
        }
        
        // Simple form data collection
        const data = {
            title: titleElement.value,
            description: descElement.value,
            category: catElement.value,
            level: levelElement.value,
            price: priceElement.value,
            status: statusElement.value,
            thumbnailUrl: thumbnailElement ? thumbnailElement.value : ''
        };
        
        // Validate required fields
        if (!data.title || !data.description || !data.category || !data.level || !data.price || !data.status) {
            console.error('Missing required data:', data);
            alert('Please fill in all required fields.');
            return;
        }
        
        console.log('Sending data:', data);
        console.log('Course ID:', {{ course.id }});
        
        submitCourseUpdate(data);
    } catch (error) {
        console.error('Form submission error:', error);
        alert('An error occurred while submitting the form: ' + error.message);
    }
});

function submitCourseUpdate(data) {
    try {
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        if (!submitBtn) {
            console.error('Submit button not found');
            alert('Submit button not found. Please refresh the page.');
            return;
        }
        
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2 fa-spin"></i>Saving...';
        submitBtn.disabled = true;
        
        console.log('Starting fetch request to:', `/api/course/{{ course.id }}/update`);
        console.log('Request data:', JSON.stringify(data, null, 2));
        
        // Send update request
        fetch(`/api/course/{{ course.id }}/update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('Fetch response received:', response);
            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(result => {
            console.log('Response parsed:', result);
            
            if (result.status === 'success') {
                alert('Course updated successfully!');
                window.location.href = '{{ path("admin_course_show", {"id": course.id}) }}';
            } else {
                console.error('Update failed:', result);
                alert('Error: ' + (result.message || 'Failed to update course'));
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            console.error('Error stack:', error.stack);
            alert('Network error occurred: ' + error.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    } catch (error) {
        console.error('SubmitCourseUpdate error:', error);
        alert('Error in update function: ' + error.message);
    }
}

window.deleteCourse = function(courseId) {
    if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        fetch(`/api/course/${courseId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Course deleted successfully');
                window.location.href = '{{ path("admin_course_list") }}';
            } else {
                alert(data.message || 'Failed to delete course');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
};
</script>
{% endblock %}
