{% extends 'admin/base_admin.html.twig' %}

{% block title %}Edit Quiz - Admin Dashboard{% endblock %}

{% block admin_content %}

		<!-- Title -->
		<div class="row">
			<div class="col-12 mb-3">
				<div class="d-sm-flex justify-content-between align-items-center">
					<div>
						<h1 class="h3 mb-2">Edit Quiz: {{ quiz.title }}</h1>
						<p class="mb-0">Modify quiz information and manage questions.</p>
					</div>
					<div class="d-flex gap-2">
						<a href="{{ path('app_admin_quiz_view', {'id': quiz.id}) }}" class="btn btn-info-soft">
							<i class="bi bi-eye me-2"></i>View Quiz
						</a>
						<a href="{{ path('app_admin_quizzes') }}" class="btn btn-secondary-soft">
							<i class="bi bi-arrow-left me-2"></i>Back to Quizzes
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Edit Form START -->
		<div class="row g-4 mb-4">
			<!-- Quiz Edit Form -->
			<div class="col-lg-6">
				<div class="card shadow h-100">
					<div class="card-header bg-primary text-white">
						<h5 class="card-header-title mb-0">
							<i class="bi bi-pencil me-2"></i>Edit Quiz Information
						</h5>
					</div>
					<div class="card-body">
						<form id="quizEditForm">
							<div class="row g-3">
								<div class="col-12">
									<label for="quizTitle" class="form-label">Quiz Title *</label>
									<input type="text" class="form-control" id="quizTitle" name="title" value="{{ quiz.title }}" required>
									<div class="form-text">Enter a descriptive title for this quiz.</div>
								</div>
								<div class="col-md-6">
									<label for="quizDescription" class="form-label">Description</label>
									<textarea class="form-control" id="quizDescription" name="description" rows="3" placeholder="Enter quiz description (optional)"></textarea>
								</div>
								<div class="col-md-6">
									<label for="quizTimeLimit" class="form-label">Time Limit (minutes)</label>
									<input type="text" class="form-control" id="quizTimeLimit" name="timeLimit" placeholder="60">
									<div class="form-text">Leave empty for no time limit.</div>
								</div>
								<div class="col-md-6">
									<label for="quizPassingScore" class="form-label">Passing Score (%)</label>
									<input type="text" class="form-control" id="quizPassingScore" name="passingScore" value="70">
								</div>
								<div class="col-md-6">
									<label for="quizAttempts" class="form-label">Max Attempts</label>
									<input type="text" class="form-control" id="quizAttempts" name="maxAttempts" value="3">
								</div>
								<div class="col-12">
									<label for="quizInstructions" class="form-label">Instructions</label>
									<textarea class="form-control" id="quizInstructions" name="instructions" rows="4" placeholder="Enter instructions for students taking this quiz"></textarea>
								</div>
							</div>
							<div class="row mt-4">
								<div class="col-12">
									<div class="d-flex gap-2">
										<button type="submit" class="btn btn-primary">
											<i class="bi bi-check-circle me-2"></i>Save Changes
										</button>
										<button type="button" class="btn btn-secondary" onclick="resetForm()">
											<i class="bi bi-arrow-clockwise me-2"></i>Reset
										</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Questions Management -->
			<div class="col-lg-6">
				<div class="card shadow h-100">
					<div class="card-header bg-success text-white">
						<h5 class="card-header-title mb-0">
							<i class="bi bi-question-circle me-2"></i>Questions Management
						</h5>
					</div>
					<div class="card-body">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h6 class="mb-0">Current Questions ({{ questions|length }})</h6>
							<button class="btn btn-sm btn-success" onclick="addNewQuestion()">
								<i class="bi bi-plus-circle me-1"></i>Add Question
							</button>
						</div>
						
						{% if questions|length > 0 %}
							<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
								<table class="table table-sm table-hover">
									<thead class="table-light sticky-top">
										<tr>
											<th width="5%">#</th>
											<th width="40%">Question</th>
											<th width="15%">Type</th>
											<th width="15%">Correct</th>
											<th width="25%">Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for question in questions %}
										<tr>
											<td>{{ loop.index }}</td>
											<td>
												<div class="text-truncate" style="max-width: 200px;" title="{{ question.question }}">
													{{ question.question|slice(0, 50) }}{% if question.question|length > 50 %}...{% endif %}
												</div>
											</td>
											<td>
												{% if question.optionA == 'True' or question.optionB == 'False' %}
													<span class="badge bg-info">True/False</span>
												{% else %}
													<span class="badge bg-primary">Multiple Choice</span>
												{% endif %}
											</td>
											<td>
												<span class="badge bg-success">{{ question.correctOption }}</span>
											</td>
											<td>
												<div class="btn-group btn-group-sm">
													<button class="btn btn-sm btn-outline-primary" onclick="editQuestion({{ question.id }})" title="Edit">
														<i class="bi bi-pencil"></i>
													</button>
													<button class="btn btn-sm btn-outline-info" onclick="viewQuestion({{ question.id }})" title="View">
														<i class="bi bi-eye"></i>
													</button>
													<button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion({{ question.id }}, '{{ question.question|e('js') }}')" title="Delete">
														<i class="bi bi-trash"></i>
													</button>
												</div>
											</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<div class="text-center py-4">
								<i class="bi bi-question-circle fs-1 text-muted mb-3"></i>
								<h6 class="text-muted">No Questions Yet</h6>
								<p class="text-muted small">Add questions to this quiz to get started.</p>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		<!-- Edit Form END -->

		<!-- Question Edit Modal -->
		<div class="modal fade" id="questionModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Question</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<form id="questionEditForm">
							<input type="hidden" id="questionId" name="id">
							<div class="row g-3">
								<div class="col-12">
									<label for="questionText" class="form-label">Question Text *</label>
									<textarea class="form-control" id="questionText" name="question" rows="3" required></textarea>
								</div>
								<div class="col-md-6">
									<label for="questionType" class="form-label">Question Type</label>
									<select class="form-select" id="questionType" name="type" onchange="toggleQuestionOptions()">
										<option value="multiple">Multiple Choice</option>
										<option value="true_false">True/False</option>
									</select>
								</div>
								<div class="col-md-6">
									<label for="correctOption" class="form-label">Correct Answer *</label>
									<select class="form-select" id="correctOption" name="correctOption" required>
										<option value="">Select correct answer</option>
										<option value="A">Option A</option>
										<option value="B">Option B</option>
										<option value="C">Option C</option>
										<option value="D">Option D</option>
									</select>
								</div>
								<div id="multipleChoiceOptions">
									<div class="col-12">
										<label for="optionA" class="form-label">Option A *</label>
										<input type="text" class="form-control" id="optionA" name="optionA" required>
									</div>
									<div class="col-12">
										<label for="optionB" class="form-label">Option B *</label>
										<input type="text" class="form-control" id="optionB" name="optionB" required>
									</div>
									<div class="col-12">
										<label for="optionC" class="form-label">Option C</label>
										<input type="text" class="form-control" id="optionC" name="optionC">
									</div>
									<div class="col-12">
										<label for="optionD" class="form-label">Option D</label>
										<input type="text" class="form-control" id="optionD" name="optionD">
									</div>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
					</div>
				</div>
			</div>
		</div>

	</div>
	<!-- Page main content END -->
{% endblock %}

{% block admin_scripts %}
<script>
let currentEditingQuestion = null;

// Quiz form submission
document.getElementById('quizEditForm').addEventListener('submit', function(e) {
	e.preventDefault();
	
	const formData = new FormData(this);
	const data = {
		title: formData.get('title'),
		description: formData.get('description'),
		timeLimit: formData.get('timeLimit'),
		passingScore: formData.get('passingScore'),
		maxAttempts: formData.get('maxAttempts'),
		instructions: formData.get('instructions')
	};
	
	// Show loading
	const submitBtn = this.querySelector('button[type="submit"]');
	const originalText = submitBtn.innerHTML;
	submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
	submitBtn.disabled = true;
	
	fetch(`/admin/quiz/{{ quiz.id }}/update`, {
		method: 'PUT',
		headers: {
			'Content-Type': 'application/json',
			'X-Requested-With': 'XMLHttpRequest'
		},
		body: JSON.stringify(data)
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			showAlert('Quiz updated successfully!', 'success');
			// Update title on page if changed
			if (data.title) {
				document.querySelector('h1').textContent = 'Edit Quiz: ' + data.title;
			}
		} else {
			showAlert(data.message || 'Error updating quiz', 'danger');
		}
	})
	.catch(error => {
		console.error('Error:', error);
		showAlert('Error updating quiz', 'danger');
	})
	.finally(() => {
		submitBtn.innerHTML = originalText;
		submitBtn.disabled = false;
	});
});

function resetForm() {
	if (confirm('Reset all changes? This will reload the original data.')) {
		location.reload();
	}
}

function addNewQuestion() {
	currentEditingQuestion = null;
	document.getElementById('questionId').value = '';
	document.getElementById('questionText').value = '';
	document.getElementById('questionType').value = 'multiple';
	document.getElementById('correctOption').value = '';
	document.getElementById('optionA').value = '';
	document.getElementById('optionB').value = '';
	document.getElementById('optionC').value = '';
	document.getElementById('optionD').value = '';
	
	document.querySelector('#questionModal .modal-title').textContent = 'Add New Question';
	
	const modal = new bootstrap.Modal(document.getElementById('questionModal'));
	modal.show();
}

function editQuestion(questionId) {
	// Find question data (in real implementation, this would fetch from API)
	const questions = {{ questions|json_encode|raw }};
	const question = questions.find(q => q.id === questionId);
	
	if (question) {
		currentEditingQuestion = questionId;
		document.getElementById('questionId').value = question.id;
		document.getElementById('questionText').value = question.question;
		document.getElementById('questionType').value = 
			(question.optionA === 'True' || question.optionB === 'False') ? 'true_false' : 'multiple';
		document.getElementById('correctOption').value = question.correctOption;
		document.getElementById('optionA').value = question.optionA;
		document.getElementById('optionB').value = question.optionB;
		document.getElementById('optionC').value = question.optionC;
		document.getElementById('optionD').value = question.optionD;
		
		document.querySelector('#questionModal .modal-title').textContent = 'Edit Question';
		
		toggleQuestionOptions();
		
		const modal = new bootstrap.Modal(document.getElementById('questionModal'));
		modal.show();
	}
}

function viewQuestion(questionId) {
	// Placeholder for view functionality
	alert('View question ID: ' + questionId + '\nFull question view coming soon!');
}

function deleteQuestion(questionId, questionText) {
	if (confirm('Are you sure you want to delete this question?\n\n"' + questionText + '"')) {
		// Placeholder for delete functionality
		alert('Delete question ID: ' + questionId + '\nDelete functionality coming soon!');
	}
}

function toggleQuestionOptions() {
	const questionType = document.getElementById('questionType').value;
	const multipleChoiceDiv = document.getElementById('multipleChoiceOptions');
	
	if (questionType === 'true_false') {
		// Hide options C and D for true/false
		document.getElementById('optionA').value = 'True';
		document.getElementById('optionB').value = 'False';
		document.getElementById('optionC').parentElement.style.display = 'none';
		document.getElementById('optionD').parentElement.style.display = 'none';
	} else {
		// Show all options for multiple choice
		document.getElementById('optionC').parentElement.style.display = 'block';
		document.getElementById('optionD').parentElement.style.display = 'block';
	}
}

function saveQuestion() {
	const form = document.getElementById('questionEditForm');
	const formData = new FormData(form);
	
	const data = {
		quizId: {{ quiz.id }},
		question: formData.get('question'),
		type: formData.get('type'),
		correctOption: formData.get('correctOption'),
		optionA: formData.get('optionA'),
		optionB: formData.get('optionB'),
		optionC: formData.get('optionC'),
		optionD: formData.get('optionD')
	};
	
	// Validation
	if (!data.question || !data.correctOption) {
		showAlert('Please fill in all required fields', 'warning');
		return;
	}
	
	// Show loading
	const saveBtn = document.querySelector('#questionModal .btn-primary');
	const originalText = saveBtn.innerHTML;
	saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
	saveBtn.disabled = true;
	
	// Simulate save (in real implementation, this would be an API call)
	setTimeout(() => {
		showAlert('Question saved successfully!', 'success');
		
		// Close modal
		const modal = bootstrap.Modal.getInstance(document.getElementById('questionModal'));
		modal.hide();
		
		// Reload page to show changes
		location.reload();
	}, 1000);
}

function showAlert(message, type = 'success') {
	const alertHtml = `
		<div class="alert alert-${type} alert-dismissible fade show" role="alert">
			<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
			${message}
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	`;
	
	// Create alert container if it doesn't exist
	let alertContainer = document.getElementById('alertContainer');
	if (!alertContainer) {
		alertContainer = document.createElement('div');
		alertContainer.id = 'alertContainer';
		alertContainer.className = 'position-fixed top-0 end-0 p-3';
		alertContainer.style.zIndex = '1050';
		document.body.appendChild(alertContainer);
	}
	
	alertContainer.innerHTML = alertHtml;
	
	// Auto dismiss after 3 seconds
	setTimeout(() => {
		const alert = alertContainer.querySelector('.alert');
		if (alert) {
			const bsAlert = new bootstrap.Alert(alert);
			bsAlert.close();
		}
	}, 3000);
}
</script>
{% endblock %}
