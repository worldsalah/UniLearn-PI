{% extends 'admin/base_admin.html.twig' %}

{% block title %}Import Questions from API - Admin Dashboard{% endblock %}

{% block admin_content %}

<!-- Title -->
<div class="row">
    <div class="col-12 mb-3">
        <div class="d-sm-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">üåê Import Questions from API</h1>
                <p class="mb-0">Fetch questions from Open Trivia Database and import them to your quiz.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ path('app_admin_quizzes') }}" class="btn btn-secondary-soft">
                    <i class="bi bi-arrow-left me-2"></i>Back to Quizzes
                </a>
                <a href="{{ path('app_admin_dashboard') }}" class="btn btn-info-soft">
                    <i class="bi bi-house me-2"></i>Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Import Form START -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="card-header-title mb-0">
                    <i class="bi bi-cloud-download me-2"></i>API Question Import
                </h5>
            </div>
            <div class="card-body">
                <form id="importForm">
                    <div class="row g-3">
                        <!-- Quiz Selection -->
                        <div class="col-md-6">
                            <label for="quizSelect" class="form-label">Select Quiz *</label>
                            <select class="form-select" id="quizSelect" required>
                                <option value="">Loading quizzes...</option>
                            </select>
                            <div class="form-text">Choose the quiz to import questions into.</div>
                        </div>

                        <!-- Number of Questions -->
                        <div class="col-md-6">
                            <label for="questionAmount" class="form-label">Number of Questions *</label>
                            <input type="number" class="form-control" id="questionAmount" min="1" max="50" value="10" required>
                            <div class="form-text">Maximum 50 questions per request (API limit).</div>
                        </div>

                        <!-- Category Selection -->
                        <div class="col-md-6">
                            <label for="categorySelect" class="form-label">Category</label>
                            <select class="form-select" id="categorySelect">
                                <option value="">Any Category</option>
                            </select>
                            <div class="form-text">Select a specific category or leave empty for random.</div>
                        </div>

                        <!-- Difficulty Selection -->
                        <div class="col-md-6">
                            <label for="difficultySelect" class="form-label">Difficulty</label>
                            <select class="form-select" id="difficultySelect">
                                <option value="">Any Difficulty</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                            <div class="form-text">Filter questions by difficulty level.</div>
                        </div>

                        <!-- Question Type -->
                        <div class="col-md-6">
                            <label for="typeSelect" class="form-label">Question Type</label>
                            <select class="form-select" id="typeSelect">
                                <option value="">Any Type</option>
                                <option value="multiple">Multiple Choice</option>
                                <option value="boolean">True/False</option>
                            </select>
                            <div class="form-text">Choose between multiple choice or true/false questions.</div>
                        </div>

                        <!-- Category Info Display -->
                        <div class="col-md-6">
                            <div id="categoryInfo" class="alert alert-info" style="display: none;">
                                <small id="categoryInfoText"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="fetchQuestions()">
                                    <i class="bi bi-search me-2"></i>Fetch Questions
                                </button>
                                <button type="button" class="btn btn-success" onclick="importQuestions()" id="importBtn" disabled>
                                    <i class="bi bi-download me-2"></i>Import Selected Questions
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Import Form END -->

<!-- Questions Preview Section -->
<div class="card shadow" id="questionsPreview" style="display: none;">
    <div class="card-header bg-success text-white">
        <h5 class="card-header-title mb-0">
            <i class="bi bi-question-circle me-2"></i>Fetched Questions 
            <span class="badge bg-white text-success ms-2" id="questionCount">0</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleAllQuestions()">
                <label class="form-check-label" for="selectAll">
                    <strong>Select All Questions</strong>
                </label>
            </div>
        </div>
        <div id="questionsList">
            <!-- Questions will be populated here -->
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Fetching questions from API...</p>
</div>

{% endblock %}

{% block admin_scripts %}
<script>
let fetchedQuestions = [];
let quizzes = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadQuizzes();
    loadCategories();
});

// Load quizzes
function loadQuizzes() {
    fetch('/quiz/courses')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                quizzes = data.courses;
                const quizSelect = document.getElementById('quizSelect');
                quizSelect.innerHTML = '<option value="">Select a quiz...</option>';
                
                quizzes.forEach(quiz => {
                    const option = document.createElement('option');
                    option.value = quiz.id;
                    option.textContent = quiz.title;
                    quizSelect.appendChild(option);
                });
            } else {
                showAlert('Failed to load quizzes', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading quizzes:', error);
            showAlert('Error loading quizzes', 'danger');
        });
}

// Load categories from API
function loadCategories() {
    fetch('/quiz/api/categories')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const categorySelect = document.getElementById('categorySelect');
                categorySelect.innerHTML = '<option value="">Any Category</option>';
                
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } else {
                console.error('Failed to load categories:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
        });
}

// Show category info when selected
document.getElementById('categorySelect').addEventListener('change', function() {
    const categoryId = this.value;
    const categoryInfo = document.getElementById('categoryInfo');
    const categoryInfoText = document.getElementById('categoryInfoText');
    
    if (categoryId) {
        fetch(`/quiz/api/category-count/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    categoryInfoText.textContent = `This category has ${data.question_count} available questions.`;
                    categoryInfo.style.display = 'block';
                } else {
                    categoryInfo.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching category count:', error);
                categoryInfo.style.display = 'none';
            });
    } else {
        categoryInfo.style.display = 'none';
    }
});

// Fetch questions from API
function fetchQuestions() {
    const quizId = document.getElementById('quizSelect').value;
    const amount = document.getElementById('questionAmount').value;
    const category = document.getElementById('categorySelect').value;
    const difficulty = document.getElementById('difficultySelect').value;
    const type = document.getElementById('typeSelect').value;

    if (!quizId) {
        showAlert('Please select a quiz first', 'warning');
        return;
    }

    if (!amount || amount < 1 || amount > 50) {
        showAlert('Please enter a valid number of questions (1-50)', 'warning');
        return;
    }

    // Show loading
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('questionsPreview').style.display = 'none';

    const requestData = {
        amount: parseInt(amount)
    };

    if (category) requestData.category = category;
    if (difficulty) requestData.difficulty = difficulty;
    if (type) requestData.type = type;

    fetch('/quiz/api/fetch-questions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (data.success) {
            fetchedQuestions = data.questions;
            displayQuestions();
            showAlert(`Successfully fetched ${data.count} questions!`, 'success');
        } else {
            showAlert(data.error || 'Failed to fetch questions', 'danger');
        }
    })
    .catch(error => {
        document.getElementById('loadingSpinner').style.display = 'none';
        console.error('Error:', error);
        showAlert('Error fetching questions', 'danger');
    });
}

// Display fetched questions
function displayQuestions() {
    const questionsList = document.getElementById('questionsList');
    const questionsPreview = document.getElementById('questionsPreview');
    const questionCount = document.getElementById('questionCount');
    
    if (fetchedQuestions.length === 0) {
        questionsList.innerHTML = '<p class="text-muted text-center">No questions found.</p>';
        questionsPreview.style.display = 'none';
        return;
    }

    questionCount.textContent = fetchedQuestions.length;
    questionsPreview.style.display = 'block';
    
    let html = '';
    fetchedQuestions.forEach((question, index) => {
        const questionId = `question_${index}`;
        html += `
            <div class="card mb-3 border">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${index}" id="${questionId}" onchange="updateImportButton()">
                        <label class="form-check-label" for="${questionId}">
                            <strong>Question ${index + 1}:</strong> ${question.question}
                        </label>
                    </div>
                    <div class="mt-2 ms-4">
                        <div class="row">
                            <div class="col-md-6">
                                <span class="badge bg-primary">${question.category}</span>
                                <span class="badge bg-secondary">${question.difficulty}</span>
                                <span class="badge bg-info">${question.type}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Options:</strong>
                            <ul class="list-unstyled">
                                <li><strong>A:</strong> ${question.option_a}</li>
                                <li><strong>B:</strong> ${question.option_b}</li>
                                <li><strong>C:</strong> ${question.option_c}</li>
                                <li><strong>D:</strong> ${question.option_d}</li>
                            </ul>
                            <small class="text-muted"><strong>Correct Answer:</strong> ${question.correct_option}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    questionsList.innerHTML = html;
    updateImportButton();
}

// Toggle all questions selection
function toggleAllQuestions() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('#questionsList input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateImportButton();
}

// Update import button state
function updateImportButton() {
    const checkedBoxes = document.querySelectorAll('#questionsList input[type="checkbox"]:checked');
    const importBtn = document.getElementById('importBtn');
    
    importBtn.disabled = checkedBoxes.length === 0;
    if (checkedBoxes.length > 0) {
        importBtn.innerHTML = `<i class="bi bi-download me-2"></i>Import ${checkedBoxes.length} Question${checkedBoxes.length > 1 ? 's' : ''}`;
    } else {
        importBtn.innerHTML = '<i class="bi bi-download me-2"></i>Import Selected Questions';
    }
}

// Import selected questions
function importQuestions() {
    const quizId = document.getElementById('quizSelect').value;
    const checkedBoxes = document.querySelectorAll('#questionsList input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        showAlert('Please select at least one question to import', 'warning');
        return;
    }

    const selectedQuestions = [];
    checkedBoxes.forEach(checkbox => {
        const questionIndex = parseInt(checkbox.value);
        selectedQuestions.push(fetchedQuestions[questionIndex]);
    });

    // Show loading
    const importBtn = document.getElementById('importBtn');
    const originalText = importBtn.innerHTML;
    importBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Importing...';
    importBtn.disabled = true;

    fetch(`/quiz/api/import-questions/${quizId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            questions: selectedQuestions
        })
    })
    .then(response => response.json())
    .then(data => {
        importBtn.innerHTML = originalText;
        importBtn.disabled = false;
        
        if (data.success) {
            showAlert(data.message, 'success');
            
            // Reset form after successful import
            setTimeout(() => {
                resetForm();
            }, 2000);
        } else {
            showAlert(data.message || 'Failed to import questions', 'danger');
        }
    })
    .catch(error => {
        importBtn.innerHTML = originalText;
        importBtn.disabled = false;
        console.error('Error:', error);
        showAlert('Error importing questions', 'danger');
    });
}

// Reset form
function resetForm() {
    document.getElementById('importForm').reset();
    fetchedQuestions = [];
    document.getElementById('questionsPreview').style.display = 'none';
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('categoryInfo').style.display = 'none';
    updateImportButton();
}

// Show alert function
function showAlert(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Create alert container if it doesn't exist
    let alertContainer = document.getElementById('alertContainer');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.id = 'alertContainer';
        alertContainer.className = 'position-fixed top-0 end-0 p-3';
        alertContainer.style.zIndex = '1050';
        document.body.appendChild(alertContainer);
    }
    
    alertContainer.innerHTML = alertHtml;
    
    // Auto dismiss after 3 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}
</script>
{% endblock %}
