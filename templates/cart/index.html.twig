{% extends 'front_base.html.twig' %}

{% block title %}Shopping Cart - Unilearn{% endblock %}

{% block content %}
<!-- Title -->
<div class="row">
    <div class="col-12 mb-4">
        <h1 class="h3 mb-2">Shopping Cart</h1>
        <p class="text-muted mb-0">Review your items and proceed to checkout</p>
    </div>
</div>

<!-- Cart Content -->
<div class="row">
    <!-- Cart Items -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header bg-white border-bottom p-4">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>Cart Items
                    <span class="badge bg-primary rounded-pill ms-2">{{ count }}</span>
                </h5>
            </div>
            <div class="card-body p-4">
                {% if cartItems is empty %}
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-4"></i>
                        <h5 class="text-muted">Your cart is empty</h5>
                        <p class="text-muted mb-4">Browse our marketplace to find amazing services</p>
                        <a href="{{ path('app_marketplace') }}" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Browse Marketplace
                        </a>
                    </div>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cartItems %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if item.type == 'product' %}
                                                    {% if item.product.image %}
                                                        <img src="{{ asset('uploads/products/' ~ item.product.image) }}" 
                                                             alt="{{ item.product.title }}" 
                                                             class="rounded me-3" 
                                                             style="width: 60px; height: 60px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="rounded me-3 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" 
                                                             style="width: 60px; height: 60px;">
                                                            <i class="fas fa-briefcase text-primary"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <h6 class="mb-1">{{ item.product.title }}</h6>
                                                        <small class="text-muted">{{ item.product.category.name|default('General') }}</small>
                                                        <div><span class="badge bg-info">Service</span></div>
                                                    </div>
                                                {% else %}
                                                    <div class="rounded me-3 bg-success bg-opacity-10 d-flex align-items-center justify-content-center" 
                                                         style="width: 60px; height: 60px;">
                                                        <i class="fas fa-briefcase text-success"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1">{{ item.job.title }}</h6>
                                                        <small class="text-muted">{{ item.job.category.name|default('General') }}</small>
                                                        <div><span class="badge bg-warning">Job Request</span></div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="fw-bold text-success cart-item-price" data-usd-price="{{ item.type == 'product' ? item.product.price : (item.job.budget ?? 0) }}">
                                                ${{ (item.type == 'product' ? item.product.price : (item.job.budget ?? 0))|number_format(2) }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="input-group" style="width: 120px;">
                                                <input type="number" 
                                                       class="form-control" 
                                                       value="{{ item.quantity }}" 
                                                       min="1" 
                                                       max="99"
                                                       onchange="updateCartItem({{ item.type == 'product' ? item.product.id : item.job.id }}, this.value)">
                                                <button class="btn btn-outline-secondary" onclick="updateCartItem({{ item.type == 'product' ? item.product.id : item.job.id }}, 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="updateCartItem({{ item.type == 'product' ? item.product.id : item.job.id }}, -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="fw-bold cart-item-subtotal" data-usd-price="{{ item.subtotal }}">${{ item.subtotal|number_format(2) }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="removeFromCart({{ item.type == 'product' ? item.product.id : item.job.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Cart Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>Shopping Cart
                        </h2>
                        <!-- Currency Selector -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="cartCurrencyDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-coins me-1"></i>
                                <span id="cartCurrentCurrency">USD</span>
                            </button>
                            <ul class="dropdown-menu" id="cartCurrencyMenu">
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="USD">ðŸ‡ºðŸ‡¸ USD - US Dollar</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="EUR">ðŸ‡ªðŸ‡º EUR - Euro</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="GBP">ðŸ‡¬ðŸ‡§ GBP - British Pound</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="JPY">ðŸ‡¯ðŸ‡µ JPY - Japanese Yen</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="CAD">ðŸ‡¨ðŸ‡¦ CAD - Canadian Dollar</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="AUD">ðŸ‡¦ðŸ‡º AUD - Australian Dollar</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="CHF">ðŸ‡¨ðŸ‡­ CHF - Swiss Franc</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="CNY">ðŸ‡¨ðŸ‡³ CNY - Chinese Yuan</a></li>
                                <li><a class="dropdown-item cart-currency-option" href="#" data-currency="INR">ðŸ‡®ðŸ‡³ INR - Indian Rupee</a></li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-outline-danger" onclick="clearCart()">
                        <i class="fas fa-trash me-2"></i>Clear Cart
                    </button>
                    <a href="{{ path('app_payment') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                        <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white p-4">
                <h5 class="card-title mb-0">
                    <i class="fas fa-receipt me-2"></i>Order Summary
                </h5>
            </div>
            <div class="card-body p-4">
                {% if cartItems is not empty %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-bold cart-total" data-usd-price="{{ total }}">${{ total|number_format(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (10%):</span>
                            <span class="fw-bold cart-tax" data-usd-price="{{ (total * 0.1) }}">${{ (total * 0.1)|number_format(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span class="fw-bold cart-shipping" data-usd-price="{{ (total > 0 ? 15.00 : 0) }}">${{ (total > 0 ? 15.00 : 0)|number_format(2) }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <h5 class="mb-0">Total:</h5>
                            <h5 class="mb-0 text-success cart-total-final" data-usd-price="{{ (total + (total * 0.1) + (total > 0 ? 15.00 : 0)) }}">${{ (total + (total * 0.1) + (total > 0 ? 15.00 : 0))|number_format(2) }}</h5>
                        </div>
                    </div>

                    <!-- Promo Code -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Promo Code</label>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Enter promo code">
                            <button class="btn btn-outline-primary">Apply</button>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <a href="{{ path('app_payment') }}" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-lock me-2"></i>Secure Checkout
                    </a>

                    <!-- Security Info -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure payment powered by SSL encryption
                        </small>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-shopping-basket fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Add items to your cart to see order summary</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Trust Badges -->
        <div class="card shadow mt-4">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3">Why Buy From Us?</h6>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <small>Professional Services</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <small>Secure Payments</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <small>24/7 Support</small>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <small>Satisfaction Guaranteed</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
// Cart Management Functions
function updateCartCount() {
    fetch('/cart/count')
        .then(response => response.json())
        .then(data => {
            // Update cart count in navigation
            const cartBadges = document.querySelectorAll('.cart-count');
            cartBadges.forEach(badge => {
                badge.textContent = data.count;
                badge.style.display = data.count > 0 ? 'inline' : 'none';
            });
        });
}

function updateCartItem(productId, change) {
    const input = event.target;
    const newQuantity = parseInt(input.value) + change;
    
    if (newQuantity < 1) {
        removeFromCart(productId);
        return;
    }
    
    fetch(`/cart/update/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `quantity=${newQuantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload to show updated cart
        }
    })
    .catch(error => {
        console.error('Error updating cart:', error);
    });
}

function removeFromCart(productId) {
    if (confirm('Are you sure you want to remove this item?')) {
        fetch(`/cart/remove/${productId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}

function clearCart() {
    if (confirm('Are you sure you want to clear your entire cart?')) {
        fetch('/cart/clear')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
}

// Update cart count on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCartCount();
});

// Add to cart function for marketplace
function addToCart(productId) {
    fetch(`/cart/add/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification
                showNotification('Product added to cart!', 'success');
                updateCartCount();
                
                // Update button state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check me-1"></i>Added!';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            showNotification('Failed to add product to cart', 'error');
        });
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Currency Converter Functions for Cart
let cartCurrentCurrency = localStorage.getItem('selectedCurrency') || 'USD';
const cartExchangeRates = {
    'USD': 1,
    'EUR': 0.85,
    'GBP': 0.73,
    'JPY': 110.0,
    'CAD': 1.25,
    'AUD': 1.35,
    'CHF': 0.92,
    'CNY': 6.45,
    'INR': 74.0
};

const cartCurrencySymbols = {
    'USD': '$',
    'EUR': 'â‚¬',
    'GBP': 'Â£',
    'JPY': 'Â¥',
    'CAD': 'C$',
    'AUD': 'A$',
    'CHF': 'CHF',
    'CNY': 'Â¥',
    'INR': 'â‚¹'
};

function initCartCurrencyConverter() {
    // Set current currency display
    const cartCurrencyElement = document.getElementById('cartCurrentCurrency');
    if (cartCurrencyElement) {
        cartCurrencyElement.textContent = cartCurrentCurrency;
    }
    
    // Add event listeners to currency options
    document.querySelectorAll('.cart-currency-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const newCurrency = this.dataset.currency;
            changeCartCurrency(newCurrency);
        });
    });
    
    // Update all prices on page load
    updateCartAllPrices();
}

function changeCartCurrency(currency) {
    cartCurrentCurrency = currency;
    localStorage.setItem('selectedCurrency', currency);
    const cartCurrencyElement = document.getElementById('cartCurrentCurrency');
    if (cartCurrencyElement) {
        cartCurrencyElement.textContent = currency;
    }
    updateCartAllPrices();
    showNotification(`Currency changed to ${currency}`, 'success');
}

function convertCartPrice(usdPrice, toCurrency) {
    if (toCurrency === 'USD') return usdPrice;
    return usdPrice * (cartExchangeRates[toCurrency] || 1);
}

function formatCartPrice(price, currency) {
    const symbol = cartCurrencySymbols[currency] || currency;
    
    switch (currency) {
        case 'EUR':
            return symbol + price.toFixed(2).replace('.', ',');
        case 'JPY':
        case 'CNY':
            return symbol + Math.round(price);
        case 'INR':
            return symbol + price.toFixed(2).replace('.', ',');
        default:
            return symbol + price.toFixed(2);
    }
}

function updateCartAllPrices() {
    // Update cart item prices
    document.querySelectorAll('.cart-item-price').forEach(element => {
        const usdPrice = parseFloat(element.dataset.usdPrice);
        if (!usdPrice) return;
        
        const convertedPrice = convertCartPrice(usdPrice, cartCurrentCurrency);
        const formattedPrice = formatCartPrice(convertedPrice, cartCurrentCurrency);
        
        element.textContent = formattedPrice;
    });
    
    // Update cart item subtotals
    document.querySelectorAll('.cart-item-subtotal').forEach(element => {
        const usdPrice = parseFloat(element.dataset.usdPrice);
        if (!usdPrice) return;
        
        const convertedPrice = convertCartPrice(usdPrice, cartCurrentCurrency);
        const formattedPrice = formatCartPrice(convertedPrice, cartCurrentCurrency);
        
        element.textContent = formattedPrice;
    });
    
    // Update cart totals
    document.querySelectorAll('.cart-total, .cart-tax, .cart-shipping, .cart-total-final').forEach(element => {
        const usdPrice = parseFloat(element.dataset.usdPrice);
        if (!usdPrice) return;
        
        const convertedPrice = convertCartPrice(usdPrice, cartCurrentCurrency);
        const formattedPrice = formatCartPrice(convertedPrice, cartCurrentCurrency);
        
        element.textContent = formattedPrice;
    });
}

// Initialize cart currency converter on page load
document.addEventListener('DOMContentLoaded', function() {
    initCartCurrencyConverter();
});

// Fetch real exchange rates for cart
async function fetchCartExchangeRates() {
    try {
        const response = await fetch('https://api.exchangerate.host/latest?access_key=ce959b41ed1e15ff5f57064926e5d1d1');
        const data = await response.json();
        
        if (data.rates) {
            Object.assign(cartExchangeRates, data.rates);
            cartExchangeRates.USD = 1; // Ensure USD is 1
            updateCartAllPrices();
        }
    } catch (error) {
        console.log('Using fallback exchange rates for cart');
        console.log('API Error:', error);
    }
}

// Fetch exchange rates on page load
fetchCartExchangeRates();
</script>

<style>
.cart-count {
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.75rem;
    margin-left: 5px;
}

.position-fixed {
    position: fixed;
}

.input-group {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    width: 100%;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.table td {
    vertical-align: middle;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.125rem;
}

.card {
    border: none;
    border-radius: 0.75rem;
}

.card-header {
    border-radius: 0.75rem 0.75rem 0 0 !important;
}
</style>
{% endblock %}
