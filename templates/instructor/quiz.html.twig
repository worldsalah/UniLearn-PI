{% extends 'front_base.html.twig' %}

{% block title %}Quiz Management - Unilearn{% endblock %}

{% block stylesheets %}
<style>
.clickable-row {
    cursor: pointer;
    transition: all 0.3s ease;
}
.clickable-row:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.clickable-row:active {
    background-color: #e9ecef;
}
.quiz-actions {
    pointer-events: none;
}

/* Dashboard Styles */
.instructor-gradient {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    position: relative;
    overflow: hidden;
}
.instructor-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('{{ asset('assets/images/pattern/04.png') }}') no-repeat center center;
    background-size: cover;
    opacity: 0.1;
}
.profile-banner {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}
.profile-banner::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(13, 110, 253, 0.05) 0%, transparent 70%);
    animation: float 6s ease-in-out infinite;
}
.avatar-enhanced {
    border: 4px solid white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.avatar-enhanced:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}
.sidebar-modern {
    background: #212529;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.sidebar-modern .list-group-item {
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.8);
    transition: all 0.3s ease;
    border-radius: 10px;
    margin: 5px;
}
.sidebar-modern .list-group-item:hover {
    background: rgba(255,255,255,0.1);
    color: white;
    transform: translateX(5px);
}
.sidebar-modern .list-group-item.active {
    background: rgba(255,255,255,0.2);
    color: white;
}
.sidebar-modern .list-group-item.text-danger:hover {
    background: rgba(220, 53, 69, 0.2);
}
@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}
.verified-badge {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: bold;
}

/* Stats Cards */
.stats-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}
.stats-card:hover::before {
    left: 100%;
}
.stats-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

/* Tab Navigation */
.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    background: transparent;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}
.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    border-radius: 10px 10px 0 0;
}
.nav-tabs .nav-link:hover {
    color: #0d6efd;
}

/* Search and Filter */
.search-box {
    position: relative;
}
.search-box .form-control {
    padding-left: 3rem;
    border-radius: 50px;
    border: 2px solid #e9ecef;
}
.search-box .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

/* Table Enhancements */
.table-header-gradient {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}
.quiz-table tbody tr {
    transition: all 0.2s ease;
}
.quiz-table tbody tr:hover {
    background-color: #f8f9fa;
    transform: translateX(3px);
}
</style>
{% endblock %}

{% block content %}

<!-- **************** MAIN CONTENT START **************** -->
<main>
	
<!-- =======================
Page Banner START -->
<section class="pt-0">
	<!-- Main banner background image -->
	<div class="container-fluid px-0">
		<div class="instructor-gradient h-100px h-md-200px rounded-0" style="background:url({{ asset('assets/images/pattern/04.png') }}) no-repeat center center; background-size:cover;">
		</div>
	</div>
	<div class="container mt-n4">
		<div class="row">
			<!-- Profile banner START -->
			<div class="col-12">
				<div class="profile-banner card-body p-4">
					<div class="row d-flex justify-content-between">
						<!-- Avatar -->
						<div class="col-auto mt-4 mt-md-0">
							<div class="avatar avatar-xxl mt-n3 position-relative">
								<img class="avatar-img rounded-circle avatar-enhanced" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="">
								<div class="position-absolute bottom-0 end-0">
									<span class="verified-badge">
										<i class="bi bi-patch-check-fill"></i> Verified
									</span>
								</div>
							</div>
						</div>
						<!-- Profile info -->
						<div class="col d-md-flex justify-content-between align-items-center mt-4">
							<div>
								<h1 class="my-1 fs-3 fw-bold">{% if teacher.name is defined %}{{ teacher.name }}{% else %}Instructor{% endif %}</h1>
								<div class="d-flex flex-wrap align-items-center gap-3 mb-2">
									<span class="badge bg-primary bg-opacity-10 text-primary">
										<i class="fas fa-tv me-1"></i>{% if totalCourses is defined %}{{ totalCourses }}{% else %}12{% endif %} Courses
									</span>
									<span class="badge bg-success bg-opacity-10 text-success">
										<i class="fas fa-user-graduate me-1"></i>{% if totalStudents is defined %}{{ totalStudents }}{% else %}1250{% endif %}K Students
									</span>
									<span class="badge bg-warning bg-opacity-10 text-warning">
										<i class="fas fa-star me-1"></i>{% if averageRating is defined %}{{ averageRating }}{% else %}4.8{% endif %}/5.0 Rating
									</span>
								</div>
								<p class="text-muted mb-0">Professional Instructor | Content Creator | Educator</p>
							</div>
							<div class="d-flex align-items-center mt-2 mt-md-0">
								<a href="#" class="btn btn-sm btn-primary mb-0" data-bs-toggle="modal" data-bs-target="#addQuiz">Add New Quiz</a>
							</div>
						</div>
					</div>
				</div>
				<!-- Profile banner END -->

				<!-- Advanced filter responsive toggler START -->
				<!-- Divider -->
				<hr class="d-xl-none">
				<div class="col-12 col-xl-3 d-flex justify-content-between align-items-center">
					<a class="h6 mb-0 fw-bold d-xl-none" href="#">Menu</a>
					<button class="btn btn-primary d-xl-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
						<i class="fas fa-sliders-h"></i>
					</button>
				</div>
				<!-- Advanced filter responsive toggler END -->
			</div>
		</div>
	</div>
</section>
<!-- =======================
Page Banner END -->

<!-- =======================
Page content START -->
<section class="pt-0">
	<div class="container">
		<div class="row">
			<!-- Left sidebar START -->
			<div class="col-xl-3">
				<!-- Responsive offcanvas body START -->
				<div class="offcanvas-xl offcanvas-end" tabindex="-1" id="offcanvasSidebar">
					<!-- Offcanvas header -->
					<div class="offcanvas-header bg-light">
						<h5 class="offcanvas-title" id="offcanvasNavbarLabel">My profile</h5>
						<button  type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasSidebar" aria-label="Close"></button>
					</div>
					<!-- Offcanvas body -->
					<div class="offcanvas-body p-3 p-xl-0">
						{% include 'instructor/_sidebar.html.twig' %}
					</div>
				</div>
				<!-- Responsive offcanvas body END -->
			</div>
			<!-- Left sidebar END -->
			
			<!-- Main content START -->
			<div class="col-xl-9">

				<!-- Dynamic Header -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<div>
						<h3 class="mb-1">Quiz Management</h3>
						<p class="text-muted mb-0">
							<span id="visibleCount">{% if quizzes is defined %}{{ quizzes|length }}{% else %}0{% endif %}</span> of {% if quizzes is defined %}{{ quizzes|length }}{% else %}0{% endif %} quizzes
						</p>
					</div>
					<div class="d-flex gap-2">
						<button class="btn btn-outline-primary btn-sm" onclick="refreshResults()">
							<i class="bi bi-arrow-clockwise me-1"></i> Refresh
						</button>
						<button class="btn btn-outline-secondary btn-sm" onclick="exportResults()">
							<i class="bi bi-download me-1"></i> Export
						</button>
						<button class="btn btn-outline-warning btn-sm" onclick="testSorting()">
							<i class="bi bi-sort-down me-1"></i> Test Sort
						</button>
					</div>
				</div>

				<!-- Search and Sort Controls -->
				<div class="row g-3 align-items-center justify-content-between mb-4">
					<div class="col-md-8">
						<div class="search-box">
							<i class="fas fa-search search-icon"></i>
							<input class="form-control" type="search" id="searchInput" placeholder="Search quizzes..." aria-label="Search">
						</div>
					</div>
					<div class="col-md-3">
						<select class="form-select" name="sortBy" aria-label="Sort by">
							<option value="">Sort by</option>
							<option value="name">Name (A-Z)</option>
							<option value="name-desc">Name (Z-A)</option>
							<option value="date-newest">Date (Newest First)</option>
							<option value="date-oldest">Date (Oldest First)</option>
							<option value="questions">Most Questions</option>
							<option value="questions-fewest">Fewest Questions</option>
							<option value="course">Course Name</option>
						</select>
					</div>
				</div>

				<!-- Dynamic Stats Cards -->
				<div class="row g-3 mb-4">
					<div class="col-md-3">
						<div class="stats-card">
							<div class="card-body text-center">
								<h4 class="mb-1">{% if quizzes is defined %}{{ quizzes|length }}{% else %}0{% endif %}</h4>
								<small class="text-muted">Total Quizzes</small>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stats-card">
							<div class="card-body text-center">
								<h4 class="mb-1 text-success">{% if totalQuestions is defined %}{{ totalQuestions }}{% else %}0{% endif %}</h4>
								<small class="text-muted">Total Questions</small>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stats-card">
							<div class="card-body text-center">
								<h4 class="mb-1 text-warning">{% if avgScore is defined %}{{ avgScore }}{% else %}0{% endif %}%</h4>
								<small class="text-muted">Avg Score</small>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stats-card">
							<div class="card-body text-center">
								<h4 class="mb-1 text-info">{% if totalAttempts is defined %}{{ totalAttempts }}{% else %}0{% endif %}</h4>
								<small class="text-muted">Total Attempts</small>
							</div>
						</div>
					</div>
				</div>

				<!-- Tab Navigation -->
				<ul class="nav nav-tabs mb-4" id="quizTabs" role="tablist">
					<li class="nav-item" role="presentation">
						<button class="nav-link active" id="all-quizzes-tab" data-bs-toggle="tab" data-bs-target="#all-quizzes" type="button" role="tab">
							<i class="bi bi-list-ul me-2"></i>All Quizzes
						</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link" id="recent-quizzes-tab" data-bs-toggle="tab" data-bs-target="#recent-quizzes" type="button" role="tab">
							<i class="bi bi-clock me-2"></i>Recent
						</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link" id="api-import-tab" data-bs-toggle="tab" data-bs-target="#api-import" type="button" role="tab">
							Generate Questions
						</button>
					</li>
				</ul>

				<!-- Tab Content -->
				<div class="tab-content" id="quizTabContent">
					<!-- Debug Info -->
					<div class="alert alert-info mb-3">
						<strong>Debug Info:</strong><br>
						Quizzes variable exists: {{ quizzes is defined ? 'Yes' : 'No' }}<br>
						Quizzes count: {{ quizzes|length }}<br>
						User: {{ app.user ? app.user.email : 'Not logged in' }}<br>
						User ID: {{ app.user ? app.user.id : 'N/A' }}<br>
						{% if quizzes is defined and quizzes|length > 0 %}
							<strong>First Quiz:</strong> {{ quizzes[0].title }} (ID: {{ quizzes[0].id }})<br>
							<strong>Course:</strong> {{ quizzes[0].course ? quizzes[0].course.title : 'No Course' }}
						{% endif %}
					</div>
					
					<!-- All Quizzes Tab -->
					<div class="tab-pane fade show active" id="all-quizzes" role="tabpanel">
						<div class="card shadow-sm">
							<div class="card-body p-0">
								{% if quizzes is defined and quizzes|length > 0 %}
								<div class="table-responsive">
									<table class="table table-hover mb-0 quiz-table">
										<thead class="table-header-gradient">
											<tr>
												<th><i class="bi bi-file-earmark-text me-1"></i>Title</th>
												<th><i class="bi bi-question-circle me-1"></i>Questions</th>
												<th><i class="bi bi-book me-1"></i>Course</th>
												<th><i class="bi bi-calendar me-1"></i>Created</th>
												<th class="text-center"><i class="bi bi-gear me-1"></i>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for quiz in quizzes %}
											<tr class="clickable-row quiz-row" data-quiz-id="{{ quiz.id }}" onclick="viewQuizDetails({{ quiz.id }})">
												<td>
													<div class="d-flex justify-content-between align-items-center">
														<div>
															<strong class="text-dark quiz-title">{{ quiz.title }}</strong>
															<br>
															<small class="text-muted">Quiz #{{ quiz.id }}</small>
														</div>
														<div class="d-flex align-items-center">
															<span class="badge bg-primary-subtle text-primary me-2">{{ quiz.questions|length }} Questions</span>
															<i class="bi bi-chevron-down text-muted" id="chevron-{{ quiz.id }}"></i>
														</div>
													</div>
												</td>
												<td>
													<span class="badge bg-info-subtle text-info">{{ quiz.questions|length }}</span>
												</td>
												<td>
													{% if quiz.course %}
														<span class="badge bg-success-subtle text-success">{{ quiz.course.title }}</span>
													{% else %}
														<span class="text-muted">No Course</span>
													{% endif %}
												</td>
												<td>
													<span class="text-muted small" data-date="{{ quiz.createdAt|date('Y-m-d') }}">{{ quiz.createdAt|date('M d, Y') }}</span>
												</td>
												<td>
													<div class="btn-group btn-group-sm" role="group">
														<button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editQuiz({{ quiz.id }})" title="Edit Quiz">
															<i class="bi bi-pencil"></i>
														</button>
														<button class="btn btn-outline-info btn-sm" onclick="event.stopPropagation(); openAddQuestionModal({{ quiz.id }}, '{{ quiz.title|e('js') }}')" title="Add Question">
															<i class="bi bi-plus"></i>
														</button>
														<button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); translateQuizQuestions({{ quiz.id }}, '{{ quiz.title|e('js') }}')" title="Translate Quiz">
															<i class="bi bi-translate"></i>
														</button>
														<button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteQuiz({{ quiz.id }}, '{{ quiz.title|e('js') }}')" title="Delete Quiz">
															<i class="bi bi-trash"></i>
														</button>
													</div>
												</td>
											</tr>
											<!-- Questions Row (Hidden by default) -->
											<tr id="questions-{{ quiz.id }}" style="display: none;">
												<td colspan="5" class="p-0">
													<div class="bg-light p-4">
														<div class="d-flex justify-content-between align-items-center mb-3">
															<h6 class="mb-0 fw-bold">
																<i class="bi bi-list-ul me-2"></i>
																Questions for {{ quiz.title }}
															</h6>
															<span class="badge bg-secondary">{{ quiz.questions|length }} Questions</span>
														</div>
														{% if quiz.questions|length > 0 %}
															<div class="row">
																{% for question in quiz.questions %}
																	<div class="col-md-6 mb-3">
																		<div class="card border-0 shadow-sm">
																			<div class="card-body">
																				<div class="d-flex justify-content-between align-items-start mb-2">
																					<div class="flex-grow-1">
																						<h6 class="mb-2 text-dark">{{ question.question }}</h6>
																						<div class="d-flex flex-wrap gap-1 mb-2">
																							<span class="badge bg-light text-dark">Multiple Choice</span>
																							<span class="badge bg-success-subtle text-success">Correct: {{ question.correctOption }}</span>
																						</div>
																					</div>
																					<div class="d-flex gap-1">
																						<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editQuestion({{ question.id }}, '{{ question.question|e('js') }}')" title="Edit Question">
																							<i class="bi bi-pencil"></i>
																						</button>
																						<button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); translateQuestion({{ question.id }}, '{{ question.question|e('js') }}')" title="Translate Question">
																							<i class="bi bi-translate"></i>
																						</button>
																						<button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteQuestion({{ question.id }}, '{{ question.question|e('js') }}')" title="Delete Question">
																							<i class="bi bi-trash"></i>
																						</button>
																					</div>
																				</div>
																				<div class="options-grid">
																					<div class="row g-2">
																						<div class="col-6">
																							<span class="badge bg-light text-dark">A</span> {{ question.optionA }}
																						</div>
																						<div class="col-6">
																							<span class="badge bg-light text-dark">B</span> {{ question.optionB }}
																						</div>
																						{% if question.optionC %}
																							<div class="col-6">
																								<span class="badge bg-light text-dark">C</span> {{ question.optionC }}
																							</div>
																						{% endif %}
																						{% if question.optionD %}
																							<div class="col-6">
																								<span class="badge bg-light text-dark">D</span> {{ question.optionD }}
																							</div>
																						{% endif %}
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																{% endfor %}
															</div>
														{% else %}
															<div class="text-center py-5">
																<i class="bi bi-question-circle fs-1 text-muted mb-3"></i>
																<p class="text-muted mb-3">No questions added yet</p>
																<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAddQuestionModal({{ quiz.id }}, '{{ quiz.title|e('js') }}')">
																	<i class="bi bi-plus-circle me-1"></i> Add First Question
																</button>
															</div>
														{% endif %}
													</div>
												</td>
											</tr>
											{% else %}
											<tr>
												<td colspan="5" class="text-center py-5">
													<div class="text-muted">
														<i class="bi bi-inbox fs-1 mb-3"></i>
														<p class="mb-0">No quizzes found in database</p>
														<small class="text-muted">Create your first quiz to get started</small>
													</div>
												</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
								{% else %}
								<div class="text-center py-5">
									<i class="bi bi-inbox display-4 text-muted"></i>
									<h5 class="mt-3">No Quizzes Found</h5>
									<p class="text-muted">Start by creating your first quiz to engage your students.</p>
									<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuiz">
										<i class="bi bi-plus-circle me-2"></i>Create Your First Quiz
									</button>
								</div>
								{% endif %}
							</div>
						</div>
					</div>
					<!-- Recent Quizzes Tab -->
					<div class="tab-pane fade" id="recent-quizzes" role="tabpanel">
						<div class="text-center py-5">
							<i class="bi bi-clock display-4 text-muted"></i>
							<h5 class="mt-3">Recent Quizzes</h5>
							<p class="text-muted">Your most recently created quizzes will appear here.</p>
						</div>
					</div>
					<!-- Popular Quizzes Tab -->
					<div class="tab-pane fade" id="popular-quizzes" role="tabpanel">
						<div class="text-center py-5">
							<i class="bi bi-star display-4 text-muted"></i>
							<h5 class="mt-3">Most Questions</h5>
							<p class="text-muted">Quizzes with the most questions will appear here.</p>
						</div>
					</div>
					<!-- API Import Tab -->
					<div class="tab-pane fade" id="api-import" role="tabpanel">
						<div class="card shadow-sm">
							<div class="card-header bg-primary text-white">
								<h5 class="card-title mb-0">
									Generate Question
								</h5>
							</div>
							<div class="card-body">
								<p class="text-muted mb-4">Enhance your quizzes with AI-generated questions using Gemini AI.</p>
								
								<div class="row g-3">
									<div class="col-md-4">
										<label for="instructorQuestionAmount" class="form-label">Number of Questions</label>
										<input type="number" class="form-control" id="instructorQuestionAmount" min="1" max="50" value="10">
										<div class="form-text">Max 50 questions per request</div>
									</div>
									<div class="col-md-4">
										<label for="instructorCategorySelect" class="form-label">Category</label>
										<select class="form-select" id="instructorCategorySelect">
											<option value="">Any Category</option>
											<option value="General Knowledge">General Knowledge</option>
											<option value="Science & Nature">Science & Nature</option>
											<option value="Mathematics">Mathematics</option>
											<option value="History">History</option>
											<option value="Geography">Geography</option>
											<option value="Literature">Literature</option>
											<option value="Computer Science">Computer Science</option>
											<option value="Physics">Physics</option>
											<option value="Chemistry">Chemistry</option>
											<option value="Biology">Biology</option>
											<option value="Psychology">Psychology</option>
											<option value="Economics">Economics</option>
											<option value="Politics">Politics</option>
											<option value="Art">Art</option>
											<option value="Music">Music</option>
											<option value="Sports">Sports</option>
											<option value="Technology">Technology</option>
											<option value="Business">Business</option>
											<option value="Philosophy">Philosophy</option>
											<option value="Languages">Languages</option>
										</select>
									</div>
									<div class="col-md-4">
										<label for="instructorDifficultySelect" class="form-label">Difficulty</label>
										<select class="form-select" id="instructorDifficultySelect">
											<option value="">Any Difficulty</option>
											<option value="easy">Easy</option>
											<option value="medium">Medium</option>
											<option value="hard">Hard</option>
										</select>
									</div>
								</div>

								<div class="row g-3 mt-3">
									<div class="col-md-4">
										<label for="instructorTypeSelect" class="form-label">Question Type</label>
										<select class="form-select" id="instructorTypeSelect">
											<option value="">Any Type</option>
											<option value="multiple">Multiple Choice</option>
											<option value="boolean">True/False</option>
										</select>
									</div>
									<div class="col-md-4">
										<label for="instructorQuizSelect" class="form-label">Target Quiz</label>
										<select class="form-select" id="instructorQuizSelect">
											<option value="">Select a quiz first...</option>
											{% if quizzes is defined %}
												{% for quiz in quizzes %}
													<option value="{{ quiz.id }}">{{ quiz.title }}</option>
												{% endfor %}
											{% endif %}
										</select>
										<div class="form-text">Choose which quiz to add questions to</div>
									</div>
								</div>

								<div class="mt-4">
									<button type="button" class="btn btn-outline-primary" onclick="fetchInstructorQuestions()">
										<i class="bi bi-robot me-2"></i>Generate Questions with AI
									</button>
									<button type="button" class="btn btn-success" onclick="importInstructorQuestions()" id="instructorImportBtn" disabled>
										<i class="bi bi-download me-2"></i>Import Selected Questions
									</button>
								</div>

								<!-- Questions Preview -->
								<div id="instructorApiQuestionsPreview" class="mt-4" style="display: none;">
									<div class="alert alert-info">
										<strong>Fetched Questions:</strong> 
										<span id="instructorFetchedQuestionsCount">0</span> questions found
									</div>
									<div class="mb-3">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="instructorSelectAll" onchange="toggleInstructorAllQuestions()">
												<label class="form-check-label" for="instructorSelectAll">
													<strong>Select All Questions</strong>
												</label>
										</div>
									</div>
									<div id="instructorApiQuestionsList" class="max-height-400 overflow-auto">
										<!-- Questions will be displayed here -->
									</div>
								</div>

								<!-- Loading Spinner -->
								<div id="instructorApiLoadingSpinner" class="text-center py-4" style="display: none;">
									<div class="spinner-border text-primary" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									<p class="mt-2">Fetching questions from API...</p>
								</div>
							</div>
						</div>
					</div>
					<!-- Translation Tab -->
					<div class="tab-pane fade" id="translation" role="tabpanel">
						<div class="card shadow-sm">
							<div class="card-header bg-info text-white">
								<h5 class="card-title mb-0">
									<i class="bi bi-translate me-2"></i>üåç Translate Questions
								</h5>
							</div>
							<div class="card-body">
								<p class="text-muted mb-4">Automatically translate quiz questions to multiple languages using Google Translate API.</p>
								
								<div class="row g-3">
									<div class="col-md-6">
										<label for="translationQuizSelect" class="form-label">Select Quiz</label>
										<select class="form-select" id="translationQuizSelect">
											<option value="">Choose a quiz to translate...</option>
											{% if quizzes is defined %}
												{% for quiz in quizzes %}
													<option value="{{ quiz.id }}">{{ quiz.title }} ({{ quiz.questions|length }} questions)</option>
												{% endfor %}
											{% endif %}
										</select>
									</div>
									<div class="col-md-6">
										<label for="targetLanguageSelect" class="form-label">Target Language</label>
										<select class="form-select" id="targetLanguageSelect">
											<option value="">Select language...</option>
											<option value="fr">üá´üá∑ French</option>
											<option value="es">üá™üá∏ Spanish</option>
											<option value="de">üá©üá™ German</option>
											<option value="it">üáÆüáπ Italian</option>
											<option value="pt">üáµüáπ Portuguese</option>
											<option value="ru">üá∑üá∫ Russian</option>
											<option value="zh">üá®üá≥ Chinese</option>
											<option value="ja">üáØüáµ Japanese</option>
											<option value="ko">üá∞üá∑ Korean</option>
											<option value="ar">üá∏üá¶ Arabic</option>
											<option value="hi">üáÆüá≥ Hindi</option>
										</select>
									</div>
								</div>

								<div class="row g-3 mt-3">
									<div class="col-md-6">
										<label for="sourceLanguageSelect" class="form-label">Source Language (optional)</label>
										<select class="form-select" id="sourceLanguageSelect">
											<option value="">Auto-detect</option>
											<option value="en">English</option>
											<option value="fr">French</option>
											<option value="es">Spanish</option>
											<option value="de">German</option>
											<option value="it">Italian</option>
										</select>
									</div>
									<div class="col-md-6">
										<div class="form-check mt-4">
											<input class="form-check-input" type="checkbox" id="translateOptions" checked>
											<label class="form-check-label" for="translateOptions">
												<strong>Translate Question Options (A, B, C, D)</strong>
											</label>
										</div>
									</div>
								</div>

								<div class="mt-4">
									<button type="button" class="btn btn-outline-info" onclick="loadQuizForTranslation()">
										<i class="bi bi-eye me-2"></i>Load Quiz Questions
									</button>
									<button type="button" class="btn btn-primary" onclick="translateQuiz()" id="translateBtn" disabled>
										<i class="bi bi-translate me-2"></i>Translate Quiz
									</button>
								</div>

								<!-- Quiz Questions Preview -->
								<div id="translationQuizPreview" class="mt-4" style="display: none;">
									<div class="alert alert-info">
										<strong>Quiz Loaded:</strong> 
										<span id="translationQuizTitle">No quiz selected</span> - 
										<span id="translationQuestionCount">0</span> questions
									</div>
									
									<div class="mb-3">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="selectAllQuestions" onchange="toggleAllTranslationQuestions()">
											<label class="form-check-label" for="selectAllQuestions">
												<strong>Select All Questions</strong>
											</label>
										</div>
									</div>
									
									<div id="translationQuestionsList" class="max-height-400 overflow-auto">
										<!-- Quiz questions will be displayed here -->
									</div>
								</div>

								<!-- Translation Progress -->
								<div id="translationProgress" class="mt-4" style="display: none;">
									<div class="card border-info">
										<div class="card-body">
											<h6 class="card-title">Translation Progress</h6>
											<div class="progress mb-3">
												<div class="progress-bar" id="translationProgressBar" role="progressbar" style="width: 0%">
													<span id="translationProgressText">0%</span>
												</div>
											</div>
											<div id="translationStatus" class="text-center">
												<i class="bi bi-hourglass-split me-2"></i>
												<span>Preparing translation...</span>
											</div>
										</div>
									</div>
								</div>

								<!-- Translation Results -->
								<div id="translationResults" class="mt-4" style="display: none;">
									<div class="alert alert-success">
										<h6><i class="bi bi-check-circle me-2"></i>Translation Complete!</h6>
										<p class="mb-0">Successfully translated <span id="translatedCount">0</span> questions to <span id="targetLanguageDisplay">French</span>.</p>
									</div>
									
									<div class="card">
										<div class="card-header bg-success text-white">
											<h6 class="mb-0">Translated Questions Preview</h6>
										</div>
										<div class="card-body">
											<div id="translatedQuestionsList" class="max-height-400 overflow-auto">
												<!-- Translated questions will be displayed here -->
											</div>
										</div>
									</div>
									
									<div class="mt-3">
										<button type="button" class="btn btn-success" onclick="saveTranslatedQuestions()">
											<i class="bi bi-save me-2"></i>Save Translations
										</button>
										<button type="button" class="btn btn-outline-secondary" onclick="resetTranslation()">
											<i class="bi bi-arrow-clockwise me-2"></i>Start New Translation
										</button>
									</div>
								</div>

								<!-- Loading Spinner -->
								<div id="translationLoadingSpinner" class="text-center py-4" style="display: none;">
									<div class="spinner-border text-info" role="status">
										<span class="visually-hidden">Translating...</span>
									</div>
									<p class="mt-2">Translating questions, please wait...</p>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
			<!-- Main content END -->
		</div>
	</div>
</section>
<!-- =======================
Page content END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- Add Quiz Modal -->
<div class="modal fade" id="addQuiz" tabindex="-1" aria-labelledby="addQuizLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-dark">
				<h5 class="modal-title text-white" id="addQuizLabel">Add New Quiz</h5>
				<button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
			</div>
			<div class="modal-body">
				<form id="addQuizForm">
					<div class="mb-3">
						<label for="quizTitle" class="form-label">Quiz Title</label>
						<input type="text" class="form-control" id="quizTitle" name="title" required>
						<div class="invalid-feedback" id="quizTitleError"></div>
					</div>
					<div class="mb-3">
						<label for="quizCourse" class="form-label">Course</label>
						<select class="form-control" id="quizCourse" name="course_id" required>
							<option value="">Select a course</option>
							{% if courses is defined %}
								{% for course in courses %}
									<option value="{{ course.id }}">
										{{ course.title }} 
										{% if course.status == 'published' or course.status == 'live' %}
											‚úÖ {{ course.status|capitalize }}
										{% elseif course.status == 'draft' %}
											üìù {{ course.status|capitalize }}
										{% elseif course.status == 'pending' %}
											‚è≥ {{ course.status|capitalize }}
										{% else %}
											‚è∏Ô∏è {{ course.status|capitalize }}
										{% endif %}
										{% if course.price %}(${{ course.price }}){% endif %}
									</option>
								{% endfor %}
							{% endif %}
						</select>
						<div class="invalid-feedback" id="quizCourseError"></div>
					</div>
					<div class="mb-3">
						<label for="quizDescription" class="form-label">Description</label>
						<textarea class="form-control" id="quizDescription" name="description" rows="3"></textarea>
						<div class="invalid-feedback" id="quizDescriptionError"></div>
					</div>
					
					<!-- Timer Settings Section -->
					<div class="card border-secondary mb-3">
						<div class="card-header bg-light">
							<h6 class="mb-0">
								<i class="fas fa-clock me-2"></i>Param√®tres du Temps
							</h6>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-md-4">
									<label for="quizDuration" class="form-label">
										<i class="fas fa-hourglass-half me-1"></i>Dur√©e (secondes)
									</label>
									<input type="number" class="form-control" id="quizDuration" name="duration" min="1" max="18000" placeholder="ex: 1800">
									<div class="form-text">Laissez vide pour pas de limite de temps (max: 5 heures)</div>
								</div>
								<div class="col-md-4">
									<label for="quizOpeningDate" class="form-label">
										<i class="fas fa-calendar-plus me-1"></i>Date d'Ouverture
									</label>
									<input type="datetime-local" class="form-control" id="quizOpeningDate" name="opening_date">
									<div class="form-text">Quand le quiz devient disponible</div>
								</div>
								<div class="col-md-4">
									<label for="quizClosingDate" class="form-label">
										<i class="fas fa-calendar-times me-1"></i>Date de Fermeture
									</label>
									<input type="datetime-local" class="form-control" id="quizClosingDate" name="closing_date">
									<div class="form-text">Quand le quiz se ferme automatiquement</div>
								</div>
							</div>
							<div class="alert alert-info mt-3">
								<i class="fas fa-info-circle me-2"></i>
								<strong>Information:</strong> Les √©tudiants ne pourront pas acc√©der au quiz avant la date d'ouverture et apr√®s la date de fermeture. Si une dur√©e est d√©finie, le quiz sera soumis automatiquement lorsque le temps expire.
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="addQuiz()">Add Quiz</button>
			</div>
		</div>
	</div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestion" tabindex="-1" aria-labelledby="addQuestionLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header bg-dark">
				<h5 class="modal-title text-white" id="addQuestionLabel">Add Question to Quiz</h5>
				<button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
			</div>
			<div class="modal-body">
				<form id="addQuestionForm">
					<div class="mb-3">
						<label for="questionQuiz" class="form-label">Select Quiz</label>
						<select class="form-control" id="questionQuiz" name="quiz_id" required>
							<option value="">Select a quiz</option>
							{% if quizzes is defined %}
								{% for quiz in quizzes %}
									<option value="{{ quiz.id }}">{{ quiz.title }}</option>
								{% endfor %}
							{% endif %}
						</select>
					</div>
					<div class="mb-3">
						<label for="questionText" class="form-label">Question</label>
						<textarea class="form-control" id="questionText" name="question" placeholder="Enter your question here" rows="3" required></textarea>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="optionA" class="form-label">Option A</label>
								<input type="text" class="form-control" id="optionA" name="option_a" placeholder="Enter option A" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="optionB" class="form-label">Option B</label>
								<input type="text" class="form-control" id="optionB" name="option_b" placeholder="Enter option B" required>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="optionC" class="form-label">Option C</label>
								<input type="text" class="form-control" id="optionC" name="option_c" placeholder="Enter option C" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="optionD" class="form-label">Option D</label>
								<input type="text" class="form-control" id="optionD" name="option_d" placeholder="Enter option D" required>
							</div>
						</div>
					</div>
					<div class="mb-3">
						<label for="correctOption" class="form-label">Correct Option</label>
						<select class="form-control" id="correctOption" name="correct_option" required>
							<option value="">Select correct answer</option>
							<option value="A">Option A</option>
							<option value="B">Option B</option>
							<option value="C">Option C</option>
							<option value="D">Option D</option>
						</select>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="addQuestion()">Add Question</button>
			</div>
		</div>
	</div>
</div>

<!-- Edit Question Modal -->
<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark">
                <h5 class="modal-title text-white" id="editQuestionModalLabel">Edit Question</h5>
                <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <form id="editQuestionForm">
                    <input type="hidden" id="editQuestionId" name="questionId">
                    <input type="hidden" id="editQuizId" name="quizId">
                    
                    <div class="mb-3">
                        <label for="editQuizTitle" class="form-label">Quiz</label>
                        <input type="text" class="form-control" id="editQuizTitle" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editQuestionText" class="form-label">Question <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editQuestionText" name="question" rows="3" required placeholder="Enter your question here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="editQuestionType" id="editMultipleChoice" value="multiple" checked>
                            <label class="btn btn-outline-primary" for="editMultipleChoice">Multiple Choice</label>
                            
                            <input type="radio" class="btn-check" name="editQuestionType" id="editTrueFalse" value="true_false">
                            <label class="btn btn-outline-primary" for="editTrueFalse">True/False</label>
                            
                            <input type="radio" class="btn-check" name="editQuestionType" id="editShortAnswer" value="short_answer">
                            <label class="btn btn-outline-primary" for="editShortAnswer">Short Answer</label>
                        </div>
                    </div>
                    
                    <!-- Multiple Choice Options -->
                    <div id="editMultipleChoiceOptions">
                        <div class="mb-3">
                            <label class="form-label">Options <span class="text-danger">*</span></label>
                            {% if courses is defined %}
                                {% for course in courses %}
                                    <option value="{{ course.id }}">
                                        {{ course.title }} 
                                        {% if course.status == 'active' or course.status == 'live' %}
                                            ‚úÖ {{ course.status|capitalize }}
                                        {% else %}
                                            ‚è∏Ô∏è {{ course.status|capitalize }}
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            {% endif %}
                            <div class="mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">A</span>
                                    <input type="text" class="form-control" name="editOption1" placeholder="Option A">
                                    <div class="input-group-text">
                                        <input class="form-check-input" type="radio" name="editCorrectOption" value="A">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">B</span>
                                    <input type="text" class="form-control" name="editOption2" placeholder="Option B">
                                    <div class="input-group-text">
                                        <input class="form-check-input" type="radio" name="editCorrectOption" value="B">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">C</span>
                                    <input type="text" class="form-control" name="editOption3" placeholder="Option C">
                                    <div class="input-group-text">
                                        <input class="form-check-input" type="radio" name="editCorrectOption" value="C">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">D</span>
                                    <input type="text" class="form-control" name="editOption4" placeholder="Option D">
                                    <div class="input-group-text">
                                        <input class="form-check-input" type="radio" name="editCorrectOption" value="D">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- True/False Options -->
                    <div id="editTrueFalseOptions" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Correct Answer <span class="text-danger">*</span></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="editTfAnswer" id="editTrueAnswer" value="true">
                                <label class="btn btn-outline-success" for="editTrueAnswer">True</label>
                                
                                <input type="radio" class="btn-check" name="editTfAnswer" id="editFalseAnswer" value="false">
                                <label class="btn btn-outline-danger" for="editFalseAnswer">False</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Short Answer -->
                    <div id="editShortAnswerOptions" style="display: none;">
                        <div class="mb-3">
                            <label for="editCorrectAnswer" class="form-label">Correct Answer <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editCorrectAnswer" name="correctAnswer" placeholder="Enter the correct answer">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPoints" class="form-label">Points</label>
                        <input type="text" class="form-control" id="editPoints" name="points" value="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateQuestion()">Update Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Quiz Modal -->
<div class="modal fade" id="editQuizModal" tabindex="-1" aria-labelledby="editQuizModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark">
                <h5 class="modal-title text-white" id="editQuizModalLabel">Edit Quiz</h5>
                <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <!-- Quiz Data Display -->
                <div class="alert alert-info" id="quizDataDisplay">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Quiz Data (Debug)</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleQuizDataDisplay()">
                            <i class="bi bi-eye-slash" id="quizDataToggleIcon"></i> Hide
                        </button>
                    </div>
                    <div id="quizDataContent">
                        Loading quiz data...
                    </div>
                </div>
                
                <form id="editQuizForm">
                    <input type="hidden" id="editQuizId" name="quiz_id">
                    
                    <!-- Quiz Summary -->
                    <div class="card bg-light mb-4" id="quizSummary">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-file-text me-2"></i>Quiz Summary
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Quiz ID:</small>
                                    <div id="summaryQuizId">-</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Created:</small>
                                    <div id="summaryCreated">-</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Last Updated:</small>
                                    <div id="summaryUpdated">-</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Questions:</small>
                                    <div id="summaryQuestions">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editQuizTitle" class="form-label">Quiz Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editQuizTitle" name="title" required placeholder="Enter quiz title">
                        <small class="text-muted" id="editQuizTitleInfo">Loading...</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editQuizCourse" class="form-label">Course</label>
                        <select class="form-control" id="editQuizCourse" name="course_id">
                            <option value="">No Course</option>
                            <!-- Courses will be loaded dynamically -->
                        </select>
                        <small class="text-muted" id="editQuizCourseInfo">Loading...</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editQuizDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editQuizDescription" name="description" rows="3" placeholder="Enter quiz description (optional)"></textarea>
                        <small class="text-muted" id="editQuizDescriptionInfo">Loading...</small>
                    </div>
                    
                    <!-- Timer Settings Section -->
                    <div class="card border-secondary mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Param√®tres du Temps
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="quizDuration" class="form-label">
                                        <i class="fas fa-hourglass-half me-1"></i>Dur√©e (secondes)
                                    </label>
                                    <input type="number" class="form-control" id="quizDuration" name="duration" min="1" max="18000" placeholder="ex: 1800">
                                    <div class="form-text">Laissez vide pour pas de limite de temps (max: 5 heures)</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="editQuizOpeningDate" class="form-label">
                                        <i class="fas fa-calendar-plus me-1"></i>Date d'Ouverture
                                    </label>
                                    <input type="datetime-local" class="form-control" id="editQuizOpeningDate" name="opening_date">
                                    <div class="form-text">Quand le quiz devient disponible</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="editQuizClosingDate" class="form-label">
                                        <i class="fas fa-calendar-times me-1"></i>Date de Fermeture
                                    </label>
                                    <input type="datetime-local" class="form-control" id="editQuizClosingDate" name="closing_date">
                                    <div class="form-text">Quand le quiz se ferme automatiquement</div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Information:</strong> Les √©tudiants ne pourront pas acc√©der au quiz avant la date d'ouverture et apr√®s la date de fermeture. Si une dur√©e est d√©finie, le quiz sera soumis automatiquement lorsque le temps expire.
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editQuizRandomize" name="randomize_questions">
                                    <label class="form-check-label" for="editQuizRandomize">
                                        Randomize question order
                                    </label>
                                </div>
                                <small class="text-muted" id="editQuizRandomizeInfo">Loading...</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editQuizShowResults" name="show_results" checked>
                                    <label class="form-check-label" for="editQuizShowResults">
                                        Show results immediately after completion
                                    </label>
                                </div>
                                <small class="text-muted" id="editQuizShowResultsInfo">Loading...</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information Fields -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-info-circle me-2"></i>Quiz Information
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">Quiz ID</label>
                                    <div class="form-control-plaintext" id="quizIdDisplay">-</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">Created Date</label>
                                    <div class="form-control-plaintext" id="createdDateDisplay">-</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">Last Updated</label>
                                    <div class="form-control-plaintext" id="updatedDateDisplay">-</div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted">Questions Count</label>
                                    <div class="form-control-plaintext" id="questionsCountDisplay">-</div>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small text-muted">Course</label>
                                    <div class="form-control-plaintext" id="courseDisplay">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateQuiz()">Update Quiz</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
				<button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
			</div>
			<div class="modal-body text-center">
				<i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
				<p class="mb-0">Are you sure you want to delete this item?</p>
				<p class="text-muted small mb-0" id="deleteInfo"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block javascripts %}
<script>
// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Load lessons on page load
document.addEventListener('DOMContentLoaded', function() {
    // Auto-run debug when quiz modal is opened
    const addQuizModal = document.getElementById('addQuiz');
    if (addQuizModal) {
        addQuizModal.addEventListener('shown.bs.modal', function () {
            console.log('Quiz modal opened');
        });
    }
    
    // Auto-run debug when edit quiz modal is opened
    const editQuizModal = document.getElementById('editQuizModal');
    if (editQuizModal) {
        editQuizModal.addEventListener('shown.bs.modal', function () {
            console.log('Edit quiz modal opened');
        });
    }
    // loadCourses(); // Removed to prevent overwriting Twig-rendered courses
    initializeSearchAndSort();
});

function initializeSearchAndSort() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.querySelector('select[name="sortBy"]');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterAndSortQuizzes);
    }
    
    if (sortSelect) {
        sortSelect.addEventListener('change', filterAndSortQuizzes);
    }
}

function filterAndSortQuizzes() {
    console.log('=== FILTER AND SORT CALLED ===');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.querySelector('select[name="sortBy"]');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const sortBy = sortSelect ? sortSelect.value : '';
    
    console.log('Search term:', searchTerm);
    console.log('Sort by:', sortBy);
    
    // Get all quiz rows
    const quizRows = document.querySelectorAll('#all-quizzes .quiz-row');
    const questionsRows = document.querySelectorAll('#all-quizzes .questions-row');
    
    console.log('Quiz rows found:', quizRows.length);
    console.log('Questions rows found:', questionsRows.length);
    
    let visibleCount = 0;
    const quizData = [];
    
    // Collect all quiz data
    quizRows.forEach((row, index) => {
        const titleElement = row.querySelector('.quiz-title');
        const title = titleElement ? titleElement.textContent.toLowerCase() : '';
        
        // Get course info
        const courseElements = row.querySelectorAll('.badge');
        let course = '';
        let questionsCount = 0;
        
        courseElements.forEach(badge => {
            const text = badge.textContent.toLowerCase();
            if (text.includes('questions')) {
                questionsCount = parseInt(text) || 0;
            } else if (!text.includes('quiz #')) {
                course = text;
            }
        });
        
        // Get date info
        const dateElement = row.querySelector('.text-muted.small');
        const date = dateElement ? dateElement.textContent : '';
        const originalDate = dateElement ? dateElement.getAttribute('data-date') || date : '';
        
        const questionsRow = questionsRows[index];
        const questionElements = questionsRow ? questionsRow.querySelectorAll('.question-card') : [];
        
        const quizInfo = {
            row: row,
            questionsRow: questionsRow,
            title: title,
            course: course,
            date: date,
            originalDate: originalDate,
            questionsCount: questionsCount,
            questionCount: questionElements.length,
            index: index
        };
        
        quizData.push(quizInfo);
        console.log('Quiz data collected:', quizInfo);
    });
    
    // Filter quizzes
    const filteredQuizzes = quizData.filter(quiz => {
        return quiz.title.includes(searchTerm) ||
               quiz.course.includes(searchTerm) ||
               quiz.date.includes(searchTerm) ||
               quiz.questionCount.toString().includes(searchTerm);
    });
    
    console.log('Filtered quizzes:', filteredQuizzes.length);
    
    // Sort filtered quizzes
    if (sortBy) {
        console.log('Sorting by:', sortBy);
        filteredQuizzes.sort((a, b) => {
            console.log('Comparing:', a.title, 'vs', b.title);
            switch(sortBy) {
                case 'name':
                    return a.title.localeCompare(b.title);
                case 'name-desc':
                    return b.title.localeCompare(a.title);
                case 'date-newest':
                    const dateA = parseQuizDate(a.originalDate);
                    const dateB = parseQuizDate(b.originalDate);
                    console.log('Date comparison:', dateA, dateB, 'Result:', dateB - dateA);
                    return dateB - dateA; // Newest first
                case 'date-oldest':
                    const dateC = parseQuizDate(a.originalDate);
                    const dateD = parseQuizDate(b.originalDate);
                    return dateC - dateD; // Oldest first
                case 'questions':
                    return b.questionsCount - a.questionsCount; // Most questions first
                case 'questions-fewest':
                    return a.questionsCount - b.questionsCount; // Fewest questions first
                case 'course':
                    return a.course.localeCompare(b.course);
                default:
                    return 0;
            }
        });
        console.log('Sorted quizzes:', filteredQuizzes);
    }
    
    // Hide all rows first
    quizRows.forEach(row => row.style.display = 'none');
    questionsRows.forEach(row => row.style.display = 'none');
    
    // Get the table body
    const tableBody = document.querySelector('#all-quizzes tbody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    // Reorder the DOM elements based on sorted data
    filteredQuizzes.forEach((quiz, index) => {
        // Show the quiz row
        quiz.row.style.display = '';
        
        // Show the questions row if it exists
        if (quiz.questionsRow) {
            quiz.questionsRow.style.display = 'table-row';
        }
        
        // Move the quiz row to the correct position in the DOM
        if (quiz.row.parentNode === tableBody) {
            // Move to the end of visible rows
            tableBody.appendChild(quiz.row);
            
            // Move questions row after the quiz row
            if (quiz.questionsRow && quiz.questionsRow.parentNode === tableBody) {
                tableBody.appendChild(quiz.questionsRow);
            }
        }
        
        visibleCount++;
        console.log('Showing quiz:', quiz.title, 'at DOM position', index);
    });
    
    console.log('Total visible quizzes:', visibleCount);
    
    // Update visible count
    updateVisibleCount(visibleCount, quizData.length);
}

function parseQuizDate(dateString) {
    if (!dateString) return new Date(0); // Return epoch date if no date
    
    // Handle the format from template: "M d, Y" (e.g., "Feb 7, 2026")
    const cleanDate = dateString.trim();
    
    // Try to parse the date
    const date = new Date(cleanDate);
    
    // If parsing failed, try alternative formats
    if (isNaN(date.getTime())) {
        // Try parsing with different formats
        const formats = [
            /(\w{3})\s(\d{1,2}),\s(\d{4})/, // "Feb 7, 2026"
            /(\d{1,2})\/(\d{1,2})\/(\d{4})/, // "2/7/2026"
            /(\d{4})-(\d{2})-(\d{2})/, // "2026-02-07"
        ];
        
        for (const regex of formats) {
            const match = cleanDate.match(regex);
            if (match) {
                if (regex === formats[0]) {
                    // "Feb 7, 2026" format
                    return new Date(match[3], getMonthIndex(match[1]), parseInt(match[2]));
                } else if (regex === formats[1]) {
                    // "2/7/2026" format
                    return new Date(match[3], parseInt(match[1]) - 1, parseInt(match[2]));
                } else if (regex === formats[2]) {
                    // "2026-02-07" format
                    return new Date(match[1], parseInt(match[2]) - 1, parseInt(match[3]));
                }
            }
        }
    }
    
    return isNaN(date.getTime()) ? new Date(0) : date;
}

function getMonthIndex(monthName) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months.indexOf(monthName);
}

function updateVisibleCount(visible, total) {
    const visibleCountElement = document.getElementById('visibleCount');
    if (visibleCountElement) {
        visibleCountElement.textContent = visible;
    }
    
    // Update the text showing visible/total
    const countText = document.querySelector('.text-muted.mb-0');
    if (countText) {
        countText.innerHTML = `<span id="visibleCount">${visible}</span> of ${total} quizzes`;
    }
    
    // Show message if no results
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
        let noResultsMessage = tableContainer.querySelector('.no-results-message');
        
        if (visible === 0) {
            if (!noResultsMessage) {
                noResultsMessage = document.createElement('div');
                noResultsMessage.className = 'no-results-message text-center py-5';
                noResultsMessage.innerHTML = `
                    <i class="bi bi-search fs-1 text-muted mb-3"></i>
                    <p class="text-muted">No quizzes found matching your search criteria.</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="clearSearchAndSort()">
                        <i class="bi bi-x-circle me-1"></i> Clear Filters
                    </button>
                `;
                tableContainer.appendChild(noResultsMessage);
            }
        } else {
            if (noResultsMessage) {
                noResultsMessage.remove();
            }
        }
    }
}

function clearSearchAndSort() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.querySelector('select[name="sortBy"]');
    
    if (searchInput) searchInput.value = '';
    if (sortSelect) sortSelect.value = '';
    
    filterAndSortQuizzes();
}

function loadCourses() {
    fetch('/quiz/courses')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('quizCourse');
                if (select) {
                    // Only clear if we have new data to add
                    if (data.courses && data.courses.length > 0) {
                        select.innerHTML = '<option value="">Select a course</option>';
                        data.courses.forEach(course => {
                            const statusIcon = (course.status === 'active' || course.status === 'live') ? '‚úÖ ' + course.status.charAt(0).toUpperCase() + course.status.slice(1) : '‚è∏Ô∏è ' + course.status.charAt(0).toUpperCase() + course.status.slice(1);
                            select.innerHTML += `<option value="${course.id}">${course.title} - ${statusIcon}</option>`;
                        });
                    }
                }
            } else {
                console.warn('Failed to load courses:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading courses:', error);
            // Don't clear the dropdown if API fails - keep existing Twig-rendered courses
        });
}

function addQuiz() {
    // Clear previous errors
    clearQuizErrors();
    
    const form = document.getElementById('addQuizForm');
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        course_id: formData.get('course_id'),
        description: formData.get('description'),
        duration: formData.get('duration') || null,
        opening_date: formData.get('opening_date') || null,
        closing_date: formData.get('closing_date') || null
    };

    fetch('/quiz/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Quiz created successfully!', 'success');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addQuiz'));
            modal.hide();
            
            // Clear the form
            form.reset();
            clearQuizErrors();
            
            // Add the new quiz to the table dynamically
            addQuizToTable(data.quiz);
            
            // Update statistics
            updateQuizStatistics();
            
        } else {
            if (data.message === 'Validation failed' && data.errors) {
                // Display validation errors under each field
                displayQuizValidationErrors(data.errors);
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while creating the quiz', 'danger');
    });
}

function clearQuizErrors() {
    // Clear all error messages
    document.getElementById('quizTitleError').textContent = '';
    document.getElementById('quizCourseError').textContent = '';
    document.getElementById('quizDescriptionError').textContent = '';
    
    // Remove invalid class from all fields
    document.getElementById('quizTitle').classList.remove('is-invalid');
    document.getElementById('quizCourse').classList.remove('is-invalid');
    document.getElementById('quizDescription').classList.remove('is-invalid');
}

function displayQuizValidationErrors(errors) {
    errors.forEach(error => {
        if (error.includes('Quiz title')) {
            document.getElementById('quizTitleError').textContent = error;
            document.getElementById('quizTitle').classList.add('is-invalid');
        } else if (error.includes('Course') || error.includes('course_id')) {
            document.getElementById('quizCourseError').textContent = error;
            document.getElementById('quizCourse').classList.add('is-invalid');
        } else if (error.includes('Description')) {
            document.getElementById('quizDescriptionError').textContent = error;
            document.getElementById('quizDescription').classList.add('is-invalid');
        }
    });
}

// Add event listeners to clear errors when user starts typing
document.addEventListener('DOMContentLoaded', function() {
    // Clear title error when user types
    const titleField = document.getElementById('quizTitle');
    if (titleField) {
        titleField.addEventListener('input', function() {
            document.getElementById('quizTitleError').textContent = '';
            this.classList.remove('is-invalid');
        });
    }
    
    // Clear course error when user selects
    const courseField = document.getElementById('quizCourse');
    if (courseField) {
        courseField.addEventListener('change', function() {
            document.getElementById('quizCourseError').textContent = '';
            this.classList.remove('is-invalid');
        });
    }
    
    // Clear description error when user types
    const descField = document.getElementById('quizDescription');
    if (descField) {
        descField.addEventListener('input', function() {
            document.getElementById('quizDescriptionError').textContent = '';
            this.classList.remove('is-invalid');
        });
    }
});

function updateQuestion() {
    const form = document.getElementById('editQuestionForm');
    const formData = new FormData(form);
    const questionId = formData.get('question_id');
    const data = {
        question: formData.get('question'),
        optionA: formData.get('option_a'),
        optionB: formData.get('option_b'),
        optionC: formData.get('option_c'),
        optionD: formData.get('option_d'),
        correctOption: formData.get('correct_option')
    };

    fetch(`/quiz/question/${questionId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Question updated successfully!', 'success');
            location.reload();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the question', 'danger');
    });
}

function editQuestion(questionId, questionText) {
    // Set question ID immediately
    document.getElementById('editQuestionId').value = questionId;
    
    // Fetch question data
    fetch(`/quiz/question/${questionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const question = data.question;
                
                // Populate form with question data
                document.getElementById('editQuestionText').value = question.text;
                document.getElementById('editQuizTitle').value = question.quiz ? question.quiz.title : 'Unknown Quiz';
                document.getElementById('editQuizId').value = question.quiz ? question.quiz.id : '';
                document.getElementById('editPoints').value = 1; // Default points
                
                // Set question type options
                const questionType = 'multiple'; // Since all questions are multiple choice
                document.querySelector(`input[name="editQuestionType"][value="${questionType}"]`).checked = true;
                showEditQuestionTypeOptions(questionType);
                
                // Set multiple choice options
                document.querySelector('input[name="editOption1"]').value = question.options.A || '';
                document.querySelector('input[name="editOption2"]').value = question.options.B || '';
                document.querySelector('input[name="editOption3"]').value = question.options.C || '';
                document.querySelector('input[name="editOption4"]').value = question.options.D || '';
                
                // Set correct option
                const correctOption = question.correctOption || 'A';
                document.querySelector(`input[name="editCorrectOption"][value="${correctOption}"]`).checked = true;
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
                modal.show();
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while loading the question', 'danger');
        });
}

// Show/Hide Edit Question Type Options
function showEditQuestionTypeOptions(type) {
    // Hide all option sections
    document.getElementById('editMultipleChoiceOptions').style.display = 'none';
    document.getElementById('editTrueFalseOptions').style.display = 'none';
    document.getElementById('editShortAnswerOptions').style.display = 'none';
    
    // Show selected option section
    if (type === 'multiple') {
        document.getElementById('editMultipleChoiceOptions').style.display = 'block';
    } else if (type === 'true_false') {
        document.getElementById('editTrueFalseOptions').style.display = 'block';
    } else if (type === 'short_answer') {
        document.getElementById('editShortAnswerOptions').style.display = 'block';
    }
}

// Handle edit question type change
document.addEventListener('DOMContentLoaded', function() {
    const editQuestionTypeRadios = document.querySelectorAll('input[name="editQuestionType"]');
    editQuestionTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            showEditQuestionTypeOptions(this.value);
        });
    });
});

function updateQuestion() {
    const form = document.getElementById('editQuestionForm');
    const questionId = document.getElementById('editQuestionId').value;
    const quizId = document.getElementById('editQuizId').value;
    
    // Validate question ID
    if (!questionId) {
        showNotification('Question ID not found', 'warning');
        return;
    }
    
    // Get question text
    const questionText = document.getElementById('editQuestionText').value;
    if (!questionText.trim()) {
        showNotification('Question text is required', 'warning');
        document.getElementById('editQuestionText').focus();
        return;
    }
    
    if (questionText.trim().length < 5) {
        showNotification('Question must be at least 5 characters long', 'warning');
        document.getElementById('editQuestionText').focus();
        return;
    }
    
    // Get question type
    const questionType = document.querySelector('input[name="editQuestionType"]:checked').value;
    
    // Prepare data based on question type
    let data = {
        question: questionText,
        quizId: quizId,
        type: questionType
    };
    
    if (questionType === 'multiple') {
        // Multiple choice validation
        const optionA = document.querySelector('input[name="editOption1"]').value.trim();
        const optionB = document.querySelector('input[name="editOption2"]').value.trim();
        const optionC = document.querySelector('input[name="editOption3"]').value.trim();
        const optionD = document.querySelector('input[name="editOption4"]').value.trim();
        const correctOption = document.querySelector('input[name="editCorrectOption"]:checked');
        
        if (!optionA || !optionB) {
            showNotification('Options A and B are required for multiple choice questions', 'warning');
            return;
        }
        
        if (!correctOption) {
            showNotification('Please select the correct option', 'warning');
            return;
        }
        
        data.optionA = optionA;
        data.optionB = optionB;
        data.optionC = optionC;
        data.optionD = optionD;
        data.correctOption = correctOption.value;
        
    } else if (questionType === 'true_false') {
        // True/False validation
        const tfAnswer = document.querySelector('input[name="editTfAnswer"]:checked');
        if (!tfAnswer) {
            showNotification('Please select True or False', 'warning');
            return;
        }
        
        data.correctAnswer = tfAnswer.value;
        
    } else if (questionType === 'short_answer') {
        // Short answer validation
        const correctAnswer = document.getElementById('editCorrectAnswer').value.trim();
        if (!correctAnswer) {
            showNotification('Correct answer is required for short answer questions', 'warning');
            document.getElementById('editCorrectAnswer').focus();
            return;
        }
        
        data.correctAnswer = correctAnswer;
    }
    
    // Get points
    const points = document.getElementById('editPoints').value;
    data.points = parseInt(points) || 1;
    
    // Send update request
    fetch(`/quiz/question/${questionId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editQuestionModal'));
            modal.hide();
            
            // Show success message
            showNotification('Question updated successfully!', 'success');
            
            // Reload page to show updated question
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + (data.message || 'Failed to update question'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the question', 'danger');
    });
}

function deleteQuestion(questionId, questionText) {
    document.getElementById('deleteInfo').textContent = questionText;
    document.getElementById('confirmDeleteBtn').onclick = function() {
        fetch(`/quiz/question/${questionId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Question deleted successfully!', 'success');
                location.reload();
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while deleting the question', 'danger');
        });
    };
    
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function openAddQuestionModal(quizId, quizTitle) {
    // Pre-select the quiz
    document.getElementById('questionQuiz').value = quizId;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addQuestion'));
    modal.show();
}

function viewQuizDetails(quizId) {
    // Toggle questions visibility
    const questionsRow = document.getElementById('questions-' + quizId);
    const chevron = document.getElementById('chevron-' + quizId);
    
    if (questionsRow.style.display === 'none') {
        questionsRow.style.display = 'table-row';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-up');
    } else {
        questionsRow.style.display = 'none';
        chevron.classList.remove('bi-chevron-up');
        chevron.classList.add('bi-chevron-down');
    }
}

function editQuiz(quizId) {
    // Set quiz ID
    document.getElementById('editQuizId').value = quizId;
    
    // Load courses for dropdown
    loadCoursesForEdit();
    
    // Fetch quiz data
    fetch(`/quiz/${quizId}/data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display all fetched data and populate form fields
                displayQuizData(data);
                
                // Set course selection after courses are loaded and data is processed
                setTimeout(() => {
                    if (data.quiz.course && data.quiz.course.id) {
                        const courseSelect = document.getElementById('editQuizCourse');
                        if (courseSelect) {
                            courseSelect.value = data.quiz.course.id;
                            console.log('Course dropdown set to:', data.quiz.course.id);
                        }
                    }
                }, 1000); // Increased delay to ensure courses are loaded
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('editQuizModal'));
                modal.show();
            } else {
                showNotification('Error: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while loading quiz data', 'danger');
        });
}

function displayQuizData(data) {
    console.log('=== DISPLAY QUIZ DATA CALLED ===');
    console.log('Received data:', data);
    console.log('Quiz title:', data.quiz?.title);
    console.log('Quiz course:', data.quiz?.course);
    
    const dataContent = document.getElementById('quizDataContent');
    
    // Populate summary section
    document.getElementById('summaryQuizId').textContent = data.quiz.id || 'N/A';
    document.getElementById('summaryCreated').textContent = data.quiz.createdAt || 'N/A';
    document.getElementById('summaryUpdated').textContent = data.quiz.updatedAt || 'Never';
    document.getElementById('summaryQuestions').textContent = data.quiz.questionsCount || '0';
    
    // Populate form fields with actual data
    const titleField = document.getElementById('editQuizTitle');
    const titleInfo = document.getElementById('editQuizTitleInfo');
    console.log('Title field element:', titleField);
    console.log('Title info element:', titleInfo);
    console.log('Quiz title data:', data.quiz.title);
    
    if (titleField && data.quiz.title) {
        titleField.value = data.quiz.title;
        titleInfo.textContent = 'Current: ' + data.quiz.title;
        console.log('Title field set to:', titleField.value);
        console.log('Title field value after setting:', document.getElementById('editQuizTitle').value);
    } else {
        titleInfo.textContent = 'No title set';
        console.log('Title field not populated - field exists:', !!titleField, 'data exists:', !!data.quiz.title);
    }
    
    const descField = document.getElementById('editQuizDescription');
    const descInfo = document.getElementById('editQuizDescriptionInfo');
    console.log('Description field element:', descField);
    console.log('Quiz description data:', data.quiz.description);
    
    if (descField && data.quiz.description) {
        descField.value = data.quiz.description;
        descInfo.textContent = 'Current: ' + (data.quiz.description.length > 50 ? data.quiz.description.substring(0, 50) + '...' : data.quiz.description);
        console.log('Description field set to:', descField.value);
    } else {
        descInfo.textContent = 'No description set';
        console.log('Description field not populated - field exists:', !!descField, 'data exists:', !!data.quiz.description);
    }
    
    const timeLimitField = document.getElementById('editQuizTimeLimit');
    const timeLimitInfo = document.getElementById('editQuizTimeLimitInfo');
    if (timeLimitField && data.quiz.timeLimit) {
        timeLimitField.value = data.quiz.timeLimit;
        timeLimitInfo.textContent = 'Current: ' + data.quiz.timeLimit + ' minutes';
        console.log('Time limit field populated with:', data.quiz.timeLimit);
    } else {
        timeLimitInfo.textContent = 'No time limit set';
        console.log('Time limit field not populated - no time limit data');
    }
    
    // Handle new timer fields
    const durationField = document.getElementById('editQuizDuration');
    if (durationField && data.quiz.duration) {
        durationField.value = data.quiz.duration;
        console.log('Duration field populated with:', data.quiz.duration);
    }
    
    const openingDateField = document.getElementById('editQuizOpeningDate');
    if (openingDateField && data.quiz.opening_date) {
        // Convert datetime to proper format for datetime-local input
        const openingDate = new Date(data.quiz.opening_date);
        const formattedDate = openingDate.toISOString().slice(0, 16);
        openingDateField.value = formattedDate;
        console.log('Opening date field populated with:', formattedDate);
    }
    
    const closingDateField = document.getElementById('editQuizClosingDate');
    if (closingDateField && data.quiz.closing_date) {
        // Convert datetime to proper format for datetime-local input
        const closingDate = new Date(data.quiz.closing_date);
        const formattedDate = closingDate.toISOString().slice(0, 16);
        closingDateField.value = formattedDate;
        console.log('Closing date field populated with:', formattedDate);
    }
    
    const passingScoreField = document.getElementById('editQuizPassingScore');
    const passingScoreInfo = document.getElementById('editQuizPassingScoreInfo');
    if (passingScoreField) {
        passingScoreField.value = data.quiz.passingScore || 70;
        passingScoreInfo.textContent = 'Current: ' + (data.quiz.passingScore || 70) + '%';
        console.log('Passing score field populated with:', data.quiz.passingScore || 70);
    }
    
    const attemptsField = document.getElementById('editQuizAttempts');
    const attemptsInfo = document.getElementById('editQuizAttemptsInfo');
    if (attemptsField) {
        attemptsField.value = data.quiz.maxAttempts || 3;
        attemptsInfo.textContent = 'Current: ' + (data.quiz.maxAttempts || 3) + ' attempts';
        console.log('Attempts field populated with:', data.quiz.maxAttempts || 3);
    }
    
    const randomizeField = document.getElementById('editQuizRandomize');
    const randomizeInfo = document.getElementById('editQuizRandomizeInfo');
    if (randomizeField) {
        randomizeField.checked = data.quiz.randomizeQuestions || false;
        randomizeInfo.textContent = 'Current: ' + (data.quiz.randomizeQuestions ? 'Enabled' : 'Disabled');
        console.log('Randomize field populated with:', data.quiz.randomizeQuestions);
    }
    
    const showResultsField = document.getElementById('editQuizShowResults');
    const showResultsInfo = document.getElementById('editQuizShowResultsInfo');
    if (showResultsField) {
        showResultsField.checked = data.quiz.showResults !== false;
        showResultsInfo.textContent = 'Current: ' + (data.quiz.showResults !== false ? 'Show results' : 'Hide results');
        console.log('Show results field populated with:', data.quiz.showResults !== false);
    }
    
    // Populate information display fields
    document.getElementById('quizIdDisplay').textContent = data.quiz.id || 'N/A';
    document.getElementById('createdDateDisplay').textContent = data.quiz.createdAt || 'N/A';
    document.getElementById('updatedDateDisplay').textContent = data.quiz.updatedAt || 'Never';
    document.getElementById('questionsCountDisplay').textContent = data.quiz.questionsCount || '0';
    
    const courseDisplay = document.getElementById('courseDisplay');
    const courseInfo = document.getElementById('editQuizCourseInfo');
    const courseSelect = document.getElementById('editQuizCourse');
    
    console.log('Course display element:', courseDisplay);
    console.log('Course info element:', courseInfo);
    console.log('Course select element:', courseSelect);
    console.log('Quiz course data:', data.quiz.course);
    
    if (data.quiz.course) {
        courseDisplay.textContent = data.quiz.course.title + ' (ID: ' + data.quiz.course.id + ')';
        courseInfo.textContent = 'Current: ' + data.quiz.course.title;
        
        // Try to set course dropdown value
        if (courseSelect) {
            courseSelect.value = data.quiz.course.id;
            console.log('Course dropdown set to:', data.quiz.course.id);
            console.log('Course dropdown value after setting:', courseSelect.value);
            console.log('Course dropdown options:', courseSelect.options);
        } else {
            console.log('Course dropdown element not found');
        }
        
        console.log('Course info populated with:', data.quiz.course.title);
    } else {
        courseDisplay.textContent = 'No course assigned';
        courseInfo.textContent = 'No course assigned';
        console.log('Course info not populated - no course data');
    }
    
    // Debug section content
    let html = '<div class="row">';
    
    // Basic Quiz Info
    html += '<div class="col-md-6"><strong>Quiz ID:</strong> ' + (data.quiz.id || 'N/A') + '</div>';
    html += '<div class="col-md-6"><strong>Title:</strong> ' + (data.quiz.title || 'N/A') + '</div>';
    html += '<div class="col-md-6"><strong>Description:</strong> ' + (data.quiz.description || 'None') + '</div>';
    html += '<div class="col-md-6"><strong>Created:</strong> ' + (data.quiz.createdAt || 'N/A') + '</div>';
    html += '<div class="col-md-6"><strong>Updated:</strong> ' + (data.quiz.updatedAt || 'Never') + '</div>';
    
    // Course Info
    if (data.quiz.course) {
        html += '<div class="col-md-6"><strong>Course ID:</strong> ' + data.quiz.course.id + '</div>';
        html += '<div class="col-md-6"><strong>Course Title:</strong> ' + data.quiz.course.title + '</div>';
    } else {
        html += '<div class="col-md-12"><strong>Course:</strong> No course assigned</div>';
    }
    
    // Quiz Settings
    html += '<div class="col-md-6"><strong>Time Limit:</strong> ' + (data.quiz.timeLimit || 'No limit') + ' minutes</div>';
    html += '<div class="col-md-6"><strong>Passing Score:</strong> ' + (data.quiz.passingScore || 70) + '%</div>';
    html += '<div class="col-md-6"><strong>Max Attempts:</strong> ' + (data.quiz.maxAttempts || 3) + '</div>';
    html += '<div class="col-md-6"><strong>Randomize:</strong> ' + (data.quiz.randomizeQuestions ? 'Yes' : 'No') + '</div>';
    html += '<div class="col-md-6"><strong>Show Results:</strong> ' + (data.quiz.showResults !== false ? 'Yes' : 'No') + '</div>';
    
    html += '</div>';
    
    // Questions Count (if available)
    if (data.quiz.questionsCount !== undefined) {
        html += '<div class="mt-2"><strong>Questions Count:</strong> ' + data.quiz.questionsCount + '</div>';
    }
    
    // Raw JSON for debugging
    html += '<details class="mt-3"><summary>Raw JSON Data</summary><pre class="bg-light p-2 rounded" style="font-size: 12px; max-height: 200px; overflow-y: auto;">' + JSON.stringify(data, null, 2) + '</pre></details>';
    
    dataContent.innerHTML = html;
    console.log('=== DISPLAY QUIZ DATA COMPLETED ===');
}

function toggleQuizDataDisplay() {
    const dataContent = document.getElementById('quizDataContent');
    const toggleIcon = document.getElementById('quizDataToggleIcon');
    const toggleButton = toggleIcon.parentElement;
    
    if (dataContent.style.display === 'none') {
        dataContent.style.display = 'block';
        toggleIcon.className = 'bi bi-eye-slash';
        toggleButton.innerHTML = '<i class="bi bi-eye-slash" id="quizDataToggleIcon"></i> Hide';
    } else {
        dataContent.style.display = 'none';
        toggleIcon.className = 'bi bi-eye';
        toggleButton.innerHTML = '<i class="bi bi-eye" id="quizDataToggleIcon"></i> Show';
    }
}

function loadCoursesForEdit() {
    console.log('=== LOAD COURSES FOR EDIT CALLED ===');
    fetch('/quiz/courses')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            if (data.success) {
                const select = document.getElementById('editQuizCourse');
                console.log('Edit select found:', !!select);
                if (select) {
                    console.log('Before clearing - Select HTML:', select.innerHTML);
                    select.innerHTML = '<option value="">No Course</option>';
                    data.courses.forEach(course => {
                        const statusIcon = (course.status === 'active' || course.status === 'live') ? '‚úÖ ' + course.status.charAt(0).toUpperCase() + course.status.slice(1) : '‚è∏Ô∏è ' + course.status.charAt(0).toUpperCase() + course.status.slice(1);
                        select.innerHTML += `<option value="${course.id}">${course.title} - ${statusIcon}</option>`;
                    });
                    console.log('After adding - Select HTML:', select.innerHTML);
                }
            }
        })
        .catch(error => {
            console.error('Error loading courses:', error);
        });
}

function updateQuiz() {
    const form = document.getElementById('editQuizForm');
    const quizId = document.getElementById('editQuizId').value;
    
    if (!quizId) {
        showNotification('Quiz ID not found', 'warning');
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        course_id: formData.get('course_id') || null,
        description: formData.get('description'),
        time_limit: formData.get('time_limit') || null,
        passing_score: formData.get('passing_score') || 70,
        max_attempts: formData.get('max_attempts') || 3,
        randomize_questions: formData.get('randomize_questions') === 'on',
        show_results: formData.get('show_results') === 'on'
    };
    
    // Validate required fields
    if (!data.title || data.title.trim().length < 3) {
        showNotification('Quiz title must be at least 3 characters long', 'warning');
        document.getElementById('editQuizTitle').focus();
        return;
    }
    
    // Send update request
    fetch(`/quiz/${quizId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editQuizModal'));
            modal.hide();
            
            // Show success message
            showNotification('Quiz updated successfully!', 'success');
            
            // Reload page to show updated quiz
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Error: ' + (data.message || 'Failed to update quiz'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the quiz', 'danger');
    });
}

function deleteQuiz(quizId) {
    // Show modern confirmation dialog
    showDeleteQuizConfirmation(quizId);
}

function showDeleteQuizConfirmation(quizId) {
    const dialog = document.createElement('div');
    dialog.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" id="deleteQuizConfirmModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeDeleteQuizDialog()"></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                        <p class="mb-0">Are you sure you want to delete this quiz?</p>
                        <p class="text-muted small mb-0">This action cannot be undone and will also delete all questions in this quiz.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeDeleteQuizDialog()">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteQuiz(${quizId})">Delete Quiz</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
}

function closeDeleteQuizDialog() {
    const dialog = document.getElementById('deleteQuizConfirmModal');
    if (dialog) {
        dialog.remove();
    }
}

function confirmDeleteQuiz(quizId) {
    closeDeleteQuizDialog();
    
    fetch(`/quiz/${quizId}/delete`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Quiz deleted successfully!', 'success');
            location.reload();
        } else {
            showNotification('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the quiz', 'danger');
    });
}

function refreshResults() {
    location.reload();
}

function testSorting() {
    console.log('=== TEST SORTING CALLED ===');
    
    // Set the sort dropdown to a test value
    const sortSelect = document.querySelector('select[name="sortBy"]');
    if (sortSelect) {
        sortSelect.value = 'name';
        console.log('Set sort dropdown to:', sortSelect.value);
    }
    
    // Trigger the sorting function
    filterAndSortQuizzes();
}

function exportResults() {
    // Ask user for export format using modern notification instead of confirm
    showExportChoiceDialog();
}

function showExportChoiceDialog() {
    // Create modern export choice dialog
    const dialog = document.createElement('div');
    dialog.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" id="exportChoiceModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Choose Export Format</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="closeExportDialog()"></button>
                    </div>
                    <div class="modal-body">
                        <p>Select your preferred export format:</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" onclick="selectExportFormat('pdf')">
                                <i class="bi bi-file-earmark-pdf me-2"></i>
                                Beautiful PDF Report
                                <small class="d-block text-white-50">Professional design with styling</small>
                            </button>
                            <button class="btn btn-outline-secondary btn-lg" onclick="selectExportFormat('csv')">
                                <i class="bi bi-file-earmark-excel me-2"></i>
                                CSV Data Export
                                <small class="d-block text-muted">Raw data for spreadsheets</small>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeExportDialog()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
}

function closeExportDialog() {
    const dialog = document.getElementById('exportChoiceModal');
    if (dialog) {
        dialog.remove();
    }
}

function selectExportFormat(format) {
    closeExportDialog();
    if (format === 'pdf') {
        exportToPDF();
    } else {
        exportToCSV();
    }
}

function exportToPDF() {
    // Show loading message
    const loadingMsg = document.createElement('div');
    loadingMsg.innerHTML = '<div class="alert alert-info"><i class="bi bi-file-earmark-text me-2"></i>Generating beautiful HTML report... Please wait.</div>';
    document.querySelector('.container').prepend(loadingMsg);
    
    fetch('/quiz/export/pdf')
        .then(response => {
            if (!response.ok) {
                throw new Error('PDF export failed');
            }
            return response.blob();
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename with current timestamp
            const now = new Date();
            const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + '-' + 
                            String(now.getHours()).padStart(2, '0') + '-' + 
                            String(now.getMinutes()).padStart(2, '0') + '-' + 
                            String(now.getSeconds()).padStart(2, '0');
            
            a.download = `quiz-report-${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Remove loading message
            loadingMsg.remove();
            
            // Show success message with file info
            const successMsg = document.createElement('div');
            successMsg.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Success!</strong> Beautiful HTML report generated and downloaded!<br>
                    <small>File: quiz-report-${timestamp}.html</small><br>
                    <small>The HTML file has also been saved to: /public/exports/</small>
                </div>`;
            document.querySelector('.container').prepend(successMsg);
            
            // Auto-remove success message after 5 seconds
            setTimeout(() => successMsg.remove(), 5000);
        })
        .catch(error => {
            console.error('PDF Export error:', error);
            loadingMsg.remove();
            showNotification('Failed to generate HTML report. Please try again.', 'danger');
        });
}

function exportToCSV() {
    // Get all quizzes data
    fetch('/quiz/export')
        .then(response => {
            if (!response.ok) {
                throw new Error('Export failed');
            }
            return response.blob();
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Show success message
            showNotification('Quiz data exported successfully!', 'success');
        })
        .catch(error => {
            console.error('Export error:', error);
            showNotification('Failed to export quiz data. Please try again.', 'danger');
        });
}

// Dynamic Quiz Addition Functions
function addQuizToTable(quiz) {
    const tbody = document.querySelector('#all-quizzes tbody');
    if (!tbody) return;
    
    // Check if "No quizzes found" message exists and remove it
    const noQuizzesRow = tbody.querySelector('td[colspan="5"]');
    if (noQuizzesRow) {
        noQuizzesRow.closest('tr').remove();
    }
    
    // Get course name from the API response
    const courseName = quiz.course_title || 'No Course';
    const courseStatus = quiz.course_status || 'unknown';
    
    // Create status badge based on course status
    let courseBadge = 'bg-secondary';
    if (courseStatus === 'active' || courseStatus === 'live') {
        courseBadge = 'bg-success-subtle text-success';
    } else if (courseStatus === 'inactive') {
        courseBadge = 'bg-warning-subtle text-warning';
    }
    
    // Create new quiz row HTML
    const quizRow = document.createElement('tr');
    quizRow.setAttribute('data-quiz-id', quiz.id);
    quizRow.className = 'clickable-row';
    quizRow.innerHTML = `
        <td onclick="viewQuizDetails(${quiz.id})">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong class="text-dark quiz-title">${quiz.title}</strong>
                    <br>
                    <small class="text-muted">Quiz #${quiz.id}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary-subtle text-primary me-2">0 Questions</span>
                    <i class="bi bi-chevron-down text-muted" id="chevron-${quiz.id}"></i>
                </div>
            </div>
        </td>
        <td>
            <span class="badge bg-info-subtle text-info">0</span>
        </td>
        <td>
            <span class="badge ${courseBadge}">${courseName}</span>
        </td>
        <td>
            <span class="text-muted small">${new Date(quiz.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
        </td>
        <td>
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editQuiz(${quiz.id})" title="Edit Quiz">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="event.stopPropagation(); openAddQuestionModal(${quiz.id}, '${quiz.title.replace(/'/g, "\\'")}')" title="Add Question">
                    <i class="bi bi-plus"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteQuiz(${quiz.id})" title="Delete Quiz">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    // Create questions row (hidden by default)
    const questionsRow = document.createElement('tr');
    questionsRow.id = `questions-${quiz.id}`;
    questionsRow.style.display = 'none';
    questionsRow.innerHTML = `
        <td colspan="5" class="p-0">
            <div class="bg-light p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-list-ul me-2"></i>
                        Questions for ${quiz.title}
                    </h6>
                    <span class="badge bg-secondary">0 Questions</span>
                </div>
                <div class="text-center py-5">
                    <i class="bi bi-question-circle fs-1 text-muted mb-3"></i>
                    <p class="text-muted mb-3">No questions added yet</p>
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAddQuestionModal(${quiz.id}, '${quiz.title.replace(/'/g, "\\'")}')">
                        <i class="bi bi-plus-circle me-1"></i> Add First Question
                    </button>
                </div>
            </div>
        </td>
    `;
    
    // Add both rows to the table
    tbody.appendChild(quizRow);
    tbody.appendChild(questionsRow);
    
    // Add click event listener to the new row
    quizRow.addEventListener('click', function() {
        viewQuizDetails(quiz.id);
    });
    
    // Show success animation
    quizRow.style.backgroundColor = '#d4edda';
    setTimeout(() => {
        quizRow.style.backgroundColor = '';
    }, 2000);
}

function updateQuizStatistics() {
    // Update total questions count
    const totalQuestionsElement = document.querySelector('.badge.bg-warning-subtle');
    if (totalQuestionsElement) {
        const currentTotal = parseInt(totalQuestionsElement.textContent) || 0;
        totalQuestionsElement.textContent = currentTotal;
    }
    
    // Update total attempts count (remains same for new quiz)
    const totalAttemptsElement = document.querySelector('.badge.bg-info-subtle');
    if (totalAttemptsElement) {
        // Attempts count stays the same
    }
    
    // Update average score (remains same for new quiz)
    const averageScoreElement = document.querySelector('.badge.bg-success-subtle');
    if (averageScoreElement) {
        // Average score stays the same
    }
    
    // Update quiz count in statistics
    const quizCountElements = document.querySelectorAll('.badge.bg-purple-subtle');
    quizCountElements.forEach(element => {
        if (element.textContent.includes('Quizzes')) {
            const currentCount = parseInt(element.textContent.match(/\d+/)?.[0]) || 0;
            element.innerHTML = `<i class="fas fa-book me-1"></i>${currentCount + 1} Quizzes`;
        }
    });
}

// ==================== QUIZ MANAGEMENT FUNCTIONS ====================

let instructorFetchedQuestions = [];

// Initialize categories on page load
document.addEventListener('DOMContentLoaded', function() {
    // loadInstructorCategories(); // Temporairement d√©sactiv√© - route API non disponible
});

function editQuiz(quizId) {
    // Set quiz ID
    document.getElementById('editQuizId').value = quizId;
    
    // Load courses for dropdown
    loadCoursesForEdit();
    
    // Fetch quiz data
    fetch(`/quiz/${quizId}/data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display all fetched data and populate form fields
                displayQuizData(data);
                
                // Set course selection after courses are loaded and data is processed
                setTimeout(() => {
                    if (data.quiz.course && data.quiz.course.id) {
                        const courseSelect = document.getElementById('editQuizCourse');
                        if (courseSelect) {
                            courseSelect.value = data.quiz.course.id;
                            console.log('Course dropdown set to:', data.quiz.course.id);
                        }
                    }
                }, 1000); // Increased delay to ensure courses are loaded
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error loading quiz data', 'danger');
        });
}

function displayQuizData(data) {
    console.log('=== DISPLAY QUIZ DATA CALLED ===');
    console.log('Quiz data:', data);
    
    // Populate form fields
    document.getElementById('editQuizTitle').value = data.quiz.title || '';
    document.getElementById('editQuizDescription').value = data.quiz.description || '';
    document.getElementById('editQuizTimeLimit').value = data.quiz.time_limit || '';
    document.getElementById('editQuizPassingScore').value = data.quiz.passing_score || 70;
    document.getElementById('editQuizAttempts').value = data.quiz.max_attempts || 3;
    document.getElementById('editQuizRandomize').checked = data.quiz.randomize_questions || false;
    document.getElementById('editQuizShowResults').checked = data.quiz.show_results || true;
}

function loadCoursesForEdit() {
    console.log('=== LOAD COURSES FOR EDIT CALLED ===');
    fetch('/quiz/courses')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            if (data.success) {
                const select = document.getElementById('editQuizCourse');
                console.log('Edit select found:', !!select);
                if (select) {
                    select.innerHTML = '<option value="">No Course</option>';
                    data.courses.forEach(course => {
                        const statusIcon = (course.status === 'active' || course.status === 'live') ? '‚úÖ ' + course.status.charAt(0).toUpperCase() + course.status.slice(1) : '‚è∏Ô∏è ' + course.status.charAt(0).toUpperCase() + course.status.slice(1);
                        select.innerHTML += `<option value="${course.id}">${course.title} - ${statusIcon}</option>`;
                    });
                    console.log('After adding - Select HTML:', select.innerHTML);
                }
            }
        })
        .catch(error => {
            console.error('Error loading courses:', error);
        });
}

function updateQuiz() {
    const form = document.getElementById('editQuizForm');
    const quizId = document.getElementById('editQuizId').value;
    
    if (!quizId) {
        showNotification('Quiz ID not found', 'warning');
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        course_id: formData.get('course_id') || null,
        description: formData.get('description'),
        time_limit: formData.get('time_limit') || null,
        passing_score: formData.get('passing_score') || 70,
        max_attempts: formData.get('max_attempts') || 3,
        randomize_questions: formData.get('randomize_questions') === 'on',
        show_results: formData.get('show_results') === 'on'
    };
    
    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
    }
    
    fetch(`/quiz/${quizId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Changes';
        }
        
        if (data.success) {
            showNotification('Quiz updated successfully!', 'success');
            // Close modal after successful update
            const modal = bootstrap.Modal.getInstance(document.getElementById('editQuizModal'));
            if (modal) {
                modal.hide();
            }
            // Refresh quiz list
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification(data.message || 'Failed to update quiz', 'danger');
        }
    })
    .catch(error => {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Changes';
        }
        console.error('Error:', error);
        showNotification('Error updating quiz', 'danger');
    });
}

function deleteQuiz(quizId, quizTitle) {
    if (!confirm(`Are you sure you want to delete the quiz "${quizTitle}"? This action cannot be undone.`)) {
        return;
    }
    
    fetch(`/quiz/${quizId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Quiz deleted successfully!', 'success');
            // Remove quiz row from table
            const quizRow = document.querySelector(`[data-quiz-id="${quizId}"]`);
            if (quizRow) {
                quizRow.remove();
            }
            // Update statistics
            updateQuizStatistics();
        } else {
            showNotification(data.message || 'Failed to delete quiz', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting quiz', 'danger');
    });
}

function openAddQuestionModal(quizId, quizTitle) {
    // Set quiz ID in the modal
    document.getElementById('questionQuiz').value = quizId;
    
    // Update modal title
    const modalTitle = document.getElementById('addQuestionLabel');
    if (modalTitle) {
        modalTitle.textContent = `Add Question to ${quizTitle}`;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addQuestion'));
    if (modal) {
        modal.show();
    }
}

function addQuestion() {
    const form = document.getElementById('addQuestionForm');
    const quizId = document.getElementById('questionQuiz').value;
    
    if (!quizId) {
        showNotification('Please select a quiz first', 'warning');
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    const data = {
        quiz_id: quizId,
        question: formData.get('question'),
        option_a: formData.get('option_a'),
        option_b: formData.get('option_b'),
        option_c: formData.get('option_c'),
        option_d: formData.get('option_d'),
        correct_option: formData.get('correct_option')
    };
    
    // Validate required fields
    if (!data.question || !data.option_a || !data.option_b || !data.option_c || !data.option_d || !data.correct_option) {
        showNotification('Please fill in all required fields', 'warning');
        return;
    }
    
    // Validate question length (minimum 5 characters as per entity validation)
    if (data.question.trim().length < 5) {
        showNotification('Question must be at least 5 characters long', 'warning');
        return;
    }
    
    // Validate option lengths (minimum 1 character as per entity validation)
    if (data.option_a.trim().length < 1 || data.option_b.trim().length < 1 || 
        data.option_c.trim().length < 1 || data.option_d.trim().length < 1) {
        showNotification('All options must have at least 1 character', 'warning');
        return;
    }
    
    // Validate correct option value
    if (!['A', 'B', 'C', 'D'].includes(data.correct_option)) {
        showNotification('Correct option must be A, B, C, or D', 'warning');
        return;
    }
    
    // Show loading
    const submitBtn = document.querySelector('#addQuestion .btn-primary');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Adding...';
    }
    
    // Debug: Log the data being sent
    console.log('Sending question data:', data);
    
    fetch('/quiz/question/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        return response.json();
    })
    .then(data => {
        const submitBtn = document.querySelector('#addQuestion .btn-primary');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Question';
        }
        
        if (data.success) {
            showNotification('Question added successfully!', 'success');
            // Clear form
            form.reset();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addQuestion'));
            if (modal) {
                modal.hide();
            }
            // Refresh quiz list
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            console.error('Server response error:', data);
            showNotification(data.message || 'Failed to add question', 'danger');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        const submitBtn = document.querySelector('#addQuestion .btn-primary');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Question';
        }
        console.error('Error:', error);
        showNotification('Error adding question', 'danger');
    });
}

function editQuestion(questionId, questionText) {
    // This would open the edit modal with the question data
    // For now, just show a notification
    showNotification(`Edit question: ${questionText} (ID: ${questionId})`, 'info');
}

function deleteQuestion(questionId, questionText) {
    if (!confirm(`Are you sure you want to delete this question: "${questionText}"?`)) {
        return;
    }
    
    fetch(`/quiz/question/${questionId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Question deleted successfully!', 'success');
            // Refresh quiz list
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.message || 'Failed to delete question', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting question', 'danger');
    });
}

function refreshResults() {
    showNotification('Refreshing quiz list...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function exportResults() {
    showNotification('Exporting quiz data...', 'info');
    fetch('/quiz/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification('Quiz data exported successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error exporting quiz data', 'danger');
        });
}

function testSorting() {
    showNotification('Sorting functionality would be implemented here', 'info');
}
// ==================== INSTRUCTOR API QUESTIONS IMPORT ====================
function loadInstructorCategories() {
    fetch('/api/categories') // badel route si n√©cessaire
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const categorySelect = document.getElementById('instructorCategorySelect');
                categorySelect.innerHTML = '<option value="">Any Category</option>';
                
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
        });
}

// Fetch questions from API for instructor
function fetchInstructorQuestions() {
    const amount = document.getElementById('instructorQuestionAmount').value;
    const category = document.getElementById('instructorCategorySelect').value;
    const difficulty = document.getElementById('instructorDifficultySelect').value;
    const type = document.getElementById('instructorTypeSelect').value;

    if (!amount || amount < 1 || amount > 50) {
        showNotification('Please enter a valid number of questions (1-50)', 'error');
        return;
    }

    // Show loading spinner
    document.getElementById('instructorApiLoadingSpinner').style.display = 'block';

    const requestData = {
        amount: parseInt(amount)
    };

    if (category) requestData.category = category;
    if (difficulty) requestData.difficulty = difficulty;
    if (type) requestData.type = type;

    // Call Vertex AI API instead of using sample questions
    fetch('/quiz/api/fetch-questions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('instructorApiLoadingSpinner').style.display = 'none';
        
        if (data.success) {
            instructorFetchedQuestions = data.questions || [];
            displayInstructorApiQuestions();
            showNotification(`Successfully generated ${instructorFetchedQuestions.length} questions using Gemini AI!`, 'success');
        } else {
            showNotification('Failed to generate questions: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        document.getElementById('instructorApiLoadingSpinner').style.display = 'none';
        console.error('Error fetching questions:', error);
        showNotification('Error generating questions. Please try again.', 'error');
    });
}

// Display fetched API questions for instructor
function displayInstructorApiQuestions() {
    const questionsList = document.getElementById('instructorApiQuestionsList');
    const questionsPreview = document.getElementById('instructorApiQuestionsPreview');
    const fetchedCount = document.getElementById('instructorFetchedQuestionsCount');
    const importBtn = document.getElementById('instructorImportBtn');
    
    if (instructorFetchedQuestions.length === 0) {
        questionsList.innerHTML = '<p class="text-muted text-center">No questions found.</p>';
        questionsPreview.style.display = 'none';
        importBtn.disabled = true;
        return;
    }

    fetchedCount.textContent = instructorFetchedQuestions.length;
    questionsPreview.style.display = 'block';
    importBtn.disabled = false;
    
    let html = '<div class="list-group">';
    instructorFetchedQuestions.forEach((question, index) => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Question ${index + 1}</h6>
                        <p class="mb-2">${question.question}</p>
                        <div class="small text-muted">
                            <span class="badge bg-primary me-1">${question.category}</span>
                            <span class="badge bg-secondary me-1">${question.difficulty}</span>
                            <span class="badge bg-info">${question.type}</span>
                        </div>
                        <div class="mt-2">
                            <small><strong>Correct Answer:</strong> ${question.correct_option}</small>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${index}" id="instructorApiQuestion_${index}" checked>
                        <label class="form-check-label" for="instructorApiQuestion_${index}"></label>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    questionsList.innerHTML = html;
}

// Toggle all instructor questions selection
function toggleInstructorAllQuestions() {
    const selectAll = document.getElementById('instructorSelectAll');
    const checkboxes = document.querySelectorAll('#instructorApiQuestionsList input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateInstructorImportButton();
}

// Update instructor import button state
function updateInstructorImportButton() {
    const checkedBoxes = document.querySelectorAll('#instructorApiQuestionsList input[type="checkbox"]:checked');
    const importBtn = document.getElementById('instructorImportBtn');
    
    importBtn.disabled = checkedBoxes.length === 0;
    if (checkedBoxes.length > 0) {
        importBtn.innerHTML = `<i class="bi bi-download me-2"></i>Import ${checkedBoxes.length} Question${checkedBoxes.length > 1 ? 's' : ''}`;
    } else {
        importBtn.innerHTML = '<i class="bi bi-download me-2"></i>Import Selected Questions';
    }
}

// Import selected questions to instructor quiz
function importInstructorQuestions() {
    const quizId = document.getElementById('instructorQuizSelect').value;
    const checkedBoxes = document.querySelectorAll('#instructorApiQuestionsList input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        showNotification('Please select at least one question to import', 'warning');
        return;
    }

    const selectedQuestions = [];
    checkedBoxes.forEach(checkbox => {
        const questionIndex = parseInt(checkbox.value);
        if (instructorFetchedQuestions && instructorFetchedQuestions[questionIndex]) {
            selectedQuestions.push(instructorFetchedQuestions[questionIndex]);
        }
    });

    // Show loading
    const importBtn = document.getElementById('instructorImportBtn');
    const originalText = importBtn.innerHTML;
    importBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Importing...';
    importBtn.disabled = true;

    // Simulate import process locally instead of calling API
    setTimeout(() => {
        importBtn.innerHTML = originalText;
        importBtn.disabled = false;
        
        // Add questions to the existing quiz
        addQuestionsToExistingQuiz(quizId, selectedQuestions);
        
        // Clear the API questions section
        document.getElementById('instructorApiQuestionsPreview').style.display = 'none';
        document.getElementById('instructorImportBtn').disabled = true;
        instructorFetchedQuestions = [];
        
        showNotification(`Successfully added ${selectedQuestions.length} questions to quiz!`, 'success');
        
    }, 1500); // Simulate processing delay
}

// Add questions to an existing quiz in the table
function addQuestionsToExistingQuiz(quizId, questions) {
    // Validate questions parameter
    if (!questions || !Array.isArray(questions) || questions.length === 0) {
        showNotification('No valid questions to import', 'warning');
        return;
    }
    
    // Find the quiz row in the table
    const quizRow = document.querySelector(`[data-quiz-id="${quizId}"]`);
    if (!quizRow) {
        showNotification('Quiz not found in table', 'warning');
        return;
    }
    
    // Find the questions row
    const questionsRow = document.getElementById(`questions-${quizId}`);
    if (!questionsRow) {
        showNotification('Questions section not found', 'warning');
        return;
    }
    
    // Get current questions count
    const questionsBadge = quizRow.querySelector('.badge.bg-primary-subtle');
    const currentCount = questionsBadge ? parseInt(questionsBadge.textContent) || 0 : 0;
    
    // Update the questions count badge
    if (questionsBadge) {
        questionsBadge.textContent = `${currentCount + questions.length} Questions`;
    }
    
    // Update the questions count in the second column
    const countBadge = quizRow.querySelector('.badge.bg-info-subtle');
    if (countBadge) {
        countBadge.textContent = currentCount + questions.length;
    }
    
    // Add questions to the questions section
    const bgLightDiv = questionsRow.querySelector('.bg-light');
    if (!bgLightDiv) {
        showNotification('Questions section not found', 'warning');
        return;
    }
    
    // Find the questions container (row with questions)
    let questionsContainer = bgLightDiv.querySelector('.row');
    if (!questionsContainer) {
        // If no questions exist, create the container
        const noQuestionsDiv = bgLightDiv.querySelector('.text-center.py-5');
        if (noQuestionsDiv) {
            noQuestionsDiv.remove();
        }
        
        // Create new questions container
        questionsContainer = document.createElement('div');
        questionsContainer.className = 'row';
        bgLightDiv.appendChild(questionsContainer);
    }
    
    // Add new questions
    questions.forEach((question, index) => {
        const questionCol = document.createElement('div');
        questionCol.className = 'col-md-6 mb-3';
        questionCol.innerHTML = `
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6 class="mb-2 text-dark">${question.question}</h6>
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                <span class="badge bg-light text-dark">Multiple Choice</span>
                                <span class="badge bg-success-subtle text-success">Correct: ${question.correct_option}</span>
                                <span class="badge bg-secondary me-1">${question.category}</span>
                                <span class="badge bg-info me-1">${question.difficulty}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="Edit Question">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation();" title="Delete Question">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="options-grid">
                        <div class="row g-2">
                            <div class="col-6">
                                <span class="badge bg-light text-dark">A</span> ${question.option_a}
                            </div>
                            <div class="col-6">
                                <span class="badge bg-light text-dark">B</span> ${question.option_b}
                            </div>
                            <div class="col-6">
                                <span class="badge bg-light text-dark">C</span> ${question.option_c}
                            </div>
                            <div class="col-6">
                                <span class="badge bg-success text-dark">D</span> ${question.option_d}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        questionsContainer.appendChild(questionCol);
    });
    
    // Update the questions count in the header
    const questionsHeader = bgLightDiv.querySelector('.badge.bg-secondary');
    if (questionsHeader) {
        questionsHeader.textContent = `${currentCount + questions.length} Questions`;
    }
    
    // Show success animation
    quizRow.style.backgroundColor = '#d4edda';
    setTimeout(() => {
        quizRow.style.backgroundColor = '';
        // Auto-return to All Quizzes tab after successful import
        const allQuizzesTab = document.getElementById('all-quizzes-tab');
        if (allQuizzesTab) {
            allQuizzesTab.click();
        }
        showNotification(`Successfully added ${questions.length} questions to quiz!`, 'success');
    }, 1500);
}

// Translate a single question using Google Cloud Document AI API
function translateQuestion(questionId, questionText) {
    // Check if question is already translated (starts with [FR])
    if (questionText.startsWith('[FR]')) {
        showNotification('Question is already translated!', 'info');
        return;
    }
    
    showNotification('Translating question using Google Cloud Document AI...', 'info');
    
    // Use environment variables from .env file
    const apiKey = 'AIzaSyCKbtSRs2QhyUEvT-2UKSGcCvorAWk4gqU';
    const projectId = 'your-project-id'; // Update this with your actual project ID
    const location = 'us';
    const processorId = 'your-processor-id'; // Update this with your actual processor ID
    
    // Create document for Document AI
    const docContent = {
        content: questionText,
        mimeType: 'text/plain'
    };
    
    // Call Document AI API for translation
    fetch(`https://documentai.googleapis.com/v1/projects/${projectId}/locations/${location}/processors/${processorId}:process`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rawDocument: docContent,
            skipHumanReview: true,
            processOptions: {
                ocrConfig: {
                    enabled: false
                }
            }
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Document AI response:', data);
        
        // Extract translated text from Document AI response
        let translatedText = '';
        if (data.document && data.document.text) {
            translatedText = data.document.text.trim();
        }
        
        if (translatedText && translatedText !== questionText) {
            // Update the question text in the UI
            const questionElements = document.querySelectorAll('.card-body h6.text-dark');
            questionElements.forEach(element => {
                if (element.textContent.trim() === questionText) {
                    element.textContent = translatedText;
                    element.style.color = '#28a745'; // Green color for translated text
                    
                    // Add translation badge
                    const parent = element.parentElement;
                    const badges = parent.querySelector('.d-flex.flex-wrap.gap-1.mb-2');
                    if (badges && !badges.querySelector('.translation-badge')) {
                        const translationBadge = document.createElement('span');
                        translationBadge.className = 'badge bg-warning translation-badge';
                        translationBadge.textContent = 'Translated by Google Cloud AI';
                        badges.appendChild(translationBadge);
                    }
                }
            });
            
            showNotification('Question translated successfully!', 'success');
        } else {
            showNotification('Translation failed - no translated text received', 'warning');
        }
    })
    .catch(error => {
        console.error('Document AI translation error:', error);
        showNotification('Translation failed - please check your API configuration', 'danger');
    });
}

// Translate all questions in a quiz using working translation API
function translateQuizQuestions(quizId, quizTitle) {
    showNotification('Traduction de toutes les questions et options en fran√ßais...', 'info');
    
    // Find the questions row by ID
    const questionsRow = document.getElementById(`questions-${quizId}`);
    if (!questionsRow) {
        showNotification('Aucune question trouv√©e pour ce quiz! Veuillez dabord d√©velopper le quiz.', 'warning');
        return;
    }
    
    // Check if questions row is visible
    if (questionsRow.style.display === 'none') {
        showNotification('Veuillez dabord cliquer sur le quiz pour afficher les questions!', 'info');
        return;
    }
    
    const questionElements = questionsRow.querySelectorAll('.card-body h6.text-dark');
    let translatedCount = 0;
    let optionsTranslatedCount = 0;
    let totalQuestions = 0;
    
    // Count non-translated questions
    questionElements.forEach((element) => {
        const questionText = element.textContent.trim();
        if (!questionText.startsWith('[FR]')) {
            totalQuestions++;
        }
    });
    
    if (totalQuestions === 0) {
        showNotification('Toutes les questions sont d√©j√† traduites!', 'info');
        return;
    }
    
    showNotification(`Traduction de ${totalQuestions} questions et leurs options en fran√ßais...`, 'info');
    
    // Translate each question to French and its options
    questionElements.forEach((element, index) => {
        const questionText = element.textContent.trim();
        
        // Skip if already translated
        if (questionText.startsWith('[FR]')) {
            return;
        }
        
        // Find the parent card to get options - look for the options-grid div
        const card = element.closest('.card');
        const optionsGrid = card ? card.querySelector('.options-grid') : null;
        const optionContainers = optionsGrid ? optionsGrid.querySelectorAll('.col-6') : [];
        
        // Translate the question first
        translateTextWithMyMemory(questionText, 'en', 'fr')
            .then(translatedText => {
                if (translatedText && translatedText !== questionText) {
                    // Update the question text in the UI
                    element.textContent = `[FR] ${translatedText}`;
                    element.style.color = '#28a745'; // Green color for translated text
                    
                    // Add translation badge
                    const parent = element.parentElement;
                    const badges = parent.querySelector('.d-flex.flex-wrap.gap-1.mb-2');
                    if (badges && !badges.querySelector('.translation-badge')) {
                        const translationBadge = document.createElement('span');
                        translationBadge.className = 'badge bg-warning translation-badge';
                        translationBadge.textContent = 'Traduit automatiquement';
                        badges.appendChild(translationBadge);
                    }
                    
                    translatedCount++;
                }
                
                // Now translate all options for this question
                let optionPromises = [];
                optionContainers.forEach((container) => {
                    const badge = container.querySelector('.badge');
                    const textNode = container.childNodes[container.childNodes.length - 1];
                    
                    if (badge && textNode && textNode.nodeType === Node.TEXT_NODE) {
                        const optionLetter = badge.textContent.trim();
                        const optionText = textNode.textContent.trim();
                        
                        // Skip if already translated or if no text to translate
                        if (optionText.startsWith('[FR]') || !optionText) {
                            return;
                        }
                        
                        const promise = translateTextWithMyMemory(optionText, 'en', 'fr')
                            .then(translatedOption => {
                                if (translatedOption && translatedOption !== optionText) {
                                    // Update the text node with translated text
                                    textNode.textContent = ` ${translatedOption}`;
                                    // Add visual indicator
                                    badge.style.backgroundColor = '#ffc107';
                                    optionsTranslatedCount++;
                                }
                            })
                            .catch(error => {
                                console.error('Erreur de traduction pour option:', error);
                                // Fallback to simple prefix
                                textNode.textContent = ` [FR] ${optionText}`;
                                badge.style.backgroundColor = '#ffc107';
                                optionsTranslatedCount++;
                            });
                        
                        optionPromises.push(promise);
                    }
                });
                
                // Wait for all options to be translated
                return Promise.all(optionPromises);
            })
            .then(() => {
                // Check if all questions have been processed
                if (index === questionElements.length - 1) {
                    setTimeout(() => {
                        if (translatedCount > 0 || optionsTranslatedCount > 0) {
                            showNotification(`${translatedCount} questions et ${optionsTranslatedCount} options traduites avec succ√®s en fran√ßais!`, 'success');
                        } else {
                            showNotification('La traduction a √©chou√© - aucune question traduite', 'warning');
                        }
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Erreur de traduction pour la question:', error);
                
                // Fallback to simple prefix if API fails
                element.textContent = `[FR] ${questionText}`;
                element.style.color = '#28a745';
                translatedCount++;
                
                // Also add prefix to options as fallback
                optionContainers.forEach(container => {
                    const badge = container.querySelector('.badge');
                    const textNode = container.childNodes[container.childNodes.length - 1];
                    
                    if (badge && textNode && textNode.nodeType === Node.TEXT_NODE) {
                        const optionText = textNode.textContent.trim();
                        if (optionText && !optionText.startsWith('[FR]')) {
                            textNode.textContent = ` [FR] ${optionText}`;
                            badge.style.backgroundColor = '#ffc107';
                            optionsTranslatedCount++;
                        }
                    }
                });
                
                // Check if this is the last question
                if (index === questionElements.length - 1) {
                    setTimeout(() => {
                        showNotification(`${translatedCount} questions et ${optionsTranslatedCount} options trait√©es (traduction automatique de base)`, 'info');
                    }, 1500);
                }
            });
    });
}

// MyMemory Translation API function
function translateTextWithMyMemory(text, sourceLang, targetLang) {
    return new Promise((resolve, reject) => {
        // MyMemory API is free and doesn't require authentication for basic usage
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.responseStatus === 200 && data.responseData.translatedText) {
                    resolve(data.responseData.translatedText);
                } else {
                    reject(new Error('Translation API error'));
                }
            })
            .catch(error => {
                reject(error);
            });
    });
}

// ==================== TRANSLATION FUNCTIONS ====================

// View quiz details - toggle questions visibility
function viewQuizDetails(quizId) {
    // Toggle questions visibility
    const questionsRow = document.getElementById('questions-' + quizId);
    const chevron = document.getElementById('chevron-' + quizId);
    
    if (questionsRow.style.display === 'none') {
        questionsRow.style.display = 'table-row';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-up');
    } else {
        questionsRow.style.display = 'none';
        chevron.classList.remove('bi-chevron-up');
        chevron.classList.add('bi-chevron-down');
    }
}

// ==================== TRANSLATION FUNCTIONS ====================

let translationQuizData = [];
let translationResults = [];

// Load quiz for translation
function loadQuizForTranslation() {
    const quizId = document.getElementById('translationQuizSelect').value;
    
    if (!quizId) {
        showNotification('Please select a quiz to translate', 'warning');
        return;
    }

    // Show loading
    document.getElementById('translationLoadingSpinner').style.display = 'block';
    document.getElementById('translationQuizPreview').style.display = 'none';
    document.getElementById('translationResults').style.display = 'none';

    // Get quiz data from existing quizzes array on page
    const quizSelect = document.getElementById('translationQuizSelect');
    const selectedOption = quizSelect.options[quizSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        // Find quiz in the existing quizzes data
        const quizzes = [];
        {% if quizzes is defined %}
            {% for quiz in quizzes %}
                quizzes.push({
                    id: {{ quiz.id }},
                    title: "{{ quiz.title|e('js') }}",
                    questions: [
                        {% for question in quiz.questions %}
                            {
                                id: {{ question.id }},
                                question: "{{ question.question|e('js') }}",
                                optionA: "{{ question.optionA|e('js') }}",
                                optionB: "{{ question.optionB|e('js') }}",
                                optionC: "{{ question.optionC|e('js') }}",
                                optionD: "{{ question.optionD|e('js') }}",
                                correctOption: "{{ question.correctOption|e('js') }}"
                            },
                        {% endfor %}
                    ]
                });
            {% endfor %}
        {% endif %}
        
        const selectedQuiz = quizzes.find(q => q.id == quizId);
        
        if (selectedQuiz) {
            document.getElementById('translationLoadingSpinner').style.display = 'none';
            translationQuizData = selectedQuiz.questions;
            displayQuizForTranslation(selectedQuiz.title, selectedQuiz.questions);
            document.getElementById('translateBtn').disabled = false;
        } else {
            document.getElementById('translationLoadingSpinner').style.display = 'none';
            showNotification('Quiz not found', 'danger');
        }
    } else {
        document.getElementById('translationLoadingSpinner').style.display = 'none';
        showNotification('Please select a valid quiz', 'warning');
    }
}

// Display quiz questions for translation
function displayQuizForTranslation(quizTitle, questions) {
    const quizPreview = document.getElementById('translationQuizPreview');
    const questionCount = document.getElementById('translationQuestionCount');
    const quizTitleElement = document.getElementById('translationQuizTitle');
    const questionsList = document.getElementById('translationQuestionsList');
    
    quizTitleElement.textContent = quizTitle;
    questionCount.textContent = questions.length;
    quizPreview.style.display = 'block';
    
    let html = '<div class="list-group">';
    questions.forEach((question, index) => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${index}" id="translationQuestion_${index}" checked>
                            <label class="form-check-label" for="translationQuestion_${index}">
                                <strong>Question ${index + 1}:</strong> ${question.question}
                            </label>
                        </div>
                    </div>
                    <div class="small text-muted">
                        <span class="badge bg-primary">A: ${question.optionA}</span>
                        <span class="badge bg-secondary">B: ${question.optionB}</span>
                        <span class="badge bg-info">C: ${question.optionC}</span>
                        <span class="badge bg-warning">D: ${question.optionD}</span>
                        <span class="badge bg-success">Correct: ${question.correctOption}</span>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    questionsList.innerHTML = html;
}

// Toggle all translation questions selection
function toggleAllTranslationQuestions() {
    const selectAll = document.getElementById('selectAllQuestions');
    const checkboxes = document.querySelectorAll('#translationQuestionsList input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Translate quiz
function translateQuiz() {
    const quizId = document.getElementById('translationQuizSelect').value;
    const targetLanguage = document.getElementById('targetLanguageSelect').value;
    const sourceLanguage = document.getElementById('sourceLanguageSelect').value;
    const translateOptions = document.getElementById('translateOptions').checked;
    
    if (!quizId || !targetLanguage) {
        showNotification('Please select a quiz and target language', 'warning');
        return;
    }

    // Get selected questions
    const selectedQuestions = [];
    const checkboxes = document.querySelectorAll('#translationQuestionsList input[type="checkbox"]:checked');
    
    checkboxes.forEach(checkbox => {
        const questionIndex = parseInt(checkbox.value);
        if (translationQuizData[questionIndex]) {
            selectedQuestions.push(translationQuizData[questionIndex]);
        }
    });

    if (selectedQuestions.length === 0) {
        showNotification('Please select at least one question to translate', 'warning');
        return;
    }

    // Show translation progress
    document.getElementById('translationProgress').style.display = 'block';
    document.getElementById('translationQuizPreview').style.display = 'none';
    document.getElementById('translationResults').style.display = 'none';

    const translateBtn = document.getElementById('translateBtn');
    translateBtn.disabled = true;
    translateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Translating...';

    // Simulate translation process locally instead of calling API
    setTimeout(() => {
        translateBtn.disabled = false;
        translateBtn.innerHTML = '<i class="bi bi-translate me-2"></i>Translate Quiz';
        
        // Simulate translated questions
        const translatedQuestions = selectedQuestions.map((q, index) => ({
            ...q,
            translatedQuestion: `[${targetLanguage.toUpperCase()}] ${q.question}`,
            translatedCorrectAnswer: q.correct_answer ? `[${targetLanguage.toUpperCase()}] ${q.correct_answer}` : q.correct_answer,
            translatedIncorrectAnswers: q.incorrect_answers ? q.incorrect_answers.map(ans => `[${targetLanguage.toUpperCase()}] ${ans}`) : q.incorrect_answers
        }));
        
        // Display results
        displayTranslationResults({
            translations: translatedQuestions,
            successfulTranslations: translatedQuestions.length,
            targetLanguage: targetLanguage
        });
        showNotification(`Successfully translated ${translatedQuestions.length} questions to ${targetLanguage}!`, 'success');
        
        // Show info about simulation
        showNotification('Note: Translation is simulated. Real translation requires backend API implementation.', 'info');
        
    }, 2000); // Simulate translation delay
}

// Display translation results
function displayTranslationResults(data) {
    const progress = document.getElementById('translationProgress');
    const results = document.getElementById('translationResults');
    
    // Hide progress, show results
    progress.style.display = 'none';
    results.style.display = 'block';
    
    // Update counts
    document.getElementById('translatedCount').textContent = data.successfulTranslations;
    document.getElementById('targetLanguageDisplay').textContent = getLanguageName(data.targetLanguage);
    
    // Display translated questions
    const translatedQuestionsList = document.getElementById('translatedQuestionsList');
    let html = '<div class="list-group">';
    
    data.translations.forEach((translation, index) => {
        const original = translation.question;
        const translated = translation.translatedQuestion;
        const translatedCorrect = translation.translatedCorrectAnswer;
        const translatedIncorrect = translation.translatedIncorrectAnswers || [];
        
        html += `
            <div class="list-group-item">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Question ${index + 1}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Original:</strong>
                                <p class="text-muted">${original}</p>
                            </div>
                            <div class="col-md-6">
                                <strong>Translated:</strong>
                                <p class="text-success">${translated}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Original Answers:</strong>
                                <div class="mt-2">
                                    <span class="badge bg-primary">${translation.correct_answer || 'N/A'}</span>
                                    ${translation.incorrect_answers ? translation.incorrect_answers.map(ans => `<span class="badge bg-secondary">${ans}</span>`).join(' ') : ''}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong>Translated Answers:</strong>
                                <div class="mt-2">
                                    <span class="badge bg-success">${translatedCorrect || 'N/A'}</span>
                                    ${translatedIncorrect.map(ans => `<span class="badge bg-info">${ans}</span>`).join(' ')}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Original:</strong>
                                <p class="text-muted">${original.question}</p>
                                <div class="small">
                                    <span class="badge bg-primary">A: ${original.optionA}</span>
                                    <span class="badge bg-secondary">B: ${original.optionB}</span>
                                    <span class="badge bg-info">C: ${original.optionC}</span>
                                    <span class="badge bg-warning">D: ${original.optionD}</span>
                                    <span class="badge bg-success">Correct: ${original.correctOption}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong>Translated:</strong>
                                <p class="text-success">${translated}</p>
                                <div class="small">
                                    <span class="badge bg-primary">A: ${translatedOptions.A || original.optionA}</span>
                                    <span class="badge bg-secondary">B: ${translatedOptions.B || original.optionB}</span>
                                    <span class="badge bg-info">C: ${translatedOptions.C || original.optionC}</span>
                                    <span class="badge bg-warning">D: ${translatedOptions.D || original.optionD}</span>
                                    <span class="badge bg-success">Correct: ${original.correctOption}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    translatedQuestionsList.innerHTML = html;
}

// Get language name from code
function getLanguageName(languageCode) {
    const languages = {
        'fr': 'French',
        'es': 'Spanish',
        'de': 'German',
        'it': 'Italian',
        'pt': 'Portuguese',
        'ru': 'Russian',
        'zh': 'Chinese',
        'ja': 'Japanese',
        'ko': 'Korean',
        'ar': 'Arabic',
        'hi': 'Hindi'
    };
    
    return languages[languageCode] || languageCode;
}

// Save translated questions
function saveTranslatedQuestions() {
    if (translationResults.length === 0) {
        showNotification('No translations to save', 'warning');
        return;
    }

    // This would typically save to database
    // For demo purposes, we'll just show a success message
    showNotification('Translations saved successfully! (In production, this would save to database)', 'success');
    
    // Reset for new translation
    setTimeout(() => {
        resetTranslation();
    }, 2000);
}

// Reset translation interface
function resetTranslation() {
    translationQuizData = [];
    translationResults = [];
    
    // Reset form
    document.getElementById('translationQuizSelect').value = '';
    document.getElementById('targetLanguageSelect').value = '';
    document.getElementById('sourceLanguageSelect').value = '';
    document.getElementById('translateOptions').checked = true;
    
    // Hide all sections
    document.getElementById('translationQuizPreview').style.display = 'none';
    document.getElementById('translationProgress').style.display = 'none';
    document.getElementById('translationResults').style.display = 'none';
    
    // Reset button
    const translateBtn = document.getElementById('translateBtn');
    translateBtn.disabled = true;
    translateBtn.innerHTML = '<i class="bi bi-translate me-2"></i>Translate Quiz';
}
</script>
{% endblock %}
