{% extends 'base.html.twig' %}

{% block title %}{{ lesson.title }} - testttt{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <meta name="turbo-visit-control" content="reload">
    <script>
        // Disable Turbo completely for this page
        if (window.Turbo) {
            Turbo.session.drive = false;
        }
        
        // Set course ID for JavaScript
        const courseId = {{ course.id }};
        
        // Mark course as complete function
        function markCourseComplete() {
            // Show completion message
            const completionMessage = document.createElement('div');
            completionMessage.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            completionMessage.style.zIndex = '9999';
            completionMessage.style.minWidth = '300px';
            completionMessage.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Course Completed!</strong> Congratulations on finishing the course.
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(completionMessage);
            
            // Auto-remove message after 3 seconds
            setTimeout(() => {
                if (completionMessage.parentNode) {
                    completionMessage.parentNode.removeChild(completionMessage);
                }
            }, 3000);
            
            // Store completion in localStorage
            localStorage.setItem(`course_${courseId}_completed`, 'true');
            
            return true; // Allow navigation to proceed
        }
        
        // Clean up breadcrumb on page load
        document.addEventListener('DOMContentLoaded', function() {
            cleanBreadcrumb();
        });
        
        // Also clean breadcrumb after a short delay to catch any dynamic content
        setTimeout(cleanBreadcrumb, 100);
        setTimeout(cleanBreadcrumb, 500);
        
        function cleanBreadcrumb() {
            // Clean up any breadcrumb items containing file paths
            const breadcrumbItems = document.querySelectorAll('.breadcrumb-item');
            breadcrumbItems.forEach(item => {
                const text = item.textContent;
                if (text && text.includes('../../index-12.html')) {
                    item.textContent = text.replace('../../index-12.html', 'testttt');
                }
            });
        }
        
        // Set up MutationObserver to catch dynamic changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    cleanBreadcrumb();
                }
            });
        });
        
        // Start observing the breadcrumb container
        const breadcrumbContainer = document.querySelector('.breadcrumb');
        if (breadcrumbContainer) {
            observer.observe(breadcrumbContainer, {
                childList: true,
                subtree: true
            });
        }
    </script>
    <style>
        .lesson-sidebar {
            position: sticky;
            top: 20px;
        }
        .chapter-lessons {
            max-height: 60vh;
            overflow-y: auto;
        }
        .active-lesson {
            background-color: #f8f9fa;
            border-left: 3px solid #0d6efd;
        }
        .lesson-content {
            line-height: 1.8;
        }
        .lesson-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        /* Button hover effects */
        .btn-outline-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }
        
        /* Navigation buttons spacing */
        .d-flex.justify-content-between {
            gap: 1rem;
        }
        
        /* Center buttons group */
        .d-flex.gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Ensure proper alignment */
        .justify-content-between > div:first-child,
        .justify-content-between > div:last-child {
            flex: 0 0 auto;
            min-width: 120px;
        }
        
        .justify-content-between > div:nth-child(2) {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Completion animation */
        @keyframes slideInDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        .alert-success {
            animation: slideInDown 0.3s ease-out;
        }
    </style>
{% endblock %}

{% block body %}
<!-- =======================
Header START -->
<header class="navbar-light navbar-sticky header-static">
    <!-- Logo Nav START -->
    <nav class="navbar navbar-expand-xl">
        <div class="container">
            <!-- Logo START -->
            <a class="navbar-brand" href="{{ path('app_home') }}">
                <img class="navbar-brand-item" src="{{ asset('assets/images/logo.svg') }}" alt="logo">
            </a>
            <!-- Logo END -->

            <!-- Responsive navbar toggler -->
            <button class="navbar-toggler ms-auto icon-md btn btn-outline-secondary p-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Main navbar START -->
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav navbar-nav-scroll me-auto">
                    <!-- Nav item Home -->
                    <li class="nav-item">
                        <a class="nav-link {% if app.request.attributes.get('_route') == 'app_home' %}active{% endif %}" href="{{ path('app_home') }}">
                            Home
                        </a>
                    </li>

                    <!-- Nav item Courses -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if app.request.attributes.get('_route') starts with 'app_course_grid' %}active{% endif %}" href="#" id="courseDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Courses
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="courseDropdown">
                            <li><h6 class="dropdown-header">Learning</h6></li>
                            <li><a class="dropdown-item" href="{{ path('app_course_grid') }}">Browse Courses</a></li>
                            <li><a class="dropdown-item" href="{{ path('app_categories') }}">Course Categories</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Student</h6></li>
                            <li><a class="dropdown-item" href="#">My Certificates</a></li>
                            <li><a class="dropdown-item" href="#">My Bookmarks</a></li>
                        </ul>
                    </li>

                    <!-- Nav item Sessions -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if app.request.attributes.get('_route') starts with 'session' %}active{% endif %}" href="#" id="sessionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Sessions
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="sessionDropdown">
                            <li><h6 class="dropdown-header">Schedule</h6></li>
                            <li><a class="dropdown-item" href="{{ path('session_data_display') }}">All Sessions</a></li>
                            <li><a class="dropdown-item" href="{{ path('booking_create') }}">Book a Session</a></li>
                            <li><a class="dropdown-item" href="{{ path('all_bookings') }}">My Bookings</a></li>
                        </ul>
                    </li>

                    <!-- Nav item Marketplace -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {% if app.request.attributes.get('_route') starts with 'app_marketplace' or app.request.attributes.get('_route') starts with 'app_product' or app.request.attributes.get('_route') starts with 'app_job' %}active{% endif %}" href="#" id="marketplaceDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Marketplace
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="marketplaceDropdown">
                            <li><h6 class="dropdown-header">Services</h6></li>
                            <li><a class="dropdown-item {% if app.request.attributes.get('_route') == 'app_marketplace_shop' %}active{% endif %}" href="{{ path('app_marketplace_shop') }}">Browse Marketplace</a></li>
                            <li><a class="dropdown-item {% if app.request.attributes.get('_route') == 'app_product_new_public' %}active{% endif %}" href="{{ path('app_product_new_public') }}">Offer Service</a></li>
                            <li><a class="dropdown-item {% if app.request.attributes.get('_route') starts with 'app_job' %}active{% endif %}" href="#">Job Requests</a></li>
                        </ul>
                    </li>


                    <!-- Nav item Support -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="supportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Support
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="supportDropdown">
                            <li><h6 class="dropdown-header">Help</h6></li>
                            <li><a class="dropdown-item" href="#">Help Center</a></li>
                            <li><a class="dropdown-item" href="#">Contact Support</a></li>
                            <li><a class="dropdown-item" href="#">FAQ</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">About</h6></li>
                            <li><a class="dropdown-item" href="#">About Us</a></li>
                            <li><a class="dropdown-item" href="#">Contact</a></li>
                            <li><a class="dropdown-item" href="#">Privacy Policy</a></li>
                            <li><a class="dropdown-item" href="#">Terms of Service</a></li>
                        </ul>
                    </li>
                </ul>

                <!-- Search bar START -->
                <div class="nav-item mx-3">
                    <form class="position-relative" method="get" action="{{ path('app_course_grid') }}">
                        <input class="form-control pe-5" type="search" name="search" placeholder="Search courses, topics..." aria-label="Search">
                        <button class="bg-transparent p-2 position-absolute top-50 end-0 translate-middle-y border-0 text-primary-hover text-reset" type="submit">
                            <i class="fas fa-search fs-6"></i>
                        </button>
                    </form>
                </div>
                <!-- Search bar END -->

                <!-- Nav right side START -->
                <ul class="nav flex-row align-items-center list-unstyled ms-xl-auto">
                    <!-- Authentication START -->
                    {% if app.user %}
                        <!-- Profile dropdown START -->
                        <li class="nav-item dropdown">
                            <a class="nav-link avatar avatar-sm p-0" href="#" id="profileDropdown" role="button" data-bs-auto-close="outside" data-bs-display="static" data-bs-toggle="dropdown" aria-expanded="false">
                                <img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="avatar">
                            </a>
                            <ul class="dropdown-menu dropdown-animation dropdown-menu-end shadow pt-3" aria-labelledby="profileDropdown">
                                <!-- Profile info -->
                                <li class="px-3 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-3">
                                            <img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="avatar">
                                        </div>
                                        <div>
                                            <a class="h6 mt-2 mt-sm-0" href="#">{{ app.user.name|default(app.user.email) }}</a>
                                            <p class="small m-0">{{ app.user.email }}</p>
                                        </div>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <!-- Links -->
                                {% if app.user and 'ROLE_INSTRUCTOR' in app.user.roles %}
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-person fa-fw me-2"></i>My Profile</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-shopping-cart fa-fw me-2"></i>My Orders</a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_instructor_dashboard') }}"><i class="fas fa-chalkboard-teacher fa-fw me-2"></i>Dashboard</a></li>
                                {% elseif app.user and 'ROLE_STUDENT' in app.user.roles %}
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-person fa-fw me-2"></i>My Profile</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-shopping-cart fa-fw me-2"></i>My Orders</a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_student_dashboard') }}"><i class="fas fa-graduation-cap fa-fw me-2"></i>Dashboard</a></li>
                                {% else %}
                                    <li><a class="dropdown-item" href="{{ path('app_admin_dashboard') }}"><i class="fas fa-tachometer-alt fa-fw me-2"></i>Dashboard</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-person fa-fw me-2"></i>Edit Profile</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-gear fa-fw me-2"></i>Account Settings</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-info-circle fa-fw me-2"></i>Help</a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item bg-danger-soft-hover" href="{{ path('app_logout') }}"><i class="fas fa-sign-out-alt fa-fw me-2"></i>Sign Out</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <!-- Sign in button -->
                        <li class="nav-item">
                            <a class="btn btn-sm btn-primary me-2" href="{{ path('app_login') }}">Sign In</a>
                        </li>
                        <!-- Sign up button -->
                        <li class="nav-item">
                            <a class="btn btn-sm btn-outline-primary" href="{{ path('app_register') }}">Sign Up</a>
                        </li>
                    {% endif %}
                    <!-- Authentication END -->
                </ul>
            </div>
        </div>
    </nav>
    <!-- Logo Nav END -->
</header>
<!-- =======================
Header END -->

<div class="container py-4" data-turbo="false">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ path('app_home') }}" data-turbo="false">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ path('app_instructor_course_detail', {'id': course.id}) }}" data-turbo="false">testttt</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ lesson.title }}</li>
                </ol>
            </nav>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h1 class="h2 mb-4">{{ lesson.title }}</h1>
                    
                    {% if lesson.type == 'video' and lesson.content %}
                        {% if lesson.content starts with 'http' %}
                            <div class="ratio ratio-16x9 mb-4">
                                <iframe 
                                    src="{{ lesson.content|replace({'youtube.com': 'youtube-nocookie.com'}) }}" 
                                    title="{{ lesson.title }}"
                                    allowfullscreen
                                    class="rounded"
                                    loading="lazy"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowtransparency="true"
                                    referrerpolicy="no-referrer-when-downgrade"
                                    sandbox="allow-same-origin allow-scripts allow-popups allow-presentation"
                                ></iframe>
                            </div>
                        {% else %}
                            <div class="alert alert-warning mb-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Invalid Video URL:</strong> This lesson has an invalid video URL configured. Please contact the instructor.
                            </div>
                        {% endif %}
                    {% elseif lesson.type == 'document' and lesson.attachmentUrl %}
                        <div class="text-center p-5 border rounded mb-4">
                            <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                            <h5>Document Lesson</h5>
                            <p>Download the lesson material to view it properly.</p>
                            <a href="{{ asset(lesson.attachmentUrl) }}" class="btn btn-primary" download>
                                <i class="fas fa-download me-2"></i>Download Document
                            </a>
                        </div>
                    {% endif %}

                    {% if lesson.description %}
                        <div class="lesson-content">
                            {{ lesson.description|raw }}
                        </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center border-top mt-4 pt-3">
                        <div>
                            <span class="text-muted me-3">
                                <i class="far fa-clock me-1"></i> {{ lesson.duration }} min
                            </span>
                            <span class="badge bg-{{ 
                                lesson.type == 'video' ? 'primary' : 
                                (lesson.type == 'quiz' ? 'success' : 'secondary') 
                            }}">
                                {{ lesson.type|capitalize }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation between lessons -->
            <div class="d-flex justify-content-between align-items-center mb-5">
                {% if previousLesson %}
                    <a href="{{ path('app_lesson_show', {'id': previousLesson.id}) }}" 
                       data-turbo="false"
                       class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Previous Lesson
                    </a>
                {% else %}
                    <div></div> <!-- Empty div to maintain layout -->
                {% endif %}

                <div class="d-flex gap-2">
                    <a href="{{ path('app_instructor_course_detail', {'id': course.id}) }}" 
                       data-turbo="false"
                       class="btn btn-outline-secondary"
                       title="Return to course overview">
                        <i class="fas fa-list me-2"></i>Back to Course
                    </a>

                    {% if not nextLesson %}
                        <form method="get" action="{{ path('app_instructor_course_detail', {'id': course.id}) }}" style="display: inline;">
                            <button type="submit" 
                                    class="btn btn-success"
                                    onclick="markCourseComplete(); return true;"
                                    title="Complete course and return to overview">
                                Complete Course <i class="fas fa-check-circle ms-2"></i>
                            </button>
                        </form>
                    {% endif %}
                </div>

                {% if nextLesson %}
                    <a href="{{ path('app_lesson_show', {'id': nextLesson.id}) }}" 
                       data-turbo="false"
                       class="btn btn-primary">
                        Next Lesson <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                {% else %}
                    <div></div> <!-- Empty div to maintain layout when no next lesson -->
                {% endif %}
            </div>
            
                    </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="lesson-sidebar">
                <!-- Course Content -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Course Content</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush chapter-lessons">
                            {% for chapter in chapters %}
                                <div class="list-group-item px-0 py-2">
                                    <h6 class="mb-2 fw-bold px-3">{{ chapter.title }}</h6>
                                    <div class="list-group list-group-flush">
                                        {% for chapLesson in chapter.lessons|sort((a, b) => a.sortOrder <=> b.sortOrder) %}
                                            <a href="{{ path('app_lesson_show', {'id': chapLesson.id}) }}" 
                                               data-turbo="false"
                                               class="list-group-item list-group-item-action border-0 py-2 px-3 
                                                      {{ chapLesson.id == lesson.id ? 'active-lesson fw-bold' : '' }}">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-{{ 
                                                        chapLesson.type == 'video' ? 'play-circle' : 
                                                        (chapLesson.type == 'quiz' ? 'question-circle' : 'file-alt') 
                                                    }} me-2 {{ chapLesson.id == lesson.id ? 'text-primary' : 'text-muted' }}"></i>
                                                    <span>{{ chapLesson.title }}</span>
                                                    {% if chapLesson.isPreview %}
                                                        <span class="badge bg-warning text-dark ms-auto">Preview</span>
                                                    {% endif %}
                                                </div>
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
{% include 'components/footer.html.twig' %}
{% endblock %}
