{% extends 'front_base.html.twig' %}

{% block title %}AI Learning Roadmap{% endblock %}

{% block content %}
<!-- **************** MAIN CONTENT START **************** -->
<main>

<!-- =======================
AI Learning Roadmap START -->
<section class="pt-4">
    <div class="container">
        <div class="row">
            <!-- Left sidebar START -->
            <div class="col-lg-3">
                <!-- User profile START -->
                <div class="card shadow mb-4">
                    <div class="card-body text-center p-4">
                        <div class="avatar avatar-xl mb-3">
                            <img class="avatar-img rounded-circle" src="{{ asset('assets/images/avatar/01.jpg') }}" alt="avatar">
                        </div>
                        <h5 class="mb-1">{{ user.name|default(user.email) }}</h5>
                        <p class="mb-2">{{ user.email }}</p>
                        <div class="d-flex justify-content-center gap-2">
                            <a href="#" class="btn btn-sm btn-primary">Edit Profile</a>
                        </div>
                    </div>
                </div>
                <!-- User profile END -->

                <!-- Navigation menu START -->
                <div class="card shadow">
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <a href="{{ path('app_student_dashboard') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                            <a href="{{ path('app_student_courses') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-book me-2"></i>My Courses
                            </a>
                            <a href="{{ path('app_student_certificates') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-certificate me-2"></i>Certificates
                            </a>
                            <a href="{{ path('app_student_quiz_analysis') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-brain me-2"></i>AI Quiz Analysis
                            </a>
                            <a href="{{ path('app_student_ai_roadmap') }}" class="list-group-item list-group-item-action active">
                                <i class="fas fa-lightbulb me-2"></i>AI Recommendations
                            </a>
                            <a href="{{ path('app_student_settings') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Navigation menu END -->
            </div>

            <!-- Main content START -->
            <div class="col-lg-9">
                <!-- Header START -->
                <div class="card shadow mb-4">
                    <div class="card-body p-4">
                        <h3 class="mb-1">AI Learning Roadmap Generator</h3>
                        <p class="mb-0">Tell us what you want to learn, and our AI will create a personalized learning path based on your enrolled courses</p>
                    </div>
                </div>
                <!-- Header END -->

                <!-- Input Section START -->
                <div class="card shadow mb-4">
                    <div class="card-body p-4">
                        <form id="roadmapForm">
                            <div class="mb-4">
                                <label for="learningGoal" class="form-label fw-bold">What do you want to learn?</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-target"></i>
                                    </span>
                                    <input type="text" class="form-control form-control-lg" id="learningGoal" name="learningGoal" 
                                           placeholder="e.g., Web Development, Data Science, Machine Learning, Mobile App Development" 
                                           required>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="currentLevel" class="form-label fw-bold">Current Skill Level</label>
                                <select class="form-select form-select-lg" id="currentLevel" name="currentLevel" required>
                                    <option value="">Select your current level</option>
                                    <option value="beginner">Beginner - Just starting out</option>
                                    <option value="intermediate">Intermediate - Some experience</option>
                                    <option value="advanced">Advanced - Experienced practitioner</option>
                                    <option value="expert">Expert - Professional level</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="timeCommitment" class="form-label fw-bold">Weekly Time Commitment</label>
                                <select class="form-select form-select-lg" id="timeCommitment" name="timeCommitment" required>
                                    <option value="">Select time availability</option>
                                    <option value="1-2">1-2 hours per week</option>
                                    <option value="3-5">3-5 hours per week</option>
                                    <option value="6-10">6-10 hours per week</option>
                                    <option value="10+">10+ hours per week</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label for="learningStyle" class="form-label fw-bold">Preferred Learning Style</label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="visual" name="learningStyle[]" value="visual">
                                            <label class="form-check-label" for="visual">
                                                <i class="fas fa-eye me-2"></i>Visual (Videos, Diagrams)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="practical" name="learningStyle[]" value="practical">
                                            <label class="form-check-label" for="practical">
                                                <i class="fas fa-code me-2"></i>Practical (Hands-on, Projects)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="reading" name="learningStyle[]" value="reading">
                                            <label class="form-check-label" for="reading">
                                                <i class="fas fa-book-open me-2"></i>Reading (Documentation, Articles)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="interactive" name="learningStyle[]" value="interactive">
                                            <label class="form-check-label" for="interactive">
                                                <i class="fas fa-comments me-2"></i>Interactive (Quizzes, Discussions)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg px-5" id="generateRoadmapBtn">
                                    <i class="fas fa-magic me-2"></i>Generate AI Roadmap
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Input Section END -->

                
                <!-- Loading State -->
                <div id="loadingState" class="card shadow" style="display: none;">
                    <div class="card-body p-5 text-center">
                        <div class="spinner-border mb-3" role="status">
                            <div class="spinner-border-sm" style="width: 3rem; height: 3rem;">
                                <div class="spinner-border-grow"></div>
                            </div>
                        </div>
                        <h5 class="text-primary mb-3">AI is Analyzing Your Learning Goals...</h5>
                        <p class="text-muted">Our AI is reviewing your courses and creating your personalized learning roadmap. This may take a few moments.</p>
                    </div>
                </div>
                <!-- Loading State END -->

                <!-- Results Section -->
                <div id="roadmapResults" style="display: none;">
                    <!-- Roadmap Overview Card -->
                    <div class="card shadow mb-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-4">
                                <div class="icon-lg bg-success bg-opacity-10 text-success rounded-circle me-3">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Your Personalized Learning Roadmap</h5>
                                    <p class="mb-0 text-muted">AI-generated path based on your goals and enrolled courses</p>
                                </div>
                            </div>
                            
                            <div id="roadmapOverview">
                                <!-- Roadmap will be dynamically inserted here -->
                            </div>

                            <div class="text-center mt-4">
                                <button class="btn btn-outline-primary me-2" onclick="downloadRoadmap()">
                                    <i class="fas fa-download me-2"></i>Download Roadmap
                                </button>
                                <button class="btn btn-outline-secondary" onclick="shareRoadmap()">
                                    <i class="fas fa-share me-2"></i>Share Roadmap
                                </button>
                                <button class="btn btn-primary" onclick="startLearning()">
                                    <i class="fas fa-play me-2"></i>Start Learning
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Roadmap Overview Card END -->

                    <!-- Detailed Steps -->
                    <div class="card shadow">
                        <div class="card-body p-4">
                            <h5 class="mb-4">
                                <i class="fas fa-list-check me-2"></i>Detailed Learning Steps
                            </h5>
                            <div id="detailedSteps">
                                <!-- Detailed steps will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    <!-- Detailed Steps END -->

                    <!-- Resources Section -->
                    <div class="card shadow">
                        <div class="card-body p-4">
                            <h5 class="mb-4">
                                <i class="fas fa-book me-2"></i>Recommended Resources
                            </h5>
                            <div id="recommendedResources">
                                <!-- Resources will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    <!-- Resources Section END -->
                </div>
                <!-- Results Section END -->
            </div>
            <!-- Main content END -->
        </div>
    </div>
</section>
<!-- =======================
AI Learning Roadmap END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

{% endblock %}

{% block stylesheets %}
<style>
.roadmap-timeline {
    position: relative;
    padding-left: 30px;
}

.roadmap-timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 2px;
    background: linear-gradient(to bottom, #0d6efd, #198754);
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -38px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #0d6efd;
    border: 2px solid #fff;
}

.timeline-item.completed::before {
    background: #198754;
}

.timeline-content {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-left: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.timeline-week {
    font-weight: 600;
    color: #0d6efd;
    margin-bottom: 5px;
}

.timeline-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
}

.timeline-description {
    color: #6c757d;
    margin-bottom: 10px;
}

.timeline-resources {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.resource-badge {
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

.resource-badge.primary {
    background: #0d6efd;
    color: #fff;
}

.resource-badge.success {
    background: #198754;
    color: #fff;
}

.progress-step {
    background: #e9ecef;
    border-radius: 4px;
    height: 8px;
    margin-top: 10px;
    position: relative;
    overflow: hidden;
}

.progress-step-fill {
    height: 100%;
    background: linear-gradient(90deg, #0d6efd, #198754);
    border-radius: 4px;
    transition: width 1s ease;
}

.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: -0.125em;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    animation: spinner-border 0.75s linear infinite;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.125em;
}

.spinner-border-grow {
    border: 0.125em solid transparent;
    border-radius: 50%;
    animation: spinner-grow 0.75s ease-in-out infinite;
}

@keyframes spinner-border {
    0% { border-color: #0d6efd; }
    25% { border-color: transparent; }
    50% { border-color: #198754; }
    75% { border-color: transparent; }
    100% { border-color: #0d6efd; }
}

@keyframes spinner-grow {
    0% { transform: scale(0); }
    50% { opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
}
</style>
{% endblock %}

{% block javascripts %}
<script>
// Dynamic course functionality
let selectedCourses = [];
let currentCategory = 'all';

// Clear any cached data and prevent caching
document.addEventListener('DOMContentLoaded', function() {
    // Clear any localStorage or sessionStorage data
    localStorage.clear();
    sessionStorage.clear();
    
    // Prevent browser caching
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            registrations.forEach(function(registration) {
                registration.unregister();
            });
        });
    }
    
    // Add meta tags to prevent caching
    const metaTags = [
        { name: 'cache-control', content: 'no-cache, no-store, must-revalidate' },
        { name: 'pragma', content: 'no-cache' },
        { name: 'expires', content: '0' }
    ];
    
    metaTags.forEach(tag => {
        let meta = document.querySelector(`meta[name="${tag.name}"]`);
        if (!meta) {
            meta = document.createElement('meta');
            meta.name = tag.name;
            meta.content = tag.content;
            document.head.appendChild(meta);
        }
    });
    
    // Clear form fields to prevent cached values
    const learningGoalField = document.getElementById('learningGoal');
    if (learningGoalField) {
        learningGoalField.value = '';
        learningGoalField.focus(); // Set focus to the learning goal field
    }
    
    // Category filter buttons
    const categoryButtons = document.querySelectorAll('[data-category]');
    categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter courses
            const category = this.dataset.category;
            filterCourses(category);
        });
    });

    // Add to roadmap buttons
    const addToRoadmapButtons = document.querySelectorAll('.add-to-roadmap');
    addToRoadmapButtons.forEach(button => {
        button.addEventListener('click', function() {
            const courseId = this.dataset.courseId;
            const courseTitle = this.dataset.courseTitle;
            const courseLevel = this.dataset.courseLevel;
            
            addCourseToRoadmap(courseId, courseTitle, courseLevel, this);
        });
    });

    // Load more courses
    const loadMoreBtn = document.getElementById('loadMoreCourses');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', loadMoreCourses);
    }
});

function filterCourses(category) {
    currentCategory = category;
    const courseCards = document.querySelectorAll('[data-category-id]');
    
    courseCards.forEach(card => {
        if (category === 'all' || card.dataset.categoryId === category) {
            card.parentElement.style.display = 'block';
        } else {
            card.parentElement.style.display = 'none';
        }
    });
}

function addCourseToRoadmap(courseId, courseTitle, courseLevel, button) {
    // Check if course already selected
    if (selectedCourses.find(course => course.id === courseId)) {
        showNotification('Course already added to roadmap!', 'warning');
        return;
    }

    // Add to selected courses
    selectedCourses.push({
        id: courseId,
        title: courseTitle,
        level: courseLevel
    });

    // Update button state
    button.innerHTML = '<i class="fas fa-check me-1"></i>Added';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
    button.disabled = true;

    showNotification(`${courseTitle} added to your roadmap!`, 'success');
    
    // Update roadmap preview if visible
    updateRoadmapPreview();
}

function loadMoreCourses() {
    // In a real implementation, this would load more courses via AJAX
    const loadMoreBtn = document.getElementById('loadMoreCourses');
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    
    setTimeout(() => {
        loadMoreBtn.style.display = 'none';
        showNotification('All courses loaded!', 'info');
    }, 1000);
}

function updateRoadmapPreview() {
    if (selectedCourses.length > 0 && document.getElementById('roadmapResults').style.display === 'block') {
        // Update the roadmap with selected courses
        const resourcesHtml = selectedCourses.map(course => `
            <div class="col-md-6">
                <div class="card border h-100">
                    <div class="card-body">
                        <h6 class="mb-2">${course.title}</h6>
                        <p class="small text-muted mb-2">Level: ${course.level}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="resource-badge primary">Selected Course</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromRoadmap('${course.id}')">
                                <i class="fas fa-times me-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('recommendedResources').innerHTML = `
            <div class="alert alert-info mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>Your Selected Courses</h6>
                <p class="mb-0">These are the courses you've added to your learning roadmap.</p>
            </div>
            <div class="row g-3">
                ${resourcesHtml}
            </div>
        `;
    }
}

function removeFromRoadmap(courseId) {
    selectedCourses = selectedCourses.filter(course => course.id !== courseId);
    
    // Reset button state
    const button = document.querySelector(`[data-course-id="${courseId}"]`);
    if (button) {
        button.innerHTML = '<i class="fas fa-plus me-1"></i>Add to Roadmap';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
        button.disabled = false;
    }
    
    updateRoadmapPreview();
    showNotification('Course removed from roadmap', 'info');
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Form submission and roadmap generation
document.getElementById('roadmapForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generateRoadmap();
});

async function generateRoadmap() {
    const form = document.getElementById('roadmapForm');
    
    // Clear any potential form field issues
    const learningGoalField = document.getElementById('learningGoal');
    if (learningGoalField) {
        // Trim whitespace and ensure field is properly focused
        learningGoalField.value = learningGoalField.value.trim();
        
        // Debug: Check what's actually in the field
        console.log('Field value:', `"${learningGoalField.value}"`);
        console.log('Field length:', learningGoalField.value.length);
    }
    
    const formData = new FormData(form);
    
    // Clear previous results and reset state
    document.getElementById('roadmapResults').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
    
    // Clear any existing roadmap data
    selectedCourses = [];
    
    // Collect form data
    const learningGoal = formData.get('learningGoal');
    const currentLevel = formData.get('currentLevel');
    const timeCommitment = formData.get('timeCommitment');
    const learningStyles = formData.getAll('learningStyle');
    
    // Debug: Log all form data
    console.log('=== FORM DATA DEBUG ===');
    console.log('Raw FormData entries:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: "${value}"`);
    }
    console.log('Extracted values:');
    console.log('learningGoal:', `"${learningGoal}"`);
    console.log('currentLevel:', `"${currentLevel}"`);
    console.log('timeCommitment:', `"${timeCommitment}"`);
    console.log('learningStyles:', learningStyles);
    console.log('======================');
    
    // Validate input
    if (!learningGoal || !currentLevel || !timeCommitment) {
        showNotification('Please fill in all required fields', 'warning');
        document.getElementById('loadingState').style.display = 'none';
        return;
    }
    
    // Check if the learning goal is learnable
    if (!isLearnableGoal(learningGoal)) {
        document.getElementById('loadingState').style.display = 'none';
        showNotLearnableMessage(learningGoal);
        return;
    }
    
    console.log('Generating roadmap for:', { learningGoal, currentLevel, timeCommitment, learningStyles });
    
    // Prepare data for AI API
    const requestData = {
        learning_goal: learningGoal,
        skill_level: currentLevel,
        time_commitment: timeCommitment,
        learning_styles: learningStyles
    };
    
    // Generate roadmap with enhanced AI
    try {
        // Add cache-busting parameters to prevent any caching
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        
        const response = await fetch(`/api/ai-roadmap/generate?_t=${timestamp}&_r=${random}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('AI Response:', data);
        
        if (data.success) {
            await displayIntelligentRoadmap(data.roadmap, data.user_history, data.fallback_used);
            showNotification('Roadmap generated successfully!', 'success');
        } else {
            throw new Error(data.error || 'Failed to generate roadmap');
        }
        
    } catch (error) {
        console.error('Error generating AI roadmap:', error);
        
        // Show specific error message
        showNotification('AI service temporarily unavailable. Using enhanced recommendations...', 'warning');
        
        // Fallback to enhanced client-side generation with fresh data
        try {
            await generateRoadmapContent(learningGoal, currentLevel, timeCommitment, learningStyles);
            showNotification('Enhanced roadmap generated successfully!', 'success');
        } catch (fallbackError) {
            console.error('Fallback roadmap generation failed:', fallbackError);
            showNotification('Error generating roadmap. Please try again.', 'danger');
        }
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

async function displayIntelligentRoadmap(roadmap, userHistory, fallbackUsed = false) {
    // Hide loading, show results
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('roadmapResults').style.display = 'block';
    
    // Display roadmap overview
    const roadmapInfo = roadmap.roadmap || {};
    const alertType = fallbackUsed ? 'warning' : 'success';
    const alertMessage = fallbackUsed 
        ? 'AI-generated roadmap with enhanced rule-based recommendations'
        : 'Personalized AI-generated learning roadmap';
    
    document.getElementById('roadmapOverview').innerHTML = `
        <div class="alert alert-${alertType} mb-4">
            <h6><i class="fas fa-${fallbackUsed ? 'cog' : 'brain'} me-2"></i>${alertMessage}</h6>
            <p class="mb-0">${roadmapInfo.description || 'Your personalized learning path has been created.'}</p>
            ${roadmapInfo.estimated_duration ? `<p class="mb-0"><strong>Duration:</strong> ${roadmapInfo.estimated_duration}</p>` : ''}
            ${roadmapInfo.difficulty_progression ? `<p class="mb-0"><strong>Progression:</strong> ${roadmapInfo.difficulty_progression}</p>` : ''}
        </div>
        
        ${roadmapInfo.personalization_factors ? `
        <div class="alert alert-info mb-4">
            <h6><i class="fas fa-info-circle me-2"></i>Personalization Features</h6>
            <div class="row">
                ${Object.entries(roadmapInfo.personalization_factors).map(([key, value]) => 
                    `<div class="col-md-6 mb-2">
                        <i class="fas fa-${value ? 'check' : 'times'} text-${value ? 'success' : 'danger'} me-2"></i>
                        ${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </div>`
                ).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="roadmap-timeline">
            ${generateIntelligentTimeline(roadmap.weeks || [])}
        </div>
    `;
    
    // Display detailed steps
    document.getElementById('detailedSteps').innerHTML = generateDetailedSteps(roadmap.weeks || []);
    
    // Display milestones
    if (roadmap.milestones && roadmap.milestones.length > 0) {
        const milestonesHtml = roadmap.milestones.map(milestone => `
            <div class="col-md-6 mb-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h6 class="card-title text-primary">Week ${milestone.week}: ${milestone.title}</h6>
                        <p class="card-text small">${milestone.description}</p>
                        <div class="mb-2">
                            ${milestone.skills_gained.map(skill => 
                                `<span class="badge bg-light text-dark me-1">${skill}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Insert milestones after detailed steps
        const detailedStepsElement = document.getElementById('detailedSteps');
        detailedStepsElement.insertAdjacentHTML('afterend', `
            <div class="card shadow mt-4">
                <div class="card-body p-4">
                    <h5 class="mb-4">
                        <i class="fas fa-flag-checkered me-2"></i>Learning Milestones
                    </h5>
                    <div class="row">
                        ${milestonesHtml}
                    </div>
                </div>
            </div>
        `);
    }
    
    // Display adaptation notes and success criteria
    if (roadmap.adaptation_notes || roadmap.success_criteria) {
        const metaInfo = `
            ${roadmap.adaptation_notes ? `<p class="mb-2"><strong>Adaptive Learning:</strong> ${roadmap.adaptation_notes}</p>` : ''}
            ${roadmap.success_criteria ? `<p class="mb-2"><strong>Success Criteria:</strong> ${roadmap.success_criteria}</p>` : ''}
            ${roadmap.next_steps ? `<p class="mb-0"><strong>Next Steps:</strong> ${roadmap.next_steps}</p>` : ''}
        `;
        
        document.getElementById('roadmapOverview').insertAdjacentHTML('beforeend', `
            <div class="alert alert-light mt-3">
                ${metaInfo}
            </div>
        `);
    }
    
    // Add action buttons for roadmap management
    const actionButtonsHtml = `
        <div class="card shadow mt-4">
            <div class="card-body p-4">
                <h5 class="mb-4">
                    <i class="fas fa-tools me-2"></i>Roadmap Actions
                </h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-danger btn-lg w-100" onclick="resetRoadmap()">
                            <i class="fas fa-redo me-2"></i>Reset Roadmap
                        </button>
                        <small class="text-muted d-block mt-2">Clear this roadmap and start over with new goals</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-success btn-lg w-100" onclick="saveRoadmapToDatabase(event)">
                            <i class="fas fa-save me-2"></i>Save Roadmap
                        </button>
                        <small class="text-muted d-block mt-2">Save this learning roadmap to your profile</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Insert action buttons after all content
    document.getElementById('roadmapResults').insertAdjacentHTML('beforeend', actionButtonsHtml);
    
    // Always populate resources section
    const resources = extractResourcesFromWeeks(roadmap.weeks || []);
    populateRecommendedResources(resources, true);
}

function generateIntelligentTimeline(weeks) {
    return weeks.map((week, index) => {
        const isCompleted = index === 0; // First week marked as completed
        const progressPercentage = isCompleted ? 100 : 0;
        
        return `
            <div class="timeline-item ${isCompleted ? 'completed' : ''}">
                <div class="timeline-content">
                    <div class="timeline-week">Week ${week.week}</div>
                    <div class="timeline-title">${week.title}</div>
                    <div class="timeline-description">${week.focus || 'Focus area for this week'}</div>
                    
                    ${week.objectives && week.objectives.length > 0 ? `
                        <div class="mb-2">
                            <strong>Objectives:</strong>
                            <ul class="small mb-0">
                                ${week.objectives.map(obj => `<li>${obj}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="timeline-resources">
                        <span class="resource-badge primary">${week.difficulty || 'intermediate'}</span>
                        <span class="resource-badge success">${week.assessment_type || 'quiz'}</span>
                        ${week.estimated_hours ? `<span class="resource-badge info">${week.estimated_hours}h</span>` : ''}
                    </div>
                    
                    ${week.personalization_notes ? `
                        <div class="mt-2">
                            <small class="text-muted"><i class="fas fa-lightbulb me-1"></i>${week.personalization_notes}</small>
                        </div>
                    ` : ''}
                    
                    <div class="progress-step mt-2">
                        <div class="progress-step-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function generateDetailedSteps(weeks) {
    return `
        <div class="list-group">
            ${weeks.map((week, index) => {
                const isCompleted = index === 0;
                const progressPercentage = isCompleted ? 100 : 0;
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h6 class="mb-0 me-2">Week ${week.week}: ${week.title}</h6>
                                    <span class="badge bg-primary">${week.difficulty || 'intermediate'}</span>
                                    ${week.estimated_hours ? `<span class="badge bg-info">${week.estimated_hours}h</span>` : ''}
                                </div>
                                
                                <p class="mb-2 text-muted">${week.focus || 'Weekly focus area'}</p>
                                
                                ${week.objectives && week.objectives.length > 0 ? `
                                    <div class="mb-3">
                                        <strong>Learning Objectives:</strong>
                                        <ul class="small mb-0">
                                            ${week.objectives.map(obj => `<li>${obj}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${week.course_recommendations && week.course_recommendations.length > 0 ? `
                                    <div class="mb-3">
                                        <strong>Recommended Courses:</strong>
                                        <div class="row mt-2">
                                            ${week.course_recommendations.map(course => `
                                                <div class="col-md-6 mb-2">
                                                    <div class="card border-light">
                                                        <div class="card-body p-2">
                                                            <h6 class="card-title small mb-1">${course.title}</h6>
                                                            <p class="card-text small text-muted mb-1">${course.reason || 'Recommended for your learning path'}</p>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="badge bg-light text-dark small">${course.level}</span>
                                                                <small class="text-success">${Math.round((course.relevance_score || 0.8) * 100)}% match</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${week.activities && week.activities.length > 0 ? `
                                    <div class="mb-3">
                                        <strong>Learning Activities:</strong>
                                        <div class="mt-1">
                                            ${week.activities.map(activity => 
                                                `<span class="badge bg-light text-dark me-1 mb-1">${activity}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="progress-step">
                                    <div class="progress-step-fill" style="width: ${progressPercentage}%"></div>
                                </div>
                                
                                <div class="mt-2">
                                    <span class="badge bg-primary">${week.assessment_type || 'quiz'}</span>
                                    ${isCompleted ? '<span class="badge bg-success ms-1">Completed</span>' : '<span class="badge bg-secondary ms-1">Upcoming</span>'}
                                </div>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-${isCompleted ? 'check-circle' : 'play-circle'} fa-2x text-${isCompleted ? 'success' : 'muted'}"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function extractResourcesFromWeeks(weeks) {
    const resources = [];
    const seenCourses = new Set();
    
    weeks.forEach(week => {
        if (week.course_recommendations) {
            week.course_recommendations.forEach(course => {
                if (!seenCourses.has(course.course_id)) {
                    seenCourses.add(course.course_id);
                    resources.push({
                        id: course.course_id,
                        title: course.title,
                        shortDescription: course.reason || 'Recommended for your learning path',
                        level: course.level,
                        category: course.category || 'General',
                        relevance_score: course.relevance_score || 0.8
                    });
                }
            });
        }
    });
    
    return resources;
}

async function generateRoadmapContent(goal, level, time, styles) {
    console.log('Generating roadmap from database courses for:', { goal, level, time, styles });
    
    // Fetch only database courses
    const databaseCourses = await getRecommendedCourses(goal, level);
    
    // Generate roadmap based only on database courses
    const roadmap = await generateDynamicRoadmap(goal, level, time, styles, databaseCourses);
    
    // Hide loading, show results
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('roadmapResults').style.display = 'block';
    
    // Populate overview with database course info
    let coursesInfo = '';
    if (databaseCourses.length > 0) {
        coursesInfo = `<p class="mb-2">Found <strong>${databaseCourses.length}</strong> courses in our database for your learning path: "${goal}"</p>`;
        // Analyze course content
        const courseAnalysis = analyzeDatabaseCourses(databaseCourses, goal);
        coursesInfo += `<p class="mb-2">Course analysis: ${courseAnalysis}</p>`;
    } else {
        coursesInfo = `<p class="mb-2">No courses found in our database for "${goal}" at ${level} level.</p>`;
    }
    
    document.getElementById('roadmapOverview').innerHTML = `
        <div class="alert alert-${databaseCourses.length > 0 ? 'success' : 'warning'} mb-4">
            <h6><i class="fas fa-${databaseCourses.length > 0 ? 'database' : 'exclamation-triangle'} me-2"></i>
                ${databaseCourses.length > 0 ? 'Database-Based Roadmap Generated!' : 'No Database Courses Available'}
            </h6>
            <p class="mb-0">Your learning path for <strong>${goal}</strong> has been created based on ${databaseCourses.length > 0 ? 'actual courses in our database' : 'no available courses'}.</p>
            ${coursesInfo}
            ${databaseCourses.length === 0 ? '<p class="mb-0">Please check back later as we add new courses to our database.</p>' : ''}
        </div>
        <div class="roadmap-timeline">
            ${roadmap.timeline}
        </div>
    `;
    
    // Populate detailed steps
    document.getElementById('detailedSteps').innerHTML = `
        <div class="list-group">
            ${roadmap.steps.map((step, index) => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">Step ${index + 1}: ${step.title}</h6>
                            <p class="mb-2 text-muted">${step.description}</p>
                            ${step.course ? `<p class="small text-primary"><i class="fas fa-graduation-cap me-1"></i>${step.course}</p>` : ''}
                            <div class="progress-step">
                                <div class="progress-step-fill" style="width: ${step.progress}%"></div>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-primary">${step.duration}</span>
                                <span class="badge bg-info">${step.difficulty}</span>
                                ${databaseCourses.length === 0 ? '<span class="badge bg-secondary">No Courses Available</span>' : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-${step.icon} fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Populate resources section with database courses only
    populateRecommendedResources(databaseCourses, false);
}

// Function to analyze database courses and extract learning themes
function analyzeDatabaseCourses(courses, goal) {
    if (courses.length === 0) return 'No courses to analyze';
    
    const goalLower = goal.toLowerCase();
    const allTitles = courses.map(c => c.title.toLowerCase()).join(' ');
    const allDescriptions = courses.map(c => c.shortDescription.toLowerCase()).join(' ');
    const allContent = (allTitles + ' ' + allDescriptions).toLowerCase();
    
    // Extract key themes from course content
    const themes = [];
    
    // Check for common learning themes
    const themeKeywords = {
        'programming': ['programming', 'code', 'coding', 'development', 'software'],
        'design': ['design', 'ui', 'ux', 'graphic', 'visual', 'creative'],
        'business': ['business', 'marketing', 'management', 'strategy', 'entrepreneur'],
        'data': ['data', 'analytics', 'statistics', 'analysis', 'science'],
        'web': ['web', 'html', 'css', 'javascript', 'frontend', 'backend'],
        'mobile': ['mobile', 'app', 'android', 'ios', 'flutter', 'react native'],
        'video': ['video', 'editing', 'film', 'media', 'production'],
        'writing': ['writing', 'content', 'copywriting', 'blog', 'creative writing'],
        'photography': ['photography', 'photo', 'camera', 'editing', 'composition'],
        'music': ['music', 'audio', 'production', 'mixing', 'mastering']
    };
    
    for (const [theme, keywords] of Object.entries(themeKeywords)) {
        if (keywords.some(keyword => allContent.includes(keyword))) {
            themes.push(theme);
        }
    }
    
    // Determine skill levels available
    const levels = [...new Set(courses.map(c => c.level.toLowerCase()))];
    
    // Determine categories
    const categories = [...new Set(courses.map(c => c.category || 'General'))];
    
    let analysis = `Found ${themes.length > 0 ? themes.join(', ') : 'general'} content`;
    if (levels.length > 0) {
        analysis += ` at ${levels.join('/')} levels`;
    }
    if (categories.length > 0) {
        analysis += ` in ${categories.join('/')} categories`;
    }
    
    return analysis;
}

function populateRecommendedResources(resources, areUserSelected) {
    if (resources.length === 0) {
        document.getElementById('recommendedResources').innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-database me-2"></i>No Database Courses Available</h6>
                <p class="mb-0">No courses found in our database for this learning goal and skill level combination.</p>
                <p class="mb-0">The roadmap above shows a theoretical learning path. Please check back later as we add new courses to our database.</p>
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="window.location.href='/courses'">
                        <i class="fas fa-search me-2"></i>Browse All Available Courses
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    // Display database courses
    const alertMessage = areUserSelected 
        ? `<h6><i class="fas fa-info-circle me-2"></i>Your Selected Courses</h6>
           <p class="mb-0">These are the courses you've manually added to your learning roadmap from our database.</p>`
        : `<h6><i class="fas fa-database me-2"></i>Available Database Courses</h6>
           <p class="mb-0">These courses are available in our database and match your learning goal and skill level.</p>`;
    
    const resourcesHtml = resources.map((course, index) => {
        const badgeType = areUserSelected ? 'success' : 'primary';
        const badgeText = areUserSelected ? 'Selected' : 'Available';
        const actionButton = areUserSelected 
            ? `<button class="btn btn-sm btn-outline-danger" onclick="removeFromRoadmap('${course.id || index}')">
                 <i class="fas fa-times me-1"></i>Remove
               </button>`
            : `<button class="btn btn-sm btn-primary" onclick="addRecommendedCourse('${course.title}', '${course.level}', '${index}')">
                 <i class="fas fa-plus me-1"></i>Add to Roadmap
               </button>`;
        
        return `
            <div class="col-md-6">
                <div class="card border h-100">
                    <div class="card-body">
                        <h6 class="mb-2">${course.title}</h6>
                        <p class="small text-muted mb-2">${course.shortDescription || 'No description available'}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="resource-badge ${badgeType}">${badgeText}</span>
                            <span class="badge bg-light text-dark">${course.level}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">${course.category || 'General'}</span>
                            ${course.price ? `<span class="text-primary fw-bold">$${course.price}</span>` : ''}
                        </div>
                        <div class="mt-2">
                            ${actionButton}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('recommendedResources').innerHTML = `
        <div class="alert alert-${areUserSelected ? 'info' : 'success'} mb-3">
            ${alertMessage}
        </div>
        <div class="row g-3">
            ${resourcesHtml}
        </div>
        ${!areUserSelected ? `
            <div class="text-center mt-3">
                <button class="btn btn-outline-secondary" onclick="window.location.href='/courses'">
                    <i class="fas fa-th me-2"></i>View All Courses in Database
                </button>
            </div>
        ` : ''}
    `;
}

async function addRecommendedCourse(title, level, index) {
    // Add recommended course to selected courses
    const courseId = 'recommended_' + index;
    if (!selectedCourses.find(course => course.id === courseId)) {
        selectedCourses.push({
            id: courseId,
            title: title,
            level: level
        });
        
        showNotification(`${title} added to your roadmap!`, 'success');
        
        // Regenerate roadmap with new selection
        const form = document.getElementById('roadmapForm');
        const formData = new FormData(form);
        const learningGoal = formData.get('learningGoal');
        const currentLevel = formData.get('currentLevel');
        const timeCommitment = formData.get('timeCommitment');
        const learningStyles = formData.getAll('learningStyle');
        
        try {
            await generateRoadmapContent(learningGoal, currentLevel, timeCommitment, learningStyles);
        } catch (error) {
            console.error('Error regenerating roadmap:', error);
            showNotification('Error updating roadmap. Please try again.', 'danger');
        }
    } else {
        showNotification('Course already added to roadmap!', 'warning');
    }
}

async function generateDynamicRoadmap(goal, level, time, styles, courses) {
    const weeks = Math.max(4, Math.ceil(parseInt(time.split('-')[0]) / 2));
    
    // Create timeline based on selected courses or database courses
    let timeline = '';
    let steps = [];
    let coursesToUse = courses.length > 0 ? courses : await getRecommendedCourses(goal, level);
    
    if (coursesToUse.length > 0) {
        // Sort courses by logical progression
        const sortedCourses = sortCoursesByProgression(coursesToUse, level);
        
        // Create learning path with proper progression
        const learningPath = createIntelligentLearningPath(sortedCourses, weeks, level);
        
        learningPath.forEach((weekData, index) => {
            const weekNum = index + 1;
            const isCompleted = index === 0; // First week marked as completed
            
            timeline += `
                <div class="timeline-item ${isCompleted ? 'completed' : ''}">
                    <div class="timeline-content">
                        <div class="timeline-week">Week ${weekNum}</div>
                        <div class="timeline-title">${weekData.title}</div>
                        <div class="timeline-description">${weekData.description}</div>
                        <div class="timeline-resources">
                            <span class="resource-badge primary">Course</span>
                            <span class="resource-badge success">${weekData.focus}</span>
                            <span class="resource-badge info">${weekData.difficulty}</span>
                        </div>
                    </div>
                </div>
            `;
            
            steps.push({
                title: weekData.title,
                description: weekData.description,
                course: weekData.courseTitle,
                duration: `Week ${weekNum}`,
                difficulty: weekData.difficulty,
                progress: isCompleted ? 100 : 0,
                icon: isCompleted ? 'check-circle' : 'play-circle',
                objectives: weekData.objectives || []
            });
        });
    }
    
    // Fill remaining weeks if needed
    for (let i = coursesToUse.length; i < weeks; i++) {
        const weekNum = i + 1;
        const isCompleted = i === 0 && coursesToUse.length === 0;
        
        timeline += `
            <div class="timeline-item ${isCompleted ? 'completed' : ''}">
                <div class="timeline-content">
                    <div class="timeline-week">Week ${weekNum}</div>
                    <div class="timeline-title">${getWeekTopic(weekNum, goal, level)}</div>
                    <div class="timeline-description">${getWeekDescription(weekNum, goal, level)}</div>
                    <div class="timeline-resources">
                        <span class="resource-badge primary">Self-Study</span>
                        <span class="resource-badge success">Practice</span>
                    </div>
                </div>
            </div>
        `;
        
        steps.push({
            title: getWeekTopic(weekNum, goal, level),
            description: getWeekDescription(weekNum, goal, level),
            duration: `Week ${weekNum}`,
            difficulty: level,
            progress: isCompleted ? 100 : 0,
            icon: isCompleted ? 'check-circle' : 'play-circle',
            objectives: []
        });
    }
    
    return {
        timeline: timeline,
        steps: steps,
        resources: coursesToUse
    };
}

function sortCoursesByProgression(courses, userLevel) {
    // Sort courses based on logical learning progression
    return courses.sort((a, b) => {
        // Priority 1: Level appropriateness
        const levelOrder = { 'beginner': 0, 'intermediate': 1, 'advanced': 2 };
        const aLevelScore = Math.abs(levelOrder[a.level.toLowerCase()] - levelOrder[userLevel]);
        const bLevelScore = Math.abs(levelOrder[b.level.toLowerCase()] - levelOrder[userLevel]);
        
        if (aLevelScore !== bLevelScore) {
            return aLevelScore - bLevelScore;
        }
        
        // Priority 2: Course progression indicators
        const aProgression = analyzeCourseProgression(a.title, a.shortDescription);
        const bProgression = analyzeCourseProgression(b.title, b.shortDescription);
        
        if (aProgression !== bProgression) {
            return aProgression - bProgression;
        }
        
        // Priority 3: Practical vs theoretical (prefer practical)
        const aPractical = isPracticalCourse(a.title, a.shortDescription);
        const bPractical = isPracticalCourse(b.title, b.shortDescription);
        
        if (aPractical && !bPractical) return -1;
        if (!aPractical && bPractical) return 1;
        
        // Priority 4: Alphabetical
        return a.title.localeCompare(b.title);
    });
}

function analyzeCourseProgression(title, description) {
    const text = (title + ' ' + description).toLowerCase();
    
    // Early courses indicators
    if (text.includes('fundamentals') || text.includes('introduction') || 
        text.includes('basics') || text.includes('getting started') || 
        text.includes('101') || text.includes('for beginners')) {
        return 0;
    }
    
    // Mid-level courses indicators
    if (text.includes('intermediate') || text.includes('practical') || 
        text.includes('real-world') || text.includes('projects') || 
        text.includes('applications')) {
        return 1;
    }
    
    // Advanced courses indicators
    if (text.includes('advanced') || text.includes('expert') || 
        text.includes('mastery') || text.includes('professional') || 
        text.includes('architecture') || text.includes('patterns')) {
        return 2;
    }
    
    return 1; // Default to intermediate
}

function isPracticalCourse(title, description) {
    const text = (title + ' ' + description).toLowerCase();
    
    const practicalKeywords = ['hands-on', 'project', 'practice', 'build', 'create', 
                              'implement', 'code', 'workshop', 'lab', 'tutorial'];
    
    return practicalKeywords.some(keyword => text.includes(keyword));
}

function createIntelligentLearningPath(sortedCourses, weeks, userLevel) {
    const learningPath = [];
    
    // Create logical learning progression
    for (let i = 0; i < Math.min(sortedCourses.length, weeks); i++) {
        const course = sortedCourses[i];
        const weekNum = i + 1;
        
        // Generate intelligent week content based on course analysis
        const weekData = generateWeekContent(course, weekNum, userLevel, i === 0);
        learningPath.push(weekData);
    }
    
    return learningPath;
}

function generateWeekContent(course, weekNum, userLevel, isFirstWeek) {
    const courseTitle = course.title;
    const courseDescription = course.shortDescription || '';
    const courseLevel = course.level;
    
    // Analyze course content to generate appropriate week focus
    const focus = determineCourseFocus(courseTitle, courseDescription);
    const objectives = generateLearningObjectives(courseTitle, courseDescription, weekNum);
    
    // Generate intelligent description
    let description = '';
    if (isFirstWeek) {
        description = `Start your ${userLevel} journey with ${courseTitle}. ${courseDescription}`;
    } else {
        description = `Continue your learning path with ${courseTitle}. ${courseDescription}`;
    }
    
    return {
        title: courseTitle,
        description: description,
        courseTitle: courseTitle,
        focus: focus,
        difficulty: courseLevel,
        objectives: objectives
    };
}

function determineCourseFocus(title, description) {
    const text = (title + ' ' + description).toLowerCase();
    
    if (text.includes('fundamentals') || text.includes('basics') || text.includes('introduction')) {
        return 'Foundations';
    } else if (text.includes('practical') || text.includes('hands-on') || text.includes('project')) {
        return 'Practice';
    } else if (text.includes('advanced') || text.includes('expert') || text.includes('mastery')) {
        return 'Advanced';
    } else if (text.includes('theory') || text.includes('concepts') || text.includes('principles')) {
        return 'Theory';
    } else {
        return 'Comprehensive';
    }
}

function generateLearningObjectives(title, description, weekNum) {
    const objectives = [];
    
    // Extract potential objectives from course content
    const text = (title + ' ' + description).toLowerCase();
    
    if (text.includes('html') || text.includes('css')) {
        objectives.push('Master HTML5 and CSS3 fundamentals');
    }
    if (text.includes('javascript')) {
        objectives.push('Learn JavaScript programming concepts');
    }
    if (text.includes('react') || text.includes('vue') || text.includes('angular')) {
        objectives.push('Build modern web applications');
    }
    if (text.includes('python')) {
        objectives.push('Master Python programming');
    }
    if (text.includes('database') || text.includes('sql')) {
        objectives.push('Understand database design and management');
    }
    if (text.includes('mobile') || text.includes('android') || text.includes('ios')) {
        objectives.push('Create mobile applications');
    }
    
    // Add generic objective if none found
    if (objectives.length === 0) {
        objectives.push('Complete course learning objectives');
    }
    
    return objectives;
}

async function getRecommendedCourses(goal, level) {
    console.log('Fetching database courses for:', { goal, level });
    
    try {
        // Add multiple cache-busting parameters to prevent any caching
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        const response = await fetch(`/api/courses/recommendations?goal=${encodeURIComponent(goal)}&level=${level}&_t=${timestamp}&_r=${random}`, {
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Database courses response:', data);
        
        // Only return courses from database - no fallback generation
        if (data.courses && data.courses.length > 0) {
            return data.courses.map(course => ({
                id: course.id.toString(),
                title: course.title,
                level: course.level,
                category: course.category || 'General',
                shortDescription: course.shortDescription || 'No description available',
                price: course.price,
                thumbnailUrl: course.thumbnailUrl
            }));
        }
        
        // Return empty array if no database courses found
        console.log('No courses found in database for:', { goal, level });
        return [];
        
    } catch (error) {
        console.error('Error fetching database courses:', error);
        // Return empty array on error - no fallback courses
        return [];
    }
}

function generateGoalSpecificCourses(goal, level) {
    const goalLower = goal.toLowerCase();
    
    // Generate goal-appropriate courses
    if (goalLower.includes('web development') || goalLower.includes('web')) {
        return [
            { id: 'web-1', title: 'HTML & CSS Fundamentals', level: 'Beginner', category: 'Web Development', shortDescription: 'Master the building blocks of web development' },
            { id: 'web-2', title: 'JavaScript Essentials', level: 'Beginner', category: 'Web Development', shortDescription: 'Learn programming fundamentals with JavaScript' },
            { id: 'web-3', title: 'Responsive Web Design', level: 'Intermediate', category: 'Web Development', shortDescription: 'Create websites that work on all devices' },
            { id: 'web-4', title: 'Modern Frontend Frameworks', level: 'Advanced', category: 'Web Development', shortDescription: 'Master React, Vue, or Angular' }
        ];
    } else if (goalLower.includes('data science') || goalLower.includes('data')) {
        return [
            { id: 'ds-1', title: 'Python for Data Science', level: 'Beginner', category: 'Data Science', shortDescription: 'Learn Python programming for data analysis' },
            { id: 'ds-2', title: 'Statistics Fundamentals', level: 'Beginner', category: 'Data Science', shortDescription: 'Master statistical concepts for data analysis' },
            { id: 'ds-3', title: 'Machine Learning Basics', level: 'Intermediate', category: 'Data Science', shortDescription: 'Introduction to ML algorithms and techniques' },
            { id: 'ds-4', title: 'Data Visualization', level: 'Intermediate', category: 'Data Science', shortDescription: 'Create compelling data visualizations' }
        ];
    } else if (goalLower.includes('mobile') || goalLower.includes('app')) {
        return [
            { id: 'mob-1', title: 'Mobile App Development Basics', level: 'Beginner', category: 'Mobile Development', shortDescription: 'Introduction to mobile app concepts' },
            { id: 'mob-2', title: 'Android Development', level: 'Intermediate', category: 'Mobile Development', shortDescription: 'Build native Android applications' },
            { id: 'mob-3', title: 'iOS Development with Swift', level: 'Intermediate', category: 'Mobile Development', shortDescription: 'Create iOS apps with Swift' },
            { id: 'mob-4', title: 'Cross-Platform Development', level: 'Advanced', category: 'Mobile Development', shortDescription: 'Build apps for both iOS and Android' }
        ];
    } else if (goalLower.includes('video editing') || goalLower.includes('video') || goalLower.includes('editing') || goalLower.includes('film') || goalLower.includes('youtube')) {
        return [
            { id: 'video-1', title: 'Video Editing Fundamentals', level: 'Beginner', category: 'Video Production', shortDescription: 'Learn the basics of video editing and terminology' },
            { id: 'video-2', title: 'Adobe Premiere Pro Basics', level: 'Beginner', category: 'Video Production', shortDescription: 'Master industry-standard video editing software' },
            { id: 'video-3', title: 'Color Correction & Grading', level: 'Intermediate', category: 'Video Production', shortDescription: 'Professional color grading techniques' },
            { id: 'video-4', title: 'Advanced Video Effects & Motion Graphics', level: 'Advanced', category: 'Video Production', shortDescription: 'Create stunning visual effects and animations' }
        ];
    } else if (goalLower.includes('graphic design') || goalLower.includes('design') || goalLower.includes('photoshop') || goalLower.includes('illustrator')) {
        return [
            { id: 'design-1', title: 'Graphic Design Principles', level: 'Beginner', category: 'Design', shortDescription: 'Master fundamental design concepts and principles' },
            { id: 'design-2', title: 'Adobe Photoshop Essentials', level: 'Beginner', category: 'Design', shortDescription: 'Learn photo editing and digital imaging' },
            { id: 'design-3', title: 'Typography & Layout Design', level: 'Intermediate', category: 'Design', shortDescription: 'Create professional layouts and typography' },
            { id: 'design-4', title: 'Brand Identity Design', level: 'Advanced', category: 'Design', shortDescription: 'Develop complete brand identities and logos' }
        ];
    } else if (goalLower.includes('photography') || goalLower.includes('photo') || goalLower.includes('camera')) {
        return [
            { id: 'photo-1', title: 'Photography Fundamentals', level: 'Beginner', category: 'Photography', shortDescription: 'Master camera settings and composition techniques' },
            { id: 'photo-2', title: 'Portrait Photography', level: 'Intermediate', category: 'Photography', shortDescription: 'Learn professional portrait lighting and posing' },
            { id: 'photo-3', title: 'Photo Editing with Lightroom', level: 'Intermediate', category: 'Photography', shortDescription: 'Professional photo editing and workflow' },
            { id: 'photo-4', title: 'Advanced Photography Techniques', level: 'Advanced', category: 'Photography', shortDescription: 'Master advanced composition and creative techniques' }
        ];
    } else if (goalLower.includes('music production') || goalLower.includes('music') || goalLower.includes('audio') || goalLower.includes('mixing')) {
        return [
            { id: 'music-1', title: 'Music Production Basics', level: 'Beginner', category: 'Music Production', shortDescription: 'Introduction to music production and DAW software' },
            { id: 'music-2', title: 'Audio Engineering Fundamentals', level: 'Beginner', category: 'Music Production', shortDescription: 'Learn recording techniques and audio basics' },
            { id: 'music-3', title: 'Mixing & Mastering', level: 'Intermediate', category: 'Music Production', shortDescription: 'Professional mixing and mastering techniques' },
            { id: 'music-4', title: 'Advanced Music Production', level: 'Advanced', category: 'Music Production', shortDescription: 'Advanced production techniques and sound design' }
        ];
    } else if (goalLower.includes('writing') || goalLower.includes('content') || goalLower.includes('blog') || goalLower.includes('copywriting')) {
        return [
            { id: 'write-1', title: 'Creative Writing Fundamentals', level: 'Beginner', category: 'Writing', shortDescription: 'Master the fundamentals of creative writing' },
            { id: 'write-2', title: 'Content Writing for Digital Media', level: 'Intermediate', category: 'Writing', shortDescription: 'Write compelling content for websites and social media' },
            { id: 'write-3', title: 'Copywriting & Persuasion', level: 'Intermediate', category: 'Writing', shortDescription: 'Learn persuasive writing and marketing copy' },
            { id: 'write-4', title: 'Advanced Storytelling Techniques', level: 'Advanced', category: 'Writing', shortDescription: 'Master advanced narrative and storytelling techniques' }
        ];
    } else if (goalLower.includes('marketing') || goalLower.includes('digital marketing') || goalLower.includes('seo') || goalLower.includes('social media')) {
        return [
            { id: 'market-1', title: 'Digital Marketing Fundamentals', level: 'Beginner', category: 'Marketing', shortDescription: 'Learn the basics of digital marketing strategies' },
            { id: 'market-2', title: 'Social Media Marketing', level: 'Intermediate', category: 'Marketing', shortDescription: 'Master social media platforms and engagement' },
            { id: 'market-3', title: 'SEO & Content Strategy', level: 'Intermediate', category: 'Marketing', shortDescription: 'Optimize content for search engines' },
            { id: 'market-4', title: 'Advanced Marketing Analytics', level: 'Advanced', category: 'Marketing', shortDescription: 'Data-driven marketing and ROI optimization' }
        ];
    } else {
        // General/other courses - make them more relevant to the goal
        const goalName = goal.charAt(0).toUpperCase() + goal.slice(1);
        return [
            { id: 'gen-1', title: `${goalName} Fundamentals`, level: level, category: 'General', shortDescription: `Learn the basic concepts and fundamentals of ${goal}` },
            { id: 'gen-2', title: `Practical ${goalName} Applications`, level: level, category: 'General', shortDescription: `Apply ${goal} concepts in real-world scenarios` },
            { id: 'gen-3', title: `Advanced ${goalName} Techniques`, level: 'Intermediate', category: 'General', shortDescription: `Master advanced techniques and best practices in ${goal}` },
            { id: 'gen-4', title: `${goalName} Mastery & Specialization`, level: 'Advanced', category: 'General', shortDescription: `Become an expert in ${goal} with specialized knowledge` }
        ];
    }
}

function getWeekTopic(week, goal, level) {
    const goalLower = goal.toLowerCase();
    
    // Video Editing specific topics
    if (goalLower.includes('video editing') || goalLower.includes('video') || goalLower.includes('editing')) {
        const videoTopics = {
            'beginner': ['Video Editing Basics', 'Software Introduction', 'Basic Cuts & Transitions', 'Audio Fundamentals'],
            'intermediate': ['Advanced Editing Techniques', 'Color Correction Basics', 'Motion Graphics Intro', 'Project Organization'],
            'advanced': ['Professional Color Grading', 'Visual Effects Mastery', 'Advanced Motion Graphics', 'Workflow Optimization']
        };
        const levelTopics = videoTopics[level] || videoTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Graphic Design specific topics
    if (goalLower.includes('graphic design') || goalLower.includes('design')) {
        const designTopics = {
            'beginner': ['Design Principles', 'Color Theory', 'Typography Basics', 'Layout Fundamentals'],
            'intermediate': ['Advanced Typography', 'Brand Design', 'Digital Illustration', 'UI/UX Basics'],
            'advanced': ['Brand Strategy', 'Advanced Illustration', 'Motion Design', 'Design Systems']
        };
        const levelTopics = designTopics[level] || designTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Photography specific topics
    if (goalLower.includes('photography') || goalLower.includes('photo')) {
        const photoTopics = {
            'beginner': ['Camera Basics', 'Composition Rules', 'Lighting Fundamentals', 'Basic Editing'],
            'intermediate': ['Advanced Composition', 'Portrait Lighting', 'Post-Processing', 'Genre Specialization'],
            'advanced': ['Professional Techniques', 'Advanced Editing', 'Business Skills', 'Creative Development']
        };
        const levelTopics = photoTopics[level] || photoTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Music Production specific topics
    if (goalLower.includes('music production') || goalLower.includes('music')) {
        const musicTopics = {
            'beginner': ['DAW Basics', 'Music Theory', 'Recording Fundamentals', 'Basic Mixing'],
            'intermediate': ['Advanced Recording', 'Mixing Techniques', 'Sound Design', 'Arrangement'],
            'advanced': ['Mastering', 'Advanced Production', 'Genre Techniques', 'Professional Workflow']
        };
        const levelTopics = musicTopics[level] || musicTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Writing specific topics
    if (goalLower.includes('writing') || goalLower.includes('content')) {
        const writingTopics = {
            'beginner': ['Writing Fundamentals', 'Grammar & Style', 'Content Structure', 'Audience Analysis'],
            'intermediate': ['Advanced Writing', 'SEO Writing', 'Content Strategy', 'Brand Voice'],
            'advanced': ['Creative Writing', 'Copywriting Mastery', 'Content Marketing', 'Publishing']
        };
        const levelTopics = writingTopics[level] || writingTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Marketing specific topics
    if (goalLower.includes('marketing')) {
        const marketingTopics = {
            'beginner': ['Marketing Basics', 'Target Audience', 'Content Marketing', 'Social Media'],
            'intermediate': ['SEO Fundamentals', 'Email Marketing', 'Analytics', 'Campaign Strategy'],
            'advanced': ['Advanced Analytics', 'Marketing Automation', 'Strategy Development', 'ROI Optimization']
        };
        const levelTopics = marketingTopics[level] || marketingTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Web Development specific topics
    if (goalLower.includes('web development') || goalLower.includes('web')) {
        const webTopics = {
            'beginner': ['HTML & CSS Basics', 'JavaScript Fundamentals', 'Web Design Principles', 'Basic Projects'],
            'intermediate': ['Advanced JavaScript', 'Frontend Frameworks', 'Backend Basics', 'Database Design'],
            'advanced': ['Full-Stack Development', 'Performance Optimization', 'Security', 'DevOps Basics']
        };
        const levelTopics = webTopics[level] || webTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Data Science specific topics
    if (goalLower.includes('data science') || goalLower.includes('data')) {
        const dataTopics = {
            'beginner': ['Python Basics', 'Statistics Fundamentals', 'Data Analysis', 'Visualization'],
            'intermediate': ['Machine Learning Basics', 'Advanced Statistics', 'Data Cleaning', 'Feature Engineering'],
            'advanced': ['Deep Learning', 'Advanced ML', 'Big Data', 'Model Deployment']
        };
        const levelTopics = dataTopics[level] || dataTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Mobile Development specific topics
    if (goalLower.includes('mobile') || goalLower.includes('app')) {
        const mobileTopics = {
            'beginner': ['Mobile Basics', 'UI/UX Principles', 'Platform Fundamentals', 'Basic Development'],
            'intermediate': ['Native Development', 'Cross-Platform', 'App Architecture', 'Testing'],
            'advanced': ['Advanced Features', 'Performance', 'Security', 'App Store Optimization']
        };
        const levelTopics = mobileTopics[level] || mobileTopics['beginner'];
        return levelTopics[week - 1] || `Week ${week} Topic`;
    }
    
    // Default generic topics
    const topics = {
        'beginner': ['Foundation Basics', 'Core Concepts', 'Practical Skills', 'Advanced Topics'],
        'intermediate': ['Review Fundamentals', 'Advanced Techniques', 'Real-world Projects', 'Specialization'],
        'advanced': ['Expert Review', 'Specialized Topics', 'Industry Applications', 'Mastery']
    };
    
    const levelTopics = topics[level] || topics['beginner'];
    return levelTopics[week - 1] || `Week ${week} Topic`;
}

function getWeekDescription(week, goal, level) {
    const goalLower = goal.toLowerCase();
    
    // Video Editing specific descriptions
    if (goalLower.includes('video editing') || goalLower.includes('video') || goalLower.includes('editing')) {
        const videoDescriptions = {
            'beginner': [
                'Learn the fundamentals of video editing and understand the workflow',
                'Master industry-standard editing software and basic techniques',
                'Practice cutting, transitions, and basic audio synchronization',
                'Apply your skills to create a complete video project'
            ],
            'intermediate': [
                'Enhance your editing skills with advanced techniques and effects',
                'Learn professional color correction and audio mixing',
                'Introduction to motion graphics and visual effects',
                'Work on complex projects with professional workflows'
            ],
            'advanced': [
                'Master professional color grading and visual effects',
                'Create advanced motion graphics and animations',
                'Optimize workflow for high-volume production',
                'Develop your unique editing style and portfolio'
            ]
        };
        const levelDescriptions = videoDescriptions[level] || videoDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Graphic Design specific descriptions
    if (goalLower.includes('graphic design') || goalLower.includes('design')) {
        const designDescriptions = {
            'beginner': [
                'Master fundamental design principles and color theory',
                'Learn typography basics and layout composition',
                'Practice with basic design tools and software',
                'Create your first design projects with proper guidance'
            ],
            'intermediate': [
                'Develop advanced typography and layout skills',
                'Learn brand design and visual identity creation',
                'Master digital illustration techniques',
                'Apply design thinking to real-world projects'
            ],
            'advanced': [
                'Create comprehensive brand systems and guidelines',
                'Master advanced illustration and motion design',
                'Develop design systems and UI/UX expertise',
                'Build a professional design portfolio'
            ]
        };
        const levelDescriptions = designDescriptions[level] || designDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Photography specific descriptions
    if (goalLower.includes('photography') || goalLower.includes('photo')) {
        const photoDescriptions = {
            'beginner': [
                'Master camera settings and understand exposure triangle',
                'Learn composition rules and lighting fundamentals',
                'Practice basic photo editing and enhancement',
                'Apply techniques to various photography genres'
            ],
            'intermediate': [
                'Develop advanced composition and creative techniques',
                'Master portrait lighting and posing techniques',
                'Learn professional post-processing workflows',
                'Specialize in your preferred photography genre'
            ],
            'advanced': [
                'Master professional photography techniques and styles',
                'Develop advanced editing and retouching skills',
                'Learn photography business and client management',
                'Create a professional photography portfolio'
            ]
        };
        const levelDescriptions = photoDescriptions[level] || photoDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Music Production specific descriptions
    if (goalLower.includes('music production') || goalLower.includes('music')) {
        const musicDescriptions = {
            'beginner': [
                'Learn digital audio workstation basics and navigation',
                'Understand fundamental music theory for producers',
                'Practice basic recording and mixing techniques',
                'Create your first complete music production'
            ],
            'intermediate': [
                'Master advanced recording and microphone techniques',
                'Develop professional mixing and sound design skills',
                'Learn arrangement and music production workflows',
                'Produce music in your preferred genre'
            ],
            'advanced': [
                'Master professional mixing and mastering techniques',
                'Develop advanced sound design and synthesis skills',
                'Learn music business and distribution strategies',
                'Create a professional music production portfolio'
            ]
        };
        const levelDescriptions = musicDescriptions[level] || musicDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Writing specific descriptions
    if (goalLower.includes('writing') || goalLower.includes('content')) {
        const writingDescriptions = {
            'beginner': [
                'Master writing fundamentals and grammar essentials',
                'Learn content structure and audience analysis',
                'Practice different writing styles and formats',
                'Create engaging content for various platforms'
            ],
            'intermediate': [
                'Develop advanced writing and storytelling techniques',
                'Master SEO writing and content optimization',
                'Learn brand voice and content strategy',
                'Write compelling copy for marketing purposes'
            ],
            'advanced': [
                'Master creative writing and advanced storytelling',
                'Develop content marketing and strategy expertise',
                'Learn publishing and content distribution',
                'Build a professional writing portfolio'
            ]
        };
        const levelDescriptions = writingDescriptions[level] || writingDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Marketing specific descriptions
    if (goalLower.includes('marketing')) {
        const marketingDescriptions = {
            'beginner': [
                'Learn marketing fundamentals and core concepts',
                'Understand target audience and market research',
                'Master content marketing and social media basics',
                'Create your first marketing campaigns'
            ],
            'intermediate': [
                'Develop SEO and analytics expertise',
                'Master email marketing and automation',
                'Learn campaign strategy and optimization',
                'Analyze and improve marketing performance'
            ],
            'advanced': [
                'Master advanced analytics and marketing automation',
                'Develop comprehensive marketing strategies',
                'Learn ROI optimization and budget management',
                'Lead marketing teams and strategic initiatives'
            ]
        };
        const levelDescriptions = marketingDescriptions[level] || marketingDescriptions['beginner'];
        return levelDescriptions[week - 1] || `Continue learning ${goal}`;
    }
    
    // Default generic descriptions
    const descriptions = {
        'beginner': [
            'Learn fundamental concepts and terminology',
            'Understand main principles and theories',
            'Apply concepts through hands-on exercises',
            'Explore advanced features and best practices'
        ],
        'intermediate': [
            'Strengthen existing knowledge base',
            'Master complex techniques and patterns',
            'Build real-world applications',
            'Focus on specialized areas of interest'
        ],
        'advanced': [
            'Review and refine expert knowledge',
            'Dive into specialized advanced topics',
            'Apply skills to industry-level projects',
            'Achieve mastery and innovation'
        ]
    };
    
    const levelDescriptions = descriptions[level] || descriptions['beginner'];
    return levelDescriptions[week - 1] || `Continue learning progression for ${goal}`;
}

function generateSampleRoadmap(goal, level, time, styles) {
    // This is a sample roadmap generator - in production, this would call an AI service
    const weeks = Math.max(4, Math.ceil(parseInt(time.split('-')[0]) / 2));
    
    const roadmap = {
        timeline: '',
        steps: [],
        resources: []
    };
    
    // Generate timeline
    for (let i = 1; i <= weeks; i++) {
        const step = generateStepForWeek(i, goal, level);
        roadmap.timeline += `
            <div class="timeline-item ${i <= 2 ? 'completed' : ''}">
                <div class="timeline-content">
                    <div class="timeline-week">Week ${i}</div>
                    <div class="timeline-title">${step.title}</div>
                    <div class="timeline-description">${step.description}</div>
                    <div class="timeline-resources">
                        ${step.resources.map(res => `<span class="resource-badge primary">${res}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
        
        roadmap.steps.push(step);
    }
    
    // Generate resources
    roadmap.resources = generateResources(goal, level);
    
    return roadmap;
}

function generateStepForWeek(week, goal, level) {
    const steps = {
        beginner: [
            { title: 'Foundation Basics', description: 'Learn the fundamental concepts and terminology', icon: 'book', duration: '2-3 days', difficulty: 'Beginner', progress: week <= 2 ? 100 : 0, resources: ['Documentation', 'Videos', 'Exercises'] },
            { title: 'Core Concepts', description: 'Understand the main principles and theories', icon: 'graduation-cap', duration: '3-4 days', difficulty: 'Beginner', progress: week <= 3 ? 100 : 0, resources: ['Tutorials', 'Examples', 'Quizzes'] },
            { title: 'Practical Application', description: 'Apply concepts through hands-on exercises', icon: 'code', duration: '4-5 days', difficulty: 'Intermediate', progress: week <= 4 ? 100 : 0, resources: ['Projects', 'Code Labs', 'Practice'] },
            { title: 'Advanced Topics', description: 'Explore advanced features and best practices', icon: 'rocket', duration: '5-7 days', difficulty: 'Advanced', progress: week <= 5 ? 100 : 0, resources: ['Advanced Docs', 'Case Studies', 'Best Practices'] }
        ],
        intermediate: [
            { title: 'Advanced Foundations', description: 'Build on existing knowledge with advanced concepts', icon: 'book', duration: '2-3 days', difficulty: 'Intermediate', progress: week <= 2 ? 100 : 0, resources: ['Advanced Guides', 'Technical Docs'] },
            { title: 'Specialized Topics', description: 'Focus on specialized areas within the field', icon: 'microscope', duration: '3-4 days', difficulty: 'Intermediate', progress: week <= 3 ? 100 : 0, resources: ['Specialized Content', 'Research Papers'] },
            { title: 'Real-world Projects', description: 'Apply skills to practical, real-world scenarios', icon: 'project-diagram', duration: '4-6 days', difficulty: 'Advanced', progress: week <= 4 ? 100 : 0, resources: ['Project Templates', 'Case Studies'] },
            { title: 'Optimization & Performance', description: 'Learn optimization techniques and performance tuning', icon: 'tachometer-alt', duration: '6-7 days', difficulty: 'Advanced', progress: week <= 6 ? 100 : 0, resources: ['Performance Guides', 'Optimization Tools'] }
        ],
        advanced: [
            { title: 'Expert-level Concepts', description: 'Master complex and expert-level topics', icon: 'brain', duration: '2-3 days', difficulty: 'Advanced', progress: week <= 2 ? 100 : 0, resources: ['Expert Content', 'Research Papers'] },
            { title: 'Industry Best Practices', description: 'Learn industry standards and best practices', icon: 'award', duration: '3-4 days', difficulty: 'Expert', progress: week <= 3 ? 100 : 0, resources: ['Industry Standards', 'Best Practice Guides'] },
            { title: 'Innovation & Research', description: 'Explore cutting-edge research and innovations', icon: 'lightbulb', duration: '4-5 days', difficulty: 'Expert', progress: week <= 4 ? 100 : 0, resources: ['Research Papers', 'Innovation Labs'] },
            { title: 'Leadership & Mentoring', description: 'Develop leadership skills and mentoring abilities', icon: 'users', duration: '5-7 days', difficulty: 'Expert', progress: week <= 5 ? 100 : 0, resources: ['Leadership Guides', 'Mentoring Resources'] }
        ]
    };
    
    return steps[level][week - 1] || steps.beginner[week - 1];
}

function generateResources(goal, level) {
    const baseResources = [
        { title: 'Official Documentation', description: 'Comprehensive guides and API references', type: 'Documentation', link: '#' },
        { title: 'Video Tutorials', description: 'Step-by-step video learning content', type: 'Video', link: '#' },
        { title: 'Practice Exercises', description: 'Hands-on exercises and challenges', type: 'Practice', link: '#' },
        { title: 'Community Forums', description: 'Connect with other learners and experts', type: 'Community', link: '#' },
        { title: 'Code Repository', description: 'Sample code and project templates', type: 'Code', link: '#' }
    ];
    
    // Add goal-specific resources
    if (goal.toLowerCase().includes('web development')) {
        baseResources.push(
            { title: 'MDN Web Docs', description: 'Comprehensive web development documentation', type: 'Documentation', link: 'https://developer.mozilla.org' },
            { title: 'FreeCodeCamp', description: 'Interactive coding challenges and certifications', type: 'Practice', link: 'https://www.freecodecamp.org' },
            { title: 'Stack Overflow', description: 'Developer community and Q&A', type: 'Community', link: 'https://stackoverflow.com' }
        );
    } else if (goal.toLowerCase().includes('data science')) {
        baseResources.push(
            { title: 'Kaggle', description: 'Datasets and machine learning competitions', type: 'Practice', link: 'https://www.kaggle.com' },
            { title: 'Papers with Code', description: 'Research papers with implementations', type: 'Documentation', link: 'https://paperswithcode.com' }
        );
    }
    
    return baseResources;
}

function downloadRoadmap() {
    // Create downloadable content
    const roadmapContent = document.getElementById('roadmapOverview').innerText;
    const blob = new Blob([roadmapContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'learning-roadmap.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function shareRoadmap() {
    // Share functionality (could integrate with social sharing APIs)
    if (navigator.share) {
        navigator.share({
            title: 'My AI Learning Roadmap',
            text: 'Check out my personalized learning roadmap!',
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        const roadmapContent = document.getElementById('roadmapOverview').innerText;
        navigator.clipboard.writeText(roadmapContent).then(() => {
            alert('Roadmap copied to clipboard!');
        });
    }
}

function startLearning() {
    // Redirect to first course or learning path
    window.location.href = '/student-courses';
}

// Function to check if a learning goal is learnable
function isLearnableGoal(goal) {
    const goalLower = goal.toLowerCase().trim();
    
    // Non-learnable patterns
    const nonLearnablePatterns = [
        'hello', 'hi', 'bonjour', 'greetings', 'goodbye', 'thanks', 'merci',
        'test', 'testing', 'demo', 'sample', 'example',
        'random', 'asdf', 'qwerty', '123', 'test123',
        'lol', 'haha', 'omg', 'wow', 'nice', 'cool'
    ];
    
    // Check if goal matches non-learnable patterns
    for (const pattern of nonLearnablePatterns) {
        if (goalLower === pattern || goalLower.includes(pattern)) {
            return false;
        }
    }
    
    // Check if goal is too short or contains only special characters
    if (goalLower.length < 3 || /^[^a-zA-Z]+$/.test(goalLower)) {
        return false;
    }
    
    // Check if goal contains learnable keywords
    const learnableKeywords = [
        'learn', 'study', 'master', 'understand', 'develop', 'create', 'build', 'design',
        'programming', 'coding', 'web', 'data', 'science', 'machine learning', 'ai',
        'video', 'editing', 'graphic', 'design', 'music', 'art', 'writing', 'business',
        'marketing', 'finance', 'health', 'fitness', 'language', 'math', 'physics',
        'chemistry', 'biology', 'history', 'psychology', 'philosophy', 'cooking',
        'photography', 'mobile', 'app', 'game', 'database', 'security', 'cloud',
        'devops', 'testing', 'analysis', 'research', 'teaching', 'speaking',
        'drawing', 'painting', 'sculpture', 'dance', 'singing', 'acting'
    ];
    
    for (const keyword of learnableKeywords) {
        if (goalLower.includes(keyword)) {
            return true;
        }
    }
    
    // If no learnable keywords found, but goal is reasonable length, assume it's learnable
    return goalLower.length >= 5;
}

// Function to show message for non-learnable goals
function showNotLearnableMessage(goal) {
    document.getElementById('roadmapResults').style.display = 'block';
    document.getElementById('roadmapResults').innerHTML = `
        <div class="alert alert-warning text-center">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Sorry, We Can't Create a Learning Path for This</h5>
            <p class="mb-3">We couldn't recognize "<strong>${goal}</strong>" as a learnable skill or topic.</p>
            <p class="mb-3">Our AI creates learning roadmaps for skills like:</p>
            <div class="row justify-content-center mb-3">
                <div class="col-md-8">
                    <div class="row g-2">
                        <div class="col-6 text-start">
                            <small> Web Development</small><br>
                            <small> Data Science</small><br>
                            <small> Machine Learning</small><br>
                            <small> Video Editing</small>
                        </div>
                        <div class="col-6 text-start">
                            <small> Graphic Design</small><br>
                            <small> Mobile Development</small><br>
                            <small> Digital Marketing</small><br>
                            <small> Business Skills</small>
                        </div>
                    </div>
                </div>
            </div>
            <p class="mb-3"><strong>Please try a different learning goal or browse our available courses.</strong></p>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-primary" onclick="window.location.href='/courses'">
                    <i class="fas fa-search me-2"></i>Browse Courses
                </button>
                <button class="btn btn-outline-secondary" onclick="resetRoadmap()">
                    <i class="fas fa-redo me-2"></i>Try Again
                </button>
            </div>
        </div>
    `;
    
    showNotification(`"${goal}" is not a recognized learning topic. Please try something else!`, 'warning');
}

// Reset roadmap function
function resetRoadmap() {
    if (confirm('Are you sure you want to reset this roadmap? This will clear all current data and you can start over with new learning goals.')) {
        // Clear all caches and storage
        clearAllCaches();
        
        // Clear form
        const form = document.getElementById('roadmapForm');
        if (form) {
            form.reset();
        }
        
        // Clear results
        const roadmapResults = document.getElementById('roadmapResults');
        if (roadmapResults) {
            roadmapResults.style.display = 'none';
            roadmapResults.innerHTML = '';
        }
        
        // Clear loading state
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
        
        // Reset global variables
        selectedCourses = [];
        
        // Clear roadmap containers safely
        const roadmapOverview = document.getElementById('roadmapOverview');
        if (roadmapOverview) {
            roadmapOverview.innerHTML = '';
        }
        
        const detailedSteps = document.getElementById('detailedSteps');
        if (detailedSteps) {
            detailedSteps.innerHTML = '';
        }
        
        const recommendedResources = document.getElementById('recommendedResources');
        if (recommendedResources) {
            recommendedResources.innerHTML = '';
        }
        
        // Show notification
        showNotification('Roadmap reset successfully. All caches cleared. You can now create a new learning path!', 'info');
        
        // Scroll to top of form
        if (form) {
            form.scrollIntoView({ behavior: 'smooth' });
        }
    }
}

// Function to clear all caches
function clearAllCaches() {
    // Clear browser storage
    localStorage.clear();
    sessionStorage.clear();
    
    // Clear any service worker caches
    if ('caches' in window) {
        caches.keys().then(function(names) {
            names.forEach(function(name) {
                caches.delete(name);
            });
        });
    }
    
    // Unregister service workers
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            registrations.forEach(function(registration) {
                registration.unregister();
            });
        });
    }
    
    // Force reload of page resources
    const links = document.querySelectorAll("link[rel='stylesheet'], link[rel='preload'], script[src]");
    links.forEach(link => {
        const href = link.href || link.src;
        if (href) {
            const url = new URL(href, window.location.origin);
            url.searchParams.set('_v', Date.now());
            if (link.href) link.href = url.toString();
            if (link.src) link.src = url.toString();
        }
    });
    
    console.log('All caches cleared');
}

// Save roadmap to database function
async function saveRoadmapToDatabase(event) {
    try {
        // Get current roadmap data
        const roadmapOverview = document.getElementById('roadmapOverview');
        const detailedSteps = document.getElementById('detailedSteps');
        
        if (!roadmapOverview.innerHTML.trim()) {
            showNotification('No roadmap data to save. Please generate a roadmap first.', 'warning');
            return;
        }
        
        // Show loading state
        const saveButton = event.target;
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        saveButton.disabled = true;
        
        // Collect form data
        const form = document.getElementById('roadmapForm');
        const formData = new FormData(form);
        
        const roadmapData = {
            learning_goal: formData.get('learningGoal'),
            skill_level: formData.get('currentLevel'),
            time_commitment: formData.get('timeCommitment'),
            learning_styles: formData.getAll('learningStyle'),
            roadmap_content: {
                overview: roadmapOverview.innerHTML,
                detailed_steps: detailedSteps.innerHTML,
                resources: document.getElementById('recommendedResources').innerHTML
            },
            generated_at: new Date().toISOString()
        };
        
        // Send to backend
        const timestamp = new Date().getTime();
        const random = Math.random().toString(36).substring(7);
        
        const response = await fetch(`/api/roadmap/save?_t=${timestamp}&_r=${random}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: JSON.stringify(roadmapData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Roadmap saved successfully! You can access it from your dashboard.', 'success');
            
            // Update button to show saved status
            saveButton.innerHTML = '<i class="fas fa-check me-2"></i>Saved';
            saveButton.classList.remove('btn-success');
            saveButton.classList.add('btn-outline-success');
            
            // Optionally redirect to dashboard after a delay
            setTimeout(() => {
                if (confirm('Roadmap saved! Would you like to view your dashboard to see all saved roadmaps?')) {
                    window.location.href = '/student-dashboard';
                }
            }, 2000);
            
        } else {
            throw new Error(result.error || 'Failed to save roadmap');
        }
        
    } catch (error) {
        console.error('Error saving roadmap:', error);
        showNotification('Failed to save roadmap. Please try again.', 'danger');
        
        // Reset button state
        const saveButton = event.target;
        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Roadmap';
        saveButton.disabled = false;
    }
}
</script>
{% endblock %}
