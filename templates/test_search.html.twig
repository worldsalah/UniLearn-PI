<!DOCTYPE html>
<html>
<head>
    <title>Test Search Autocomplete</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .autocomplete-container {
            position: relative;
            width: 300px;
            margin: 50px auto;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }

        .autocomplete-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .autocomplete-description {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }

        .autocomplete-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            margin-top: 4px;
        }

        .autocomplete-level {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .autocomplete-price {
            color: #28a745;
            font-weight: 600;
        }

        .autocomplete-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 12px;
            color: #666;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        mark {
            background-color: #fff3cd;
            color: #856404;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Test Search Autocomplete</h2>
        
        <div class="autocomplete-container">
            <input 
                class="form-control" 
                type="search" 
                name="search" 
                placeholder="Search courses..." 
                aria-label="Search courses"
                autocomplete="off"
                id="courseSearchInput"
            >
            <div class="autocomplete-suggestions" id="suggestionsContainer"></div>
        </div>

        <div id="debugInfo" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('courseSearchInput');
        const suggestionsContainer = document.getElementById('suggestionsContainer');
        const debugInfo = document.getElementById('debugInfo');
        let debounceTimer;
        let currentSuggestions = [];
        let selectedIndex = -1;

        debugInfo.innerHTML = '‚úÖ JavaScript loaded successfully';

        if (!searchInput) {
            debugInfo.innerHTML += '<br>‚ùå Search input not found';
            return;
        }
        if (!suggestionsContainer) {
            debugInfo.innerHTML += '<br>‚ùå Suggestions container not found';
            return;
        }

        debugInfo.innerHTML += '<br>‚úÖ All elements found';

        // Event listeners
        searchInput.addEventListener('input', function(e) {
            debugInfo.innerHTML = `üìù Input event: "${e.target.value}"`;
            handleInput(e);
        });
        
        searchInput.addEventListener('focus', () => {
            debugInfo.innerHTML = 'üéØ Focus event';
            showSuggestions();
        });
        
        searchInput.addEventListener('blur', () => {
            debugInfo.innerHTML = 'üëÅÔ∏è Blur event';
            setTimeout(hideSuggestions, 200);
        });

        function handleInput(e) {
            const query = e.target.value.trim();
            debugInfo.innerHTML = `üîç Searching for: "${query}"`;
            
            // Clear previous timer
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            
            if (query.length < 2) {
                debugInfo.innerHTML = '‚ö†Ô∏è Query too short (need 2+ characters)';
                hideSuggestions();
                return;
            }
            
            // Debounce the search
            debounceTimer = setTimeout(() => {
                debugInfo.innerHTML = `‚è≥ Making API call for: "${query}"`;
                fetchSuggestions(query);
            }, 300);
        }

        async function fetchSuggestions(query) {
            try {
                showLoading();
                
                const url = `/api/autocomplete/courses?q=${encodeURIComponent(query)}&limit=5`;
                debugInfo.innerHTML = `üåê Fetching: ${url}`;
                
                const response = await fetch(url);
                debugInfo.innerHTML += `<br>üì° Response status: ${response.status}`;
                
                const data = await response.json();
                debugInfo.innerHTML += `<br>üìÑ Response data: ${JSON.stringify(data, null, 2)}`;
                
                if (data.success) {
                    currentSuggestions = data.suggestions;
                    displaySuggestions();
                } else {
                    debugInfo.innerHTML += '<br>‚ùå API returned success: false';
                    hideSuggestions();
                }
            } catch (error) {
                debugInfo.innerHTML += `<br>üí• Error: ${error.message}`;
                console.error('Autocomplete error:', error);
                hideSuggestions();
            }
        }

        function displaySuggestions() {
            debugInfo.innerHTML += `<br>üìã Displaying ${currentSuggestions.length} suggestions`;
            
            if (currentSuggestions.length === 0) {
                suggestionsContainer.innerHTML = '<div class="autocomplete-item">No courses found</div>';
                showSuggestions();
                return;
            }
            
            const html = currentSuggestions.map((suggestion, index) => `
                <div class="autocomplete-item" 
                     data-index="${index}" onclick="selectSuggestion(${index})">
                    <div class="autocomplete-title">${suggestion.title}</div>
                    <div class="autocomplete-description">${suggestion.description || ''}</div>
                    <div class="autocomplete-meta">
                        <span class="autocomplete-level">${suggestion.level || 'All levels'}</span>
                        <span class="autocomplete-price">$${suggestion.price || '0'}</span>
                    </div>
                </div>
            `).join('');
            
            suggestionsContainer.innerHTML = html;
            showSuggestions();
        }

        function showLoading() {
            suggestionsContainer.innerHTML = `
                <div class="autocomplete-loading">
                    <div class="spinner"></div>
                    <span>Searching...</span>
                </div>
            `;
            showSuggestions();
        }

        function selectSuggestion(index) {
            const suggestion = currentSuggestions[index];
            if (suggestion) {
                debugInfo.innerHTML = `‚úÖ Selected: ${suggestion.title}`;
                searchInput.value = suggestion.title;
                hideSuggestions();
                alert(`Would navigate to: ${suggestion.title}`);
            }
        }

        function showSuggestions() {
            suggestionsContainer.style.display = 'block';
        }

        function hideSuggestions() {
            suggestionsContainer.style.display = 'none';
            selectedIndex = -1;
        }

        // Make selectSuggestion globally available
        window.selectSuggestion = selectSuggestion;
    });
    </script>
</body>
</html>
